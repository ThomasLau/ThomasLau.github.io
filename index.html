<!doctype html>




<html class="theme-next mist" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />





  <link rel="alternate" href="/atom.xml" title="e+Thomas" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon32.ico?v=5.1.1" />






<meta property="og:type" content="website">
<meta property="og:title" content="e+Thomas">
<meta property="og:url" content="http://thomaslau.github.io/index.html">
<meta property="og:site_name" content="e+Thomas">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="e+Thomas">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"hide","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: false,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://thomaslau.github.io/"/>





  <title>e+Thomas</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?22bda74eb54c0d90672fd5c06458004c";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>










</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">e+Thomas</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://thomaslau.github.io/2018/03/28/2018-03-28-weekly_reading/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Thomas Lau">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/myLogo.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="e+Thomas">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/03/28/2018-03-28-weekly_reading/" itemprop="url">Weekly Reading 180328</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-28T00:09:07+08:00">
                2018-03-28
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>下面是之前2-3个月积攒的文摘，清空一下，所以有些看起来可能是不够“新鲜”了。</p>
<p>1, Dubbo源代码分析九：优雅停机<br><a href="http://manzhizhen.iteye.com/blog/2404220" target="_blank" rel="external">http://manzhizhen.iteye.com/blog/2404220</a><br>这几天从dubbo-admin有机会看了一点dubbo代码，对上述shutdown方式，有了点体会。<br>可以说2.5.3版本 dubbo和dubbo-admin交互还是有多处bug的，比如可以对比 com.alibaba.dubbo.registry.integration.RegistryProtocol在2.5.3和2.5.8版本的实现（doChangeLocalExport/notify方法）。</p>
<p>2, JMX最佳实践与详解<br><a href="http://shift-alt-ctrl.iteye.com/blog/2404103" target="_blank" rel="external">http://shift-alt-ctrl.iteye.com/blog/2404103</a> 文中这里列举下Java已经内置的多个MXBean实现。</p>
<pre><code>1、BufferPoolMXBean：
   有关“direct”、“mapped” buffer的资源信息；如果Application为网络IO系统（比如Netty编程）、或者有大量文件操作，你应该考虑关注此MXBean。
2、ClassLoadingMXBean：
   有关JVM类加载相关的资源信息；如果Application为序列化相关的组件、脚本化集成组件、有较多代理类（包括动态加载，OSGI）等，你应该关注此MXBean。
3、GarbageCollectorMXBean：
   有关JVM GC相关的资源，包括GC时长、GC次数和相关内存状态。
4、MemoryPoolMXBean：
   有关JVM中“内存池”的相关资源信息，可以配合MemoryManagerMXBean一起使用。一个Application中可能有多个“内存池”实例，我们可以通过MemoryManagerMXBean获取内存池的列表，并查看此内存池的存量和GC相关信息。
5、OperatingSystemMXBean：
   有关操作系统的相关资源信息，比如CPU负载等。
6、PlatformManagedObject：
   内部接口，所有的JAVA平台有关的MXBean都扩展此接口，比如上述几个MXBean；通常应用程序不应该实现它。
7、RuntimeMXBean：
   有关runtime的信息，比如VM的参数、版本等。
8、ThreadMXBean：
   有关运行时线程状态的资源信息，比如“CPU高耗线程”、“死锁线程”等，可以帮助我们优化并发操作等。
</code></pre><p>实际很少用到MXBean来做一些metric/hanck技术，像Kafka也内置了一些MXBean，作为系统运行状态的参考，业界也有一些工具可以将这些MXBean打点至如grafana上展示。</p>
<p>3，根据项目生成requirements.txt</p>
<pre><code>python项目中必须包含一个 requirements.txt 文件，用于记录所有依赖包及其精确的版本号。以便新环境部署。
在虚拟环境中使用pip生成：
(venv) $ pip freeze &gt;requirements.txt
这种方式配合virtualenv 才好使，否则把整个环境中的包都列出来了。
使用 pipreqs
这个工具的好处是可以通过对项目目录的扫描，自动发现使用了那些类库，自动生成依赖清单。
缺点是可能会有些偏差，需要检查并自己调整下。
# pip install pipreqs
# 使用方式也比较简单
pipreqs ./
</code></pre><p>4，暴力美学，“星星之火可以燎原”<br>记得，有诗人吟送道，大概类似，“我在春天种下希望的种子，秋天收获希望“的句子，或者类似句子。<br>但是，太祖的“星星之火可以燎原”，只是八个字，显然更有境界。</p>
<p>5， Latency Sensitive Microservices<br><a href="https://www.infoq.com/presentations/microservices-trading-system" target="_blank" rel="external">https://www.infoq.com/presentations/microservices-trading-system</a></p>
<p>6, 分布式数据库中间件TDDL、Amoeba、Cobar、MyCAT架构比较。文章简洁明了<br><a href="https://www.jianshu.com/p/ed54162d720c" target="_blank" rel="external">https://www.jianshu.com/p/ed54162d720c</a></p>
<p>7，Significant Software Development Developments of 2017<br>需要自备梯子。2017年几个重大软件研发事件备忘录，想不到去年发生这么多大事<br><a href="http://marxsoftware.blogspot.com/2017/12/big-news-2017.html" target="_blank" rel="external">http://marxsoftware.blogspot.com/2017/12/big-news-2017.html</a></p>
<p>8,踩坑无数，<a href="https://tech.meituan.com/%E6%95%B0%E6%8D%AE%E5%BA%93%E9%AB%98%E5%8F%AF%E7%94%A8%E6%9E%B6%E6%9E%84%E7%9A%84%E6%BC%94%E8%BF%9B%E4%B8%8E%E8%AE%BE%E6%83%B3.html" target="_blank" rel="external">美团点评高可用数据库架构演进</a>，好文。<br><a href="https://tech.meituan.com/数据库高可用架构的演进与设想.html" target="_blank" rel="external">https://tech.meituan.com/数据库高可用架构的演进与设想.html</a><br>MMM（Master-Master replication manager for MySQL）-&gt; MHA（MySQL Master High Availability）-&gt; MHA+Zebra (DAL)</p>
<p>9, 如何设计一个DNS<br><a href="http://www.infoq.com/cn/articles/how-to-design-dns" target="_blank" rel="external">http://www.infoq.com/cn/articles/how-to-design-dns</a></p>
<p>10，2017双11核心技术揭秘—阿里数据库进入全网秒级实时监控时代 | 阿里中间件团队博客<br><a href="http://jm.taobao.org/2017/12/27/20172703/" target="_blank" rel="external">http://jm.taobao.org/2017/12/27/20172703/</a></p>
<p>11，Linux IO磁盘篇整理小记 - 朱小厮的博客 - CSDN博客<br>一篇磁盘性能简单分析的文章，可以收藏以备查询<br><a href="http://blog.csdn.net/u013256816/article/details/78945085" target="_blank" rel="external">http://blog.csdn.net/u013256816/article/details/78945085</a></p>
<p>12，Peter Norvig，大牛<br><a href="http://norvig.com/" target="_blank" rel="external">http://norvig.com/</a></p>
<p>13， Docker 公司已死 ！ | IT瘾<br><a href="http://itindex.net/detail/57847-docker-%E5%85%AC%E5%8F%B8" target="_blank" rel="external">http://itindex.net/detail/57847-docker-%E5%85%AC%E5%8F%B8</a><br>mac安装kubernetes并运行echoserver - 简书<br><a href="https://www.jianshu.com/p/a42eeb66a19c" target="_blank" rel="external">https://www.jianshu.com/p/a42eeb66a19c</a><br>很早之前看的，好像后来有文章反对，不过值得参考下。</p>
<p>14, uber 技术总结<br><a href="https://eng.uber.com/2017-highlights/" target="_blank" rel="external">https://eng.uber.com/2017-highlights/</a><br><a href="https://eng.uber.com/2017-open-source/" target="_blank" rel="external">https://eng.uber.com/2017-open-source/</a></p>
<p>15， Kafka#3：分布式设计 - 程序园<br><a href="http://www.voidcn.com/article/p-risahvbp-ez.html" target="_blank" rel="external">http://www.voidcn.com/article/p-risahvbp-ez.html</a></p>
<p>16，百亿访问量的监控平台如何炼成？ – 运维派<br><a href="http://www.yunweipai.com/archives/24462.html" target="_blank" rel="external">http://www.yunweipai.com/archives/24462.html</a></p>
<p>17，美团点评联盟广告场景化定向排序机制<br><a href="https://tech.meituan.com/targeting_agentscore.html" target="_blank" rel="external">https://tech.meituan.com/targeting_agentscore.html</a></p>
<p>18，加密数字货币和传统分布式系统共识机制 | 温国兵的随想录<br><a href="https://dbarobin.com/2017/12/27/blockchain-consensus/" target="_blank" rel="external">https://dbarobin.com/2017/12/27/blockchain-consensus/</a></p>
<p>19，Kafka 高性能吞吐揭秘 - 友盟博客 - SegmentFault<br><a href="https://segmentfault.com/a/1190000003985468" target="_blank" rel="external">https://segmentfault.com/a/1190000003985468</a><br>关于Kafka日志留存策略的讨论 - huxihx - 博客园<br><a href="http://www.cnblogs.com/huxi2b/p/8042099.html" target="_blank" rel="external">http://www.cnblogs.com/huxi2b/p/8042099.html</a></p>
<p>20 JVMTI 参考<br><a href="http://blog.caoxudong.info/blog/2017/12/07/jvmti_reference" target="_blank" rel="external">http://blog.caoxudong.info/blog/2017/12/07/jvmti_reference</a></p>
<p>21,<br>如果你使用kafka new-consumer API 即：__consumer_offset存储你的消费信息，当</p>
<p>kafka-client设置props.put(“auto.commit.interval.ms”, “3000”) </p>
<p>则，对于server端，不论client是否消费新的数据，都是每6秒提交offset，server都写入consumeroffset，server不会做去重判断的，也就是每个三秒都会提交offset到__consumer_offset这个topic存储数据</p>
<p>22，Intel meltdown &amp; spectre的几篇文章以及对spark/elasticsearch的影响，好消息。<br><a href="http://www.infoq.com/cn/news/2018/01/meltdown-spectre" target="_blank" rel="external">http://www.infoq.com/cn/news/2018/01/meltdown-spectre</a><br><a href="https://databricks.com/blog/2018/01/13/meltdown-and-spectre-performance-impact-on-big-data-workloads-in-the-cloud.html" target="_blank" rel="external">https://databricks.com/blog/2018/01/13/meltdown-and-spectre-performance-impact-on-big-data-workloads-in-the-cloud.html</a><br><a href="https://www.elastic.co/blog/performance-impact-of-meltdown-on-elasticsearch" target="_blank" rel="external">https://www.elastic.co/blog/performance-impact-of-meltdown-on-elasticsearch</a></p>
<p>23，新晋Java Champions，包括一位JVM（SUN/OpenJDK）专家，曾在infoq 网站/现场 听过，网站上视频，很值得一听。<br><a href="https://www.infoq.com/news/2018/01/JavaChampions2017" target="_blank" rel="external">https://www.infoq.com/news/2018/01/JavaChampions2017</a></p>
<p>24，简介听起来不错<br>经历400多天打磨，HSF的架构和性能有哪些新突破？<br><a href="http://jm.taobao.org/2018/01/16/post180116/" target="_blank" rel="external">http://jm.taobao.org/2018/01/16/post180116/</a></p>
<p>25，JSON-B和Yasson详解，新的JAVA EE API官方规范，以及Eclipse的实现 Yasson<br><a href="http://blog.csdn.net/chszs/article/details/79059116" target="_blank" rel="external">http://blog.csdn.net/chszs/article/details/79059116</a><br>转眼间，似乎已经定下来改名叫 Jakarta EE了</p>
<p>26，ElasticSearch如何支持深度分页<br><a href="http://arganzheng.life/deep-pagination-in-elasticsearch.html" target="_blank" rel="external">http://arganzheng.life/deep-pagination-in-elasticsearch.html</a></p>
<p>学习了，对于超过默认10000条的除了使用ES的 Scan and scroll API之外，文章还提供了官方的 Search After 机制，不过要在ES 5.0版本后。</p>
<pre><code>search_after使用方式上跟scroll很像，但是相对于scroll它是无状态的(stateless)，没有search context开销；
而且它是每次请求都实时计算的，所以也没有一致性问题（相反，有索引变化的话，每次排序顺序会变化呢）。
但是比起from+size方式，还是有同样的问题没法解决：就是只能顺序的翻页，不能随意跳页
</code></pre><p>27，Elasticsearch Performance Tuning Practice at eBay<br><a href="https://www.ebayinc.com/stories/blogs/tech/elasticsearch-performance-tuning-practice-at-ebay/" target="_blank" rel="external">https://www.ebayinc.com/stories/blogs/tech/elasticsearch-performance-tuning-practice-at-ebay/</a><br>具体不列举了，infoq还有翻译的，这里简单总结下：</p>
<pre><code>From our experience, if the index is smaller than 1G, it’s fine to set the shard number to 1. For most scenarios, we can leave the shard number as the default value 5, but if shard size exceeds 30GB, we should increase the shard number to split the index into more shards. The shard number cannot be changed once an index is created, but we can create a new index and use the reindex API to move data.
Increase refresh interval. As we mentioned in the tune indexing performance section, Elasticsearch creates new segment every time a refresh happens. Increasing the refresh interval would help reduce the segment count and reduce the IO cost for search. And, the cache would be invalid once a refresh happens and data is changed. Increasing the refresh interval can make Elasticsearch utilize cache more efficiently.
Use filter context instead of query context if possible. A query clause is used to answer “How well does this document match this clause?” A filter clause is used to answer “Does this document match this clause?” Elasticsearch only needs to answer “Yes” or “No.” It does not need to calculate a relevancy score for a filter clause, and the filter results can be cached. See Query and filter context for details. 
Node query cache. Node query cache only caches queries that are being used in a filter context. Unlike a query clause, a filter clause is a &quot;Yes&quot; or &quot;No&quot; question. Elasticsearch used a bit set mechanism to cache filter results, so that later queries with the same filter will be accelerated. Note that only segments that hold more than 10,000 documents (or 3% of the total documents, whichever is larger) will enable a query cache. For more details, see All about caching.
We can use the following request to check whether a node query cache is having an effect.
GET index_name/_stats?filter_path=indices.**.query_cache
Sort by _doc if you don’t care about the order in which documents are returned
</code></pre><p>28，最近打算kafka官方提个建议：consumeroffset设置为30个。<br>kafka默认consumeroffset设置为50个partition，50=5<em>5</em>2，这对于部署kafka机器除非5的倍数，否则不会均匀分布的，而对于kafka的partition分配策略 hash(group_id)%50，可能效果也是不理想的。而30=2<em>3</em>5，可选择性就多点，但hash(group_id)%30还要具体数据验证。</p>
<p>29, Spring Boot 2.0 New Features: Infrastructure Changes<br><a href="https://springuni.com/spring-boot-2-infrastructure-changes/" target="_blank" rel="external">https://springuni.com/spring-boot-2-infrastructure-changes/</a><br>值得了解下</p>
<p>30,<br>“Go out there and have huge dreams, then show up to work the next morning and relentlessly incrementally achieve them.”<br>~ from the book, How Google Works</p>
<p>31，<br><a href="https://www.elastic.co/blog/categorizing-non-english-log-messages-in-machine-learning-for-elasticsearch" target="_blank" rel="external">https://www.elastic.co/blog/categorizing-non-english-log-messages-in-machine-learning-for-elasticsearch</a></p>
<p>32，有趣，我已经想象到教主九泉下有知，会不会来一句“意不意外惊不惊喜?”<br><a href="https://www.theverge.com/2018/2/16/17020246/apple-park-headquarters-employees-injury-glass-doors-design" target="_blank" rel="external">https://www.theverge.com/2018/2/16/17020246/apple-park-headquarters-employees-injury-glass-doors-design</a></p>
<p>33，值得参考下<br><a href="https://rcoh.me/posts/cache-oblivious-datastructures/" target="_blank" rel="external">https://rcoh.me/posts/cache-oblivious-datastructures/</a></p>
<p>34，基于日志trace的智能故障定位系统 - 百度搜索运维团队技术负责人<br><a href="http://www.infoq.com/cn/presentations/intelligent-fault-location-system-based-on-log-trace" target="_blank" rel="external">http://www.infoq.com/cn/presentations/intelligent-fault-location-system-based-on-log-trace</a></p>
<p>35，语言设计，值得参考<br><a href="https://www.iravid.com/posts/slick-and-shapeless.html" target="_blank" rel="external">https://www.iravid.com/posts/slick-and-shapeless.html</a></p>
<p>36， Java版WAF实现<br><a href="https://www.yangguo.info/2018/01/11/Gateway/" target="_blank" rel="external">https://www.yangguo.info/2018/01/11/Gateway/</a><br>API网关的开源解决方案那么多，为什么我们却还要选择自研？<br><a href="https://github.com/chengdedeng/waf" target="_blank" rel="external">https://github.com/chengdedeng/waf</a></p>
<ul>
<li><a href="https://www.yangguo.info/2017/11/13/HttpProxy研发心得/" target="_blank" rel="external">https://www.yangguo.info/2017/11/13/HttpProxy研发心得/</a></li>
<li><a href="https://www.yangguo.info/2017/06/06/Java版WAF实现/" target="_blank" rel="external">https://www.yangguo.info/2017/06/06/Java版WAF实现/</a></li>
</ul>
<p>37，<br><a href="http://blog.llvm.org/2018/03/clang-is-now-used-to-build-chrome-for.html" target="_blank" rel="external">http://blog.llvm.org/2018/03/clang-is-now-used-to-build-chrome-for.html</a></p>
<p>38，批判的看待，而不是听风就是雨<br><a href="http://www.flax.co.uk/blog/2018/03/02/no-elastic-x-pack-not-going-open-source-according-elastic/" target="_blank" rel="external">http://www.flax.co.uk/blog/2018/03/02/no-elastic-x-pack-not-going-open-source-according-elastic/</a></p>
<p>39，杂文：<br>美团外卖原生广告推荐实践<br><a href="http://www.infoq.com/cn/presentations/the-recommended-practice-of-meituan-takeout-ad" target="_blank" rel="external">http://www.infoq.com/cn/presentations/the-recommended-practice-of-meituan-takeout-ad</a><br>阿里巴巴监控之路<br><a href="http://www.infoq.com/cn/presentations/the-road-of-monitoring-in-alibaba" target="_blank" rel="external">http://www.infoq.com/cn/presentations/the-road-of-monitoring-in-alibaba</a><br>阿里异地多活与同城双活的架构演进<br><a href="http://www.infoq.com/cn/presentations/the-structure-of-alibaba-double-living-in-the-same-city" target="_blank" rel="external">http://www.infoq.com/cn/presentations/the-structure-of-alibaba-double-living-in-the-same-city</a></p>
<p>40， Steve Jobs: Everything in this world… was created by people no smarter than you.<br><a href="http://muratbuffalo.blogspot.com/2018/02/think-before-you-code.html" target="_blank" rel="external">http://muratbuffalo.blogspot.com/2018/02/think-before-you-code.html</a></p>
<p>41，<br><a href="https://fosdem.org/2018/schedule/event/unix_evolution/" target="_blank" rel="external">https://fosdem.org/2018/schedule/event/unix_evolution/</a></p>
<p>42，kibana几个有趣使用<br><a href="https://logz.io/blog/kibana-hacks/" target="_blank" rel="external">https://logz.io/blog/kibana-hacks/</a></p>
<p>43， 快速定位生产故障问题-JVM进程CPU占用率高于100%<br><a href="http://blog.csdn.net/flysqrlboy/article/details/79314521" target="_blank" rel="external">http://blog.csdn.net/flysqrlboy/article/details/79314521</a><br>实施要点：<br>top -Hbp ‘pid’ 定位问题线程<br>jstack ‘pid’ | grep ‘thread_id’ 找出问题代码</p>
<p>44，<a href="http://blog.codefx.org/java/application-class-data-sharing/" target="_blank" rel="external">http://blog.codefx.org/java/application-class-data-sharing/</a></p>
<p>45，<br><a href="http://colobu.com/2018/03/12/Concurrency-Utilities-Enhancements-in-Java-8-Java-9/" target="_blank" rel="external">http://colobu.com/2018/03/12/Concurrency-Utilities-Enhancements-in-Java-8-Java-9/</a></p>
<p>46，来自stackoverflow的调查<br><a href="https://insights.stackoverflow.com/survey/2018/" target="_blank" rel="external">https://insights.stackoverflow.com/survey/2018/</a></p>
<p>47，Kubernetes的抗脆弱性<br><a href="http://www.infoq.com/cn/articles/antifragility-in-kubernetes" target="_blank" rel="external">http://www.infoq.com/cn/articles/antifragility-in-kubernetes</a></p>
<p>48，Java10来了，来看看它一同发布的全新JIT编译器<br><a href="https://mp.weixin.qq.com/s/fNDBX6pxw2Xa5afZpVaBEg" target="_blank" rel="external">https://mp.weixin.qq.com/s/fNDBX6pxw2Xa5afZpVaBEg</a><br><em>与interpreter，GC等JVM的其他子系统相比，JIT compiler并不依赖于诸如直接内存访问的底层语言特性。它可以看成一个输入Java bytecode输出二进制码的黑盒，其实现方式取决于开发者对开发效率，可维护性等的要求。Graal是一个以Java为主要编程语言，面向Java bytecode的编译器。与用C++实现的C1及C2相比，它的模块化更加明显，也更加容易维护。Graal既可以作为动态编译器，在运行时编译热点方法；亦可以作为静态编译器，实现AOT编译。在Java 10中，Graal作为试验性JIT compiler一同发布（JEP 317）。这篇文章将介绍Graal在动态编译上的应用。有关静态编译，可查阅JEP 295或Substrate VM</em></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://thomaslau.github.io/2018/03/25/2018-03-25-pearls_of_Elasticsearch/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Thomas Lau">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/myLogo.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="e+Thomas">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/03/25/2018-03-25-pearls_of_Elasticsearch/" itemprop="url">Elasticsearch几点体会</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-25T15:12:07+08:00">
                2018-03-25
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>很久没有写博客了，感觉快要生疏，今天简单写一点，记录发现的几个问题。</p>
<p>1，<br><strong> 在集群增加一个节点后，不要只看是否启动成功，一定要验证下是否加入集群 </strong><br>考虑到32G内存的官方推荐，很多人会选择同一物理机部署两个以上节点（&gt;128G内存），分配两个端口。比如9300/19300.<br>比如集群在 10.135.30.12:9200/9300 是一个master节点，之后拷贝配置新增如下一个节点：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">cluster.name: elasts</div><div class="line">node.master: false</div><div class="line">node.data: true</div><div class="line">transport.tcp.port: 19300</div><div class="line">discovery.zen.ping.unicast.hosts: ["10.135.30.12"]</div></pre></td></tr></table></figure>
<p>会发现该节点启动成功，但是<strong><em>没有加入到elasts这个cluster里</em></strong>。 设置为debug级别再启动，不仔细看是发现不了问题的。</p>
<p>官方是这么解释：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Unicast discovery provides the following settings with the discovery.zen.ping.unicast.hosts:</div><div class="line">Either an array setting or a comma delimited setting. Each value should be <span class="keyword">in</span> the form of host:port or host (</div><div class="line"><span class="built_in">where</span> port defaults to the setting transport.profiles.default.port falling back to transport.tcp.port <span class="keyword">if</span> not <span class="built_in">set</span>). </div><div class="line">Note that IPv6 hosts must be bracketed. Defaults to 127.0.0.1, [::1]</div></pre></td></tr></table></figure>
<p>简单来讲就是上述节点默认使用配置里的 transport.tcp.port 这个端口做discover，而不是 9300.<br>所以建议配置 discovery.zen.ping.unicast.hosts 的时候一定配置端口（使用2.x之后的单播即可）</p>
<p>那么原文 “ort defaults to the setting transport.profiles.default.port falling back to transport.tcp.port if not set”是什么意思？<br>5.2.2代码为例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div></pre></td><td class="code"><pre><div class="line">UnicastZenPing.java</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UnicastZenPing</span> <span class="keyword">extends</span> <span class="title">AbstractComponent</span> <span class="keyword">implements</span> <span class="title">ZenPing</span> </span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ACTION_NAME = <span class="string">"internal:discovery/zen/unicast"</span>;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Setting&lt;List&lt;String&gt;&gt; DISCOVERY_ZEN_PING_UNICAST_HOSTS_SETTING =</div><div class="line">        Setting.listSetting(<span class="string">"discovery.zen.ping.unicast.hosts"</span>, emptyList(), Function.identity(),</div><div class="line">            Property.NodeScope);</div><div class="line">    ...</div><div class="line">        <span class="keyword">if</span> (DISCOVERY_ZEN_PING_UNICAST_HOSTS_SETTING.exists(settings)) &#123;</div><div class="line">            configuredHosts = DISCOVERY_ZEN_PING_UNICAST_HOSTS_SETTING.get(settings);</div><div class="line">            <span class="comment">// we only limit to 1 addresses, makes no sense to ping 100 ports</span></div><div class="line">            limitPortCounts = LIMIT_FOREIGN_PORTS_COUNT;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">// if unicast hosts are not specified, fill with simple defaults on the local machine</span></div><div class="line">            configuredHosts = transportService.getLocalAddresses();</div><div class="line">            limitPortCounts = LIMIT_LOCAL_PORTS_COUNT;</div><div class="line">        &#125;</div><div class="line">    ...</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;DiscoveryNode&gt; <span class="title">resolveHostsLists</span><span class="params">(</span></span></div><div class="line">        ...</div><div class="line">        <span class="keyword">final</span> List&lt;String&gt; hosts,</div><div class="line">        ...) <span class="keyword">throws</span> InterruptedException &#123;</div><div class="line">        ...</div><div class="line">        <span class="comment">// create tasks to submit to the executor service; we will wait up to resolveTimeout for these tasks to complete</span></div><div class="line">        <span class="keyword">final</span> List&lt;Callable&lt;TransportAddress[]&gt;&gt; callables =</div><div class="line">            hosts.stream()</div><div class="line">                .map(hn -&gt; (Callable&lt;TransportAddress[]&gt;) () -&gt; transportService.addressesFromString(hn, limitPortCounts))</div><div class="line">                .collect(Collectors.toList());</div><div class="line">        <span class="keyword">final</span> List&lt;Future&lt;TransportAddress[]&gt;&gt; futures =</div><div class="line">            executorService.invokeAll(callables, resolveTimeout.nanos(), TimeUnit.NANOSECONDS);</div><div class="line">        <span class="keyword">final</span> List&lt;DiscoveryNode&gt; discoveryNodes = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">        <span class="comment">// ExecutorService#invokeAll guarantees that the futures are returned in the iteration order of the tasks so we can associate the</span></div><div class="line">        <span class="comment">// hostname with the corresponding task by iterating together</span></div><div class="line">        <span class="keyword">final</span> Iterator&lt;String&gt; it = hosts.iterator();</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">final</span> Future&lt;TransportAddress[]&gt; future : futures) &#123;</div><div class="line">            <span class="keyword">final</span> String hostname = it.next();</div><div class="line">            <span class="keyword">if</span> (!future.isCancelled()) &#123;</div><div class="line">                <span class="keyword">assert</span> future.isDone();</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    <span class="keyword">final</span> TransportAddress[] addresses = future.get();</div><div class="line">                    logger.trace(<span class="string">"resolved host [&#123;&#125;] to &#123;&#125;"</span>, hostname, addresses);</div><div class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> addressId = <span class="number">0</span>; addressId &lt; addresses.length; addressId++) &#123;</div><div class="line">                        discoveryNodes.add(</div><div class="line">                            <span class="keyword">new</span> DiscoveryNode(</div><div class="line">                                nodeId_prefix + hostname + <span class="string">"_"</span> + addressId + <span class="string">"#"</span>,</div><div class="line">                                addresses[addressId],</div><div class="line">                                emptyMap(),</div><div class="line">                                emptySet(),</div><div class="line">                                Version.CURRENT.minimumCompatibilityVersion()));</div><div class="line">                    &#125;</div><div class="line">                &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> ExecutionException e) &#123;</div><div class="line">                    <span class="keyword">assert</span> e.getCause() != <span class="keyword">null</span>;</div><div class="line">                    <span class="keyword">final</span> String message = <span class="string">"failed to resolve host ["</span> + hostname + <span class="string">"]"</span>;</div><div class="line">                    logger.warn(message, e.getCause());</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                logger.warn(<span class="string">"timed out after [&#123;&#125;] resolving host [&#123;&#125;]"</span>, resolveTimeout, hostname);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> discoveryNodes;</div><div class="line">    &#125;</div><div class="line">...</div><div class="line"></div><div class="line">TransportService.java</div><div class="line">    <span class="keyword">public</span> TransportAddress[] addressesFromString(String address, <span class="keyword">int</span> perAddressLimit) <span class="keyword">throws</span> UnknownHostException &#123;</div><div class="line">        <span class="keyword">return</span> transport.addressesFromString(address, perAddressLimit);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">TcpTransport.java</div><div class="line">    <span class="keyword">public</span> TransportAddress[] addressesFromString(String address, <span class="keyword">int</span> perAddressLimit) <span class="keyword">throws</span> UnknownHostException &#123;</div><div class="line">        <span class="keyword">return</span> parse(address, settings.get(<span class="string">"transport.profiles.default.port"</span>, TransportSettings.PORT.get(settings)), perAddressLimit);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Pattern BRACKET_PATTERN = Pattern.compile(<span class="string">"^\\[(.*:.*)\\](?::([\\d\\-]*))?$"</span>);</div><div class="line">    <span class="comment">/** parse a hostname+port range spec into its equivalent addresses */</span></div><div class="line">    <span class="keyword">static</span> TransportAddress[] parse(String hostPortString, String defaultPortRange, <span class="keyword">int</span> perAddressLimit) <span class="keyword">throws</span> UnknownHostException &#123;</div><div class="line">        Objects.requireNonNull(hostPortString);</div><div class="line">        String host;</div><div class="line">        String portString = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (hostPortString.startsWith(<span class="string">"["</span>)) &#123;</div><div class="line">            <span class="comment">// Parse a bracketed host, typically an IPv6 literal.</span></div><div class="line">            Matcher matcher = BRACKET_PATTERN.matcher(hostPortString);</div><div class="line">            <span class="keyword">if</span> (!matcher.matches()) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Invalid bracketed host/port range: "</span> + hostPortString);</div><div class="line">            &#125;</div><div class="line">            host = matcher.group(<span class="number">1</span>);</div><div class="line">            portString = matcher.group(<span class="number">2</span>);  <span class="comment">// could be null</span></div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">int</span> colonPos = hostPortString.indexOf(<span class="string">':'</span>);</div><div class="line">            <span class="keyword">if</span> (colonPos &gt;= <span class="number">0</span> &amp;&amp; hostPortString.indexOf(<span class="string">':'</span>, colonPos + <span class="number">1</span>) == -<span class="number">1</span>) &#123;</div><div class="line">                <span class="comment">// Exactly 1 colon.  Split into host:port.</span></div><div class="line">                host = hostPortString.substring(<span class="number">0</span>, colonPos);</div><div class="line">                portString = hostPortString.substring(colonPos + <span class="number">1</span>);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="comment">// 0 or 2+ colons.  Bare hostname or IPv6 literal.</span></div><div class="line">                host = hostPortString;</div><div class="line">                <span class="comment">// 2+ colons and not bracketed: exception</span></div><div class="line">                <span class="keyword">if</span> (colonPos &gt;= <span class="number">0</span>) &#123;</div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"IPv6 addresses must be bracketed: "</span> + hostPortString);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// if port isn't specified, fill with the default</span></div><div class="line">        <span class="keyword">if</span> (portString == <span class="keyword">null</span> || portString.isEmpty()) &#123;</div><div class="line">            portString = defaultPortRange;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// generate address for each port in the range</span></div><div class="line">        Set&lt;InetAddress&gt; addresses = <span class="keyword">new</span> HashSet&lt;&gt;(Arrays.asList(InetAddress.getAllByName(host)));</div><div class="line">        List&lt;TransportAddress&gt; transportAddresses = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">        <span class="keyword">int</span>[] ports = <span class="keyword">new</span> PortsRange(portString).ports();</div><div class="line">        <span class="keyword">int</span> limit = Math.min(ports.length, perAddressLimit);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; limit; i++) &#123;</div><div class="line">            <span class="keyword">for</span> (InetAddress address : addresses) &#123;</div><div class="line">                transportAddresses.add(<span class="keyword">new</span> InetSocketTransportAddress(address, ports[i]));</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> transportAddresses.toArray(<span class="keyword">new</span> TransportAddress[transportAddresses.size()]);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">TransportSettings.java</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Setting&lt;String&gt; PORT =</div><div class="line">        <span class="keyword">new</span> Setting&lt;&gt;(<span class="string">"transport.tcp.port"</span>, <span class="string">"9300-9400"</span>, Function.identity(), Property.NodeScope);</div></pre></td></tr></table></figure>
<p>也可看到，es这块debug的日志有所欠缺，如果把UnicastZenPing这个操作时候的实际的端口log下来，方便快速定位问题。</p>
<p>2,<br><strong> ES索引性能的优化 </strong><br>之前文章已推荐<a href="https://www.paypal-engineering.com/2016/08/10/powering-transactions-search-with-elastic-learnings-from-the-field/" target="_blank" rel="external">Ebay一篇文章</a>总结过将Elasticsearch优化到极致的技巧，这里就不再重复，来看点不一样的：<br>不过，这里也不会讨论，诸如 优化索引的 index.refresh_interval，优化segment的index.merge，甚至磁盘的索引均衡（扩分片/reroute）/replia数减少。更不会讨论诸如索引字段的分词/exclude/_all字段禁用/优化_source字段等。</p>
<p>来看下面三个参数：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">index.translog.durability: async</div><div class="line">index.translog.sync_interval: 90s</div><div class="line">index.translog.flush_threshold_size: 1024mb</div></pre></td></tr></table></figure>
<p>主要是 index.translog.durability，看文档 <a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.2/index-modules-translog.html" target="_blank" rel="external">Translog</a></p>
<p> <strong><em>Translog settingsedit</em></strong><br>The data in the transaction log is only persisted to disk when the translog is fsynced and committed. In the event of hardware failure, any data written since the previous translog commit will be lost.</p>
<p>By default, Elasticsearch fsyncs and commits the translog every 5 seconds if index.translog.durability is set to async or if set to request (default) at the end of every index, delete, update, or bulk request. In fact, Elasticsearch will only report success of an index, delete, update, or bulk request to the client after the transaction log has been successfully fsynced and committed on the primary and on every allocated replica.</p>
<p>The following dynamically updatable per-index settings control the behaviour of the transaction log:</p>
<ul>
<li><strong> index.translog.sync_interval </strong><br>How often the translog is fsynced to disk and committed, regardless of write operations. Defaults to 5s. Values less than 100ms are not allowed.</li>
<li><strong> index.translog.durability </strong><br>Whether or not to fsync and commit the translog after every index, delete, update, or bulk request. This setting accepts the following parameters:<ul>
<li>request<br>(default) fsync and commit after every request. In the event of hardware failure, all acknowledged writes will already have been committed to disk.</li>
<li>async<br>fsync and commit in the background every sync_interval. In the event of hardware failure, all acknowledged writes since the last automatic commit will be discarded.</li>
</ul>
</li>
</ul>
<p>即，为了保证数据不丢失，es translog默认的额持久化策略是 每次请求都会flush。这里暂不代码展开分析，如果应用允许少量的几率丢失数据，那么这里可以设置为异步，并且增加translog大小周期性的flush。</p>
<p>需要注意的是，index.translog.durability 并不是一个dynamic property，即，如果修改索引的该配置，可以删除重建，不过也可以先close该索引，更新setting后再open打开索引。</p>
<p>对于大量请求（每天索引数据量10+亿条，每日索引数据500+GB，1备份，保留5天数据，32CPU，128g内存，机械硬盘，四台实体机），上面的配置优化还是很明显的。</p>
<p>3，<br><strong> 这里简单列个5.x相比2.x的改变 </strong>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">curl -XPOST &apos;localhost:9200/_cluster/reroute&apos; -d &apos;&#123; </div><div class="line">  &quot;commands&quot; : [ </div><div class="line">      &#123; &quot;allocate_empty_primary&quot; : </div><div class="line">          &#123; &quot;index&quot; : &quot;INDEX&quot;, &quot;shard&quot; : 0, &quot;node&quot;: &quot;&lt;NODE_NAME&gt;&quot;&#125;</div><div class="line">      &#125;</div><div class="line">    ]</div><div class="line">&#125;&apos;</div><div class="line">curl -XPOST  localhost:9200/_cluster/reroute -d &apos;&#123;</div><div class="line">  &quot;commands&quot; : [ </div><div class="line">    &#123;</div><div class="line">        &quot;move&quot; :&#123;</div><div class="line">            &quot;index&quot; : &quot;za-2018.03.23&quot;, &quot;shard&quot; : 0, &quot;from_node&quot; : &quot;node-20.50&quot;, &quot;to_node&quot; : &quot;node-20.39&quot;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">  ]</div><div class="line">&#125;&apos;</div></pre></td></tr></table></figure>
<ul>
<li>上述node均可用名字代替，而不必查询id</li>
<li>reroute的commands，相比细化了下，如 allocate_empty_primary，这在集群状态为red，分片数据确实并且不可恢复的时候还是有用的。</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://thomaslau.github.io/2017/09/10/2017-09-10-weekly_reading/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Thomas Lau">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/myLogo.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="e+Thomas">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/09/10/2017-09-10-weekly_reading/" itemprop="url">Weekly Reading 170910</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-09-10T23:29:07+08:00">
                2017-09-10
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p>很久没有更新了，最近比较忙。<br>今天刚好是第33个教师节，怀念因吾逃课多次而气哭却依旧对我苦口婆心谆谆教诲到毕业的高二高三班主任。可惜花无重开日，人无再少年。当爱因斯坦霍金这些天才的头脑思考想象时间之箭逆向的时候，凡夫俗子只能哀叹滚滚长江东逝水，但将白发唱黄鸡？<br>所以，第一个链接附上：邓晓芒的<a href="http://mp.weixin.qq.com/s?timestamp=1505063081&amp;src=3&amp;ver=1&amp;signature=Kp1HJzKUfeq7wGa63hXCrde4tCeSDbO9Wdak7eBQqoGKE1BA*cI01Bjlx-Lsw9UNXfO8eyDCdX5iNjtKIjSizZijosJN*8kUz0weBrkuCygcRhN70SlFPgJDD6i5Z*X9rJdeH7xTToGslS7MIUfDpBKNiLgTLPhr2WTLWKwZOQ4=" target="_blank" rel="external">邓晓芒：我的恩师修斋先生</a><br>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2017/09/10/2017-09-10-weekly_reading/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://thomaslau.github.io/2017/08/26/2017-08-26-weekly_reading/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Thomas Lau">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/myLogo.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="e+Thomas">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/08/26/2017-08-26-weekly_reading/" itemprop="url">Weekly Reading 170825</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-26T10:29:07+08:00">
                2017-08-26
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <ol>
<li><a href="http://gao-xianglong.iteye.com/blog/2390697?from=thomaslau.github.io" target="_blank" rel="external">优雅停机</a><br>dubbo原生是支持优雅停机的，其实也就是采用JDK的ShudownHook来实现，当然仅限kill -15 PID。这里也顺带说一下dubbo优雅停机的原理，如下所示：<br>服务提供方<br>· 停止时，先标记为不接收新请求，新请求过来时直接报错，让客户端重试其它机器。<br>· 然后，检测线程池中的线程是否正在运行，如果有，等待所有线程执行完成，除非超时，则强制关闭。<br>服务消费方<br>· 停止时，不再发起新的调用请求，所有新的调用在客户端即报错。<br>· 然后，检测有没有请求的响应还没有返回，等待响应返回，除非超时，则强制关闭。
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2017/08/26/2017-08-26-weekly_reading/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://thomaslau.github.io/2017/08/20/2017-08-20-weekly_reading/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Thomas Lau">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/myLogo.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="e+Thomas">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/08/20/2017-08-20-weekly_reading/" itemprop="url">Weekly Reading 170820</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-20T21:59:07+08:00">
                2017-08-20
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <ol>
<li>阿里周洋分享了<a href="http://jm.taobao.org/2017/08/08/080802/?from=thomaslau.gigthub.io" target="_blank" rel="external">中间件技术峰会分享|双11高可用架构演进之路</a>, 介绍了阿里第四代技术架构，将其分为了，容量规划、限流降级、依赖治理、开关预案、故障演练、流量调度。<br>其实这是一系列，另外一篇<a href="http://jm.taobao.org/2017/08/09/20170809/?from=thomaslau.gigthub.io" target="_blank" rel="external">中间件技术峰会分享|阿里电商架构演变之路</a>，很简略的概括了阿里架构史，其实也是国内很多公司开发的架构史。里面将淘宝架构分为：<br><strong>淘宝从初创开始到今天，我们的技术架构总体上经历了四代：<br>第一代是基于LAMP的一套结构。第二代是基于Java的应用架构。第三代是基于分布式体系，构建出一整套的分布式架构。第四代是基于IDC，不但应用能够分布，整数数据中心也能够分布。</strong><br>这里也可以看出，前三代，阿里跟随国外技术圈。本人工作过几家大公司其实也是该思路。</li>
<li><p><a href="https://www.youtube.com/watch?v=OYpTn0nWKR4" target="_blank" rel="external">10,000 Java performance tips over 15 years - what did I learn</a><br>上面是油管链接，也可以去<a href="https://www.voxxed.com/2017/07/10000-java-performance-tips-15-years/" target="_blank" rel="external">voxxed 2017</a>, <a href="https://cfp.devoxx.co.uk/2017/talks/conf" target="_blank" rel="external">devoxx conf</a>上面一些基于JVM语言／优化等链接还是很值得看的。</p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2017/08/20/2017-08-20-weekly_reading/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://thomaslau.github.io/2017/08/14/2017-08-14-a_dive_into_Shannon_entropy/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Thomas Lau">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/myLogo.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="e+Thomas">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/08/14/2017-08-14-a_dive_into_Shannon_entropy/" itemprop="url">信息熵的理解</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-14T21:59:07+08:00">
                2017-08-14
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <pre><code>记录一下看书收获。
</code></pre><h1 id="1-什么是熵"><a href="#1-什么是熵" class="headerlink" title="1. 什么是熵"></a>1. 什么是熵</h1><p>让我们先看一下维基百科对玻尔兹曼熵的来源描述和定义：</p>
<pre><code>熵（Entropy），是一种测量在动力学方面不能做功的能量总数，熵的量度正是能量退化的指标。
熵亦被用于计算一个系统中的失序现象，也就是计算该系统混乱的程度。
1877年，玻尔兹曼发现单一系统中的熵跟构成热力学性质的微观状态数量相关。玻尔兹曼并假设：
S=k*lnΩ
公式中的k是玻尔兹曼常数，Ω则为该宏观状态中所包含之微观状态数量。这个被称为玻尔兹曼原理的假定是统计力学的基础。
统计力学则以构成部分的统计行为来描述热力学系统.
</code></pre><p>这就是玻尔兹曼的Entropy的来源了，而当普朗克来中国讲学时用到entropy这个词时，还没有对应名称，胡刚复教授偷懒地根据公式（dS=dQ/T），把“商”字加火旁来意译“entropy”这个字，创造了“熵”字（胡刚复与叶企孙同样是我国近代物理奠基人）。<br>不过上面是物理学衍生的玻尔兹曼熵，在1948年，克劳德·艾尔伍德·香农将热力学的熵引入到信息论，定义了信息熵的概念，因此它又被称为香农熵。</p>
<pre><code>在信息论中，熵是接收的每条消息中包含的信息的平均量，又被称为信息熵、信源熵、平均自信息量。
这里，“消息”代表来自分布或数据流中的事件、样本或特征。
</code></pre><p>这即是熵的定义了，这里隐含的想法是，比较不可能发生的事情，当它发生了，意味着更多的信息。<br>所以熵也可理解为不确定性的量度[Measure of Uncertainty]，即越随机的信源的熵越大。<br>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2017/08/14/2017-08-14-a_dive_into_Shannon_entropy/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://thomaslau.github.io/2017/08/04/2017-08-04-derivative-of-logistic-sigmoid-function/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Thomas Lau">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/myLogo.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="e+Thomas">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/08/04/2017-08-04-derivative-of-logistic-sigmoid-function/" itemprop="url">为什么 LR 模型要使用 sigmoid 函数</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-04T21:59:07+08:00">
                2017-08-04
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <pre><code>分享一下在学习逻辑回归时候的困惑，以便需要者节约时间。
</code></pre><p>在看西瓜书的逻辑回归这一章时，对作者引入了sigmoid函数觉得突兀，于是搜索到了知乎上的提问，<a href="https://www.zhihu.com/question/35322351" target="_blank" rel="external">为什么 LR 模型要使用 sigmoid 函数</a> 里获赞最高的答案。<br><strong>但正如马化腾先生说的，这么说，也对也不对。</strong><br>看完后，上面其他回答各种理由，而匿名回答是最大熵的，并不是原因，甚至，这可以认为是一个推论或公理。试想再问为什么要熵最大化？<br>换言之，一个分析问题是从前一步的因，一个分析问题是从最初的因。这对数学专业可能会直接跳过这么问。<br>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2017/08/04/2017-08-04-derivative-of-logistic-sigmoid-function/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://thomaslau.github.io/2017/07/31/2017-07-31-Blogs_2017_07_31/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Thomas Lau">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/myLogo.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="e+Thomas">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/07/31/2017-07-31-Blogs_2017_07_31/" itemprop="url">Blogs_20170731</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-31T21:01:07+08:00">
                2017-07-31
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h1 id="Blogs"><a href="#Blogs" class="headerlink" title="Blogs"></a>Blogs</h1><p>1, <a href="https://medium.com/the-mission/10-000-hours-with-claude-shannon-12-lessons-on-life-and-learning-from-a-genius-e8b9297bee8f" target="_blank" rel="external">10,000 Hours With Claude Shannon: How A Genius Thinks, Works, and Lives</a><br>上个世纪，尤其是前50年，伟大的天才很多，开拓的天才屈指可数，有些是大众皆知如爱因斯坦，图灵，而知道香农就没有那么多。作者总结了香农许多习惯，试图解密为何香农会有那么多的时间创造，或者思考。<br>2，<a href="http://www.makers.com/margaret-hamilton" target="_blank" rel="external">Makers专访Margaret Hamilton, NASA’s First Software Engineer</a></p>
<pre><code>Meet Margaret H. Hamilton, the woman who led man to the moon. 
On July 20th, 1969, minutes before Apollo 11&apos;s scheduled touch-down, 
there was a computer error that would have changed history had it not been 
for Margaret&apos;s programming that overrode the glitch and ultimately made 
&quot;one small step for man, and a giant leap for mankind&quot; a reality.
</code></pre>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2017/07/31/2017-07-31-Blogs_2017_07_31/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://thomaslau.github.io/2017/07/25/2017-07-25-from_noInflation_to_Java_Method_invoke/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Thomas Lau">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/myLogo.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="e+Thomas">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/07/25/2017-07-25-from_noInflation_to_Java_Method_invoke/" itemprop="url">从noInflation看Java Method.invoke</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-25T21:01:07+08:00">
                2017-07-25
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p>旧文，现重新整理下：</p>
<h1 id="1-缘起"><a href="#1-缘起" class="headerlink" title="1. 缘起"></a>1. 缘起</h1><p>最近有同事发来如下一段异常，程序已开始运行正常，只是很快就会莫名其妙的抛这个异常，不知道如何着手解决:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">Exception <span class="keyword">in</span> thread <span class="string">"main"</span> java.lang.NoClassDefFoundError: sun/reflect/ConstructorAccessorImpl</div><div class="line">    at sun.misc.Unsafe.defineClass(Native Method)</div><div class="line">    at sun.reflect.ClassDefiner.defineClass(ClassDefiner.java:63)</div><div class="line">    at sun.reflect.MethodAccessorGenerator<span class="variable">$1</span>.run(MethodAccessorGenerator.java:399)</div><div class="line">    at sun.reflect.MethodAccessorGenerator<span class="variable">$1</span>.run(MethodAccessorGenerator.java:394)</div><div class="line">    at java.security.AccessController.doPrivileged(Native Method)</div><div class="line">    at sun.reflect.MethodAccessorGenerator.generate(MethodAccessorGenerator.java:393)</div><div class="line">    at sun.reflect.MethodAccessorGenerator.generateConstructor(MethodAccessorGenerator.java:92)</div><div class="line">    at sun.reflect.NativeConstructorAccessorImpl.newInstance(NativeConstructorAccessorImpl.java:55)</div><div class="line">    at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45)</div><div class="line">    at java.lang.reflect.Constructor.newInstance(Constructor.java:423)</div><div class="line">    at java.lang.Class.newInstance(Class.java:442)</div><div class="line">    at com.thomas.classloader.unload.MonitorHotSwap.main(MonitorHotSwap.java:34)</div><div class="line">Caused by: java.lang.ClassNotFoundException: sun.reflect.ConstructorAccessorImpl</div><div class="line">    at java.net.URLClassLoader.findClass(URLClassLoader.java:381)</div><div class="line">    ...</div></pre></td></tr></table></figure></p>
<p>我把他的代码稍作简化，主要部分是类似下面的逻辑，功能是程序监控某几个文件的变动，发现符合条件就会编译并会重新加载class，<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HotSwapURLClassLoader</span> <span class="keyword">extends</span> <span class="title">URLClassLoader</span> </span>&#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> Class&lt;?&gt; loadClass(String name, <span class="keyword">boolean</span> resolve) <span class="keyword">throws</span> ClassNotFoundException &#123;</div><div class="line">        Class&lt;?&gt; clazz = <span class="keyword">null</span>;</div><div class="line">        clazz = findLoadedClass(name);</div><div class="line">        <span class="keyword">if</span> (clazz != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="comment">//...一段热替换逻辑</span></div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (name.startsWith(<span class="string">"java."</span>)) &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                ClassLoader system = ClassLoader.getSystemClassLoader();</div><div class="line">                clazz = system.loadClass(name);</div><div class="line">                <span class="keyword">if</span> (clazz != <span class="keyword">null</span>) &#123;</div><div class="line">                    <span class="keyword">if</span> (resolve)</div><div class="line">                        resolveClass(clazz);</div><div class="line">                    <span class="keyword">return</span> (clazz);</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</div><div class="line">                <span class="comment">// Ignore</span></div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> customLoad(name, <span class="keyword">this</span>);</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">&#125;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">X</span> </span>&#123;</div><div class="line">    ...</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">hot</span><span class="params">(String msg)</span> </span>&#123;</div><div class="line">        <span class="comment">//System.out.println(String.format("ver:%s, classLoader: %s.", ver, this.getClass().getClassLoader()));</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>上面的异常，不同于常遇到的异常，我们根据异常栈逆推可能不会很容易的定位到root cause。所以我在hot方法加了一条日志信息，即注释打开，运行多次，发现每次都是<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">ver:15, classLoader: com.thomas.unload.HotSwapURLClassLoader@4e25154f.</div><div class="line">Exception <span class="keyword">in</span> thread <span class="string">"main"</span> java.lang.NoClassDefFoundError: sun/reflect/ConstructorAccessorImpl</div></pre></td></tr></table></figure></p>
<p>这让我想起了JVM参数有inflationThreshold=15<br>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2017/07/25/2017-07-25-from_noInflation_to_Java_Method_invoke/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://thomaslau.github.io/2017/06/19/2017-06-19-from_Monte_Carlo_to_pySpark_fork_Bug/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Thomas Lau">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/myLogo.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="e+Thomas">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/06/19/2017-06-19-from_Monte_Carlo_to_pySpark_fork_Bug/" itemprop="url">从Monte Carlo谈pySpark的fork引发的Bug</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-19T11:01:07+08:00">
                2017-06-19
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p>这是一篇老文章，记录了发现PySpark一个bug的过程，现重新整理下：</p>
<p>截止2016-05-19已发布最新Spark版本，如果你在使用pySpark，并且也用 import random的方式生成随机数,就可能会遇到下面的问题：</p>
<p>刚学Spark，故先看一段Monte Carlo method 求Pi的代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> random <span class="keyword">import</span> random</div><div class="line"><span class="keyword">from</span> operator <span class="keyword">import</span> add</div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">funcx</span><span class="params">(x)</span>:</span></div><div class="line">  <span class="comment"># print x[0],x[1]</span></div><div class="line">  <span class="keyword">return</span> <span class="number">1</span> <span class="keyword">if</span> x[<span class="number">0</span>]**<span class="number">2</span> + x[<span class="number">1</span>]**<span class="number">2</span> &lt; <span class="number">1</span> <span class="keyword">else</span> <span class="number">0</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">genRnd</span><span class="params">(ind)</span>:</span></div><div class="line">  x=random() * <span class="number">2</span> - <span class="number">1</span></div><div class="line">  y=random() * <span class="number">2</span> - <span class="number">1</span></div><div class="line">  <span class="keyword">return</span> (x,y)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">runsp</span><span class="params">(total)</span>:</span></div><div class="line">  ret=sc.parallelize(xrange(total),<span class="number">1</span>).map(genRnd).map(funcx).reduce(<span class="keyword">lambda</span> x, y: x + y)/float(total) * <span class="number">4</span></div><div class="line">  <span class="keyword">print</span> ret</div><div class="line"></div><div class="line">runsp(<span class="number">3</span>)</div></pre></td></tr></table></figure>
<p>spark-shell方式运行上述代码，多次运行runsp(n), 会发现几点有趣现象：</p>
<p>1, 按理说, n越大，虽不是越能逼近pi，但是逼近pi的概率应该是越大的。然而发现似乎并不如此，起初以为是python生成伪随机算法导致，还好通过下面一个现象发现问题。但是伪随机算法在多大程度上干扰了Monte Carlo求值？这个后面会写一篇从数学上分析下。<br>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2017/06/19/2017-06-19-from_Monte_Carlo_to_pySpark_fork_Bug/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/myLogo.png"
               alt="Thomas Lau" />
          <p class="site-author-name" itemprop="name">Thomas Lau</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">24</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              
                <span class="site-state-item-count">23</span>
                <span class="site-state-item-name">标签</span>
              
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/ThomasLau" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://twitter.com/liuyongzhi0218" target="_blank" title="Twitter">
                  
                    <i class="fa fa-fw fa-twitter"></i>
                  
                  Twitter
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Thomas Lau</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  

  
    <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  




	





  





  





  






  





  

  

  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


  

  

</body>
</html>
