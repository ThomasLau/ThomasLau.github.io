<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>从noInflation看Java Method.invoke | 编程之海</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="旧文，现重新整理下： 1. 缘起最近有同事发来如下一段异常，程序已开始运行正常，只是很快就会莫名其妙的抛这个异常，不知道如何着手解决: 12345678910111213141516Exception in thread &quot;main&quot; java.lang.NoClassDefFoundError: sun&#x2F;reflect&#x2F;ConstructorAccessorImpl    a">
<meta property="og:type" content="article">
<meta property="og:title" content="从noInflation看Java Method.invoke">
<meta property="og:url" content="http://thomaslau.github.io/2017/07/25/2017-07-25-from_noInflation_to_Java_Method_invoke/index.html">
<meta property="og:site_name" content="编程之海">
<meta property="og:description" content="旧文，现重新整理下： 1. 缘起最近有同事发来如下一段异常，程序已开始运行正常，只是很快就会莫名其妙的抛这个异常，不知道如何着手解决: 12345678910111213141516Exception in thread &quot;main&quot; java.lang.NoClassDefFoundError: sun&#x2F;reflect&#x2F;ConstructorAccessorImpl    a">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://thomaslau.github.io/images/flamegraph.png">
<meta property="og:image" content="http://thomaslau.github.io/images/flamegraph_native.png">
<meta property="article:published_time" content="2017-07-25T13:01:07.000Z">
<meta property="article:modified_time" content="2017-07-28T13:31:33.000Z">
<meta property="article:author" content="Thomas Lau">
<meta property="article:tag" content="JVM">
<meta property="article:tag" content="Java">
<meta property="article:tag" content="JAVA Flame Graph">
<meta property="article:tag" content="JMH">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://thomaslau.github.io/images/flamegraph.png">
  
    <link rel="alternate" href="/atom.xml" title="编程之海" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fork-awesome@1.2.0/css/fork-awesome.min.css">

<meta name="generator" content="Hexo 7.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">编程之海</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://thomaslau.github.io"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-2017-07-25-from_noInflation_to_Java_Method_invoke" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2017/07/25/2017-07-25-from_noInflation_to_Java_Method_invoke/" class="article-date">
  <time class="dt-published" datetime="2017-07-25T13:01:07.000Z" itemprop="datePublished">2017-07-25</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      从noInflation看Java Method.invoke
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>旧文，现重新整理下：</p>
<h1 id="1-缘起"><a href="#1-缘起" class="headerlink" title="1. 缘起"></a>1. 缘起</h1><p>最近有同事发来如下一段异常，程序已开始运行正常，只是很快就会莫名其妙的抛这个异常，不知道如何着手解决:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Exception <span class="keyword">in</span> thread <span class="string">&quot;main&quot;</span> java.lang.NoClassDefFoundError: sun/reflect/ConstructorAccessorImpl</span><br><span class="line">    at sun.misc.Unsafe.defineClass(Native Method)</span><br><span class="line">    at sun.reflect.ClassDefiner.defineClass(ClassDefiner.java:63)</span><br><span class="line">    at sun.reflect.MethodAccessorGenerator<span class="variable">$1</span>.run(MethodAccessorGenerator.java:399)</span><br><span class="line">    at sun.reflect.MethodAccessorGenerator<span class="variable">$1</span>.run(MethodAccessorGenerator.java:394)</span><br><span class="line">    at java.security.AccessController.doPrivileged(Native Method)</span><br><span class="line">    at sun.reflect.MethodAccessorGenerator.generate(MethodAccessorGenerator.java:393)</span><br><span class="line">    at sun.reflect.MethodAccessorGenerator.generateConstructor(MethodAccessorGenerator.java:92)</span><br><span class="line">    at sun.reflect.NativeConstructorAccessorImpl.newInstance(NativeConstructorAccessorImpl.java:55)</span><br><span class="line">    at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45)</span><br><span class="line">    at java.lang.reflect.Constructor.newInstance(Constructor.java:423)</span><br><span class="line">    at java.lang.Class.newInstance(Class.java:442)</span><br><span class="line">    at com.thomas.classloader.unload.MonitorHotSwap.main(MonitorHotSwap.java:34)</span><br><span class="line">Caused by: java.lang.ClassNotFoundException: sun.reflect.ConstructorAccessorImpl</span><br><span class="line">    at java.net.URLClassLoader.findClass(URLClassLoader.java:381)</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>
<p>我把他的代码稍作简化，主要部分是类似下面的逻辑，功能是程序监控某几个文件的变动，发现符合条件就会编译并会重新加载class，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HotSwapURLClassLoader</span> <span class="keyword">extends</span> <span class="title class_">URLClassLoader</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Class&lt;?&gt; loadClass(String name, <span class="type">boolean</span> resolve) <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">        Class&lt;?&gt; clazz = <span class="literal">null</span>;</span><br><span class="line">        clazz = findLoadedClass(name);</span><br><span class="line">        <span class="keyword">if</span> (clazz != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">//...一段热替换逻辑</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (name.startsWith(<span class="string">&quot;java.&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">ClassLoader</span> <span class="variable">system</span> <span class="operator">=</span> ClassLoader.getSystemClassLoader();</span><br><span class="line">                clazz = system.loadClass(name);</span><br><span class="line">                <span class="keyword">if</span> (clazz != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (resolve)</span><br><span class="line">                        resolveClass(clazz);</span><br><span class="line">                    <span class="keyword">return</span> (clazz);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">                <span class="comment">// Ignore</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> customLoad(name, <span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">X</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">hot</span><span class="params">(String msg)</span> &#123;</span><br><span class="line">        <span class="comment">//System.out.println(String.format(&quot;ver:%s, classLoader: %s.&quot;, ver, this.getClass().getClassLoader()));</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的异常，不同于常遇到的异常，我们根据异常栈逆推可能不会很容易的定位到root cause。所以我在hot方法加了一条日志信息，即注释打开，运行多次，发现每次都是</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ver:15, classLoader: com.thomas.unload.HotSwapURLClassLoader@4e25154f.</span><br><span class="line">Exception <span class="keyword">in</span> thread <span class="string">&quot;main&quot;</span> java.lang.NoClassDefFoundError: sun/reflect/ConstructorAccessorImpl</span><br></pre></td></tr></table></figure>
<p>这让我想起了JVM参数有inflationThreshold&#x3D;15</p>
<span id="more"></span>
<h1 id="2-复现"><a href="#2-复现" class="headerlink" title="2. 复现"></a>2. 复现</h1><p><span id="Appcode">我们可以通过下面demo来深入问题，运行时候加入 -verbose或者 -XX:+TraceClassLoading 参数：</span></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">App</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> args.length &gt; <span class="number">0</span> ? Integer.valueOf(args[<span class="number">0</span>]) : <span class="number">1_000_000</span>;</span><br><span class="line">        Class&lt;?&gt; clz = Class.forName(<span class="string">&quot;X&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> clz.newInstance();</span><br><span class="line">        <span class="type">Method</span> <span class="variable">m</span> <span class="operator">=</span> clz.getMethod(<span class="string">&quot;hot&quot;</span>, String.class);</span><br><span class="line">        Thread.sleep(<span class="number">20_000</span>);</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>; i&lt;<span class="number">500</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> j=<span class="number">0</span>; j&lt;size; j++)&#123;  </span><br><span class="line">               m.invoke(o, <span class="string">&quot;hello&quot;</span>+i);</span><br><span class="line">            &#125;</span><br><span class="line">            Thread.sleep(<span class="number">50</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;---finish loop----&quot;</span>);</span><br><span class="line">        Thread.sleep(<span class="number">20_000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们可以看到输出</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">[Loaded sun.reflect.DelegatingMethodAccessorImpl from /Library/Java/JavaVirtualMachines/jdk1.8.0_102.jdk/Contents/Home/jre/lib/rt.jar]</span><br><span class="line">Hello, hello0</span><br><span class="line">...</span><br><span class="line">Hello, hello14</span><br><span class="line">[Loaded sun.reflect.ClassFileConstants from /Library/Java/JavaVirtualMachines/jdk1.8.0_102.jdk/Contents/Home/jre/lib/rt.jar]</span><br><span class="line">[Loaded sun.reflect.AccessorGenerator from /Library/Java/JavaVirtualMachines/jdk1.8.0_102.jdk/Contents/Home/jre/lib/rt.jar]</span><br><span class="line">[Loaded sun.reflect.MethodAccessorGenerator from /Library/Java/JavaVirtualMachines/jdk1.8.0_102.jdk/Contents/Home/jre/lib/rt.jar]</span><br><span class="line">[Loaded sun.reflect.ByteVectorFactory from /Library/Java/JavaVirtualMachines/jdk1.8.0_102.jdk/Contents/Home/jre/lib/rt.jar]</span><br><span class="line">[Loaded sun.reflect.ByteVector from /Library/Java/JavaVirtualMachines/jdk1.8.0_102.jdk/Contents/Home/jre/lib/rt.jar]</span><br><span class="line">[Loaded sun.reflect.ByteVectorImpl from /Library/Java/JavaVirtualMachines/jdk1.8.0_102.jdk/Contents/Home/jre/lib/rt.jar]</span><br><span class="line">[Loaded sun.reflect.ClassFileAssembler from /Library/Java/JavaVirtualMachines/jdk1.8.0_102.jdk/Contents/Home/jre/lib/rt.jar]</span><br><span class="line">[Loaded sun.reflect.UTF8 from /Library/Java/JavaVirtualMachines/jdk1.8.0_102.jdk/Contents/Home/jre/lib/rt.jar]</span><br><span class="line">[Loaded sun.reflect.Label from /Library/Java/JavaVirtualMachines/jdk1.8.0_102.jdk/Contents/Home/jre/lib/rt.jar]</span><br><span class="line">[Loaded sun.reflect.Label<span class="variable">$PatchInfo</span> from /Library/Java/JavaVirtualMachines/jdk1.8.0_102.jdk/Contents/Home/jre/lib/rt.jar]</span><br><span class="line">[Loaded java.util.ArrayList<span class="variable">$Itr</span> from /Library/Java/JavaVirtualMachines/jdk1.8.0_102.jdk/Contents/Home/jre/lib/rt.jar]</span><br><span class="line">[Loaded sun.reflect.MethodAccessorGenerator<span class="variable">$1</span> from /Library/Java/JavaVirtualMachines/jdk1.8.0_102.jdk/Contents/Home/jre/lib/rt.jar]</span><br><span class="line">[Loaded sun.reflect.ClassDefiner from /Library/Java/JavaVirtualMachines/jdk1.8.0_102.jdk/Contents/Home/jre/lib/rt.jar]</span><br><span class="line">[Loaded sun.reflect.ClassDefiner<span class="variable">$1</span> from /Library/Java/JavaVirtualMachines/jdk1.8.0_102.jdk/Contents/Home/jre/lib/rt.jar]</span><br><span class="line">[Loaded sun.reflect.GeneratedMethodAccessor1 from __JVM_DefineClass__]</span><br><span class="line">Hello, hello15</span><br><span class="line">Hello, hello16</span><br><span class="line">Hello, hello17</span><br><span class="line">[Loaded java.lang.Shutdown from /Library/Java/JavaVirtualMachines/jdk1.8.0_102.jdk/Contents/Home/jre/lib/rt.jar]</span><br><span class="line">[Loaded java.lang.Shutdown<span class="variable">$Lock</span> from /Library/Java/JavaVirtualMachines/jdk1.8.0_102.jdk/Contents/Home/jre/lib/rt.jar]</span><br></pre></td></tr></table></figure>
<p>注意到最开始load的是DelegatingMethodAccessorImpl 可是到第15次执行该方法的时候就开始load MethodAccessorGenerator -&gt; sun.reflect.GeneratedMethodAccessor1了, 前面都是from jre&#x2F;lib&#x2F;rt.jar的，而 GeneratedMethodAccessor1 from __JVM_DefineClass__，那么这个类是怎么generate出来的呢？<br>让我们从Method源码开始吧.</p>
<h1 id="3-Class-getMethod"><a href="#3-Class-getMethod" class="headerlink" title="3. Class.getMethod"></a>3. Class.getMethod</h1><p>先看Method的获取，clazz.getMethod获取public方法，这里也可以使用getDeclaredMethod，后者可以获取declared[含private／protect／public]的方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@CallerSensitive</span></span><br><span class="line"><span class="keyword">public</span> Method <span class="title function_">getMethod</span><span class="params">(String name, Class&lt;?&gt;... parameterTypes)</span></span><br><span class="line">    <span class="keyword">throws</span> NoSuchMethodException, SecurityException &#123;</span><br><span class="line">    checkMemberAccess(Member.PUBLIC, Reflection.getCallerClass(), <span class="literal">true</span>);</span><br><span class="line">    <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> getMethod0(name, parameterTypes, <span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">if</span> (method == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NoSuchMethodException</span>(getName() + <span class="string">&quot;.&quot;</span> + name + argumentTypesToString(parameterTypes));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> method;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">checkMemberAccess</span><span class="params">(<span class="type">int</span> which, Class&lt;?&gt; caller, <span class="type">boolean</span> checkProxyInterfaces)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">SecurityManager</span> <span class="variable">s</span> <span class="operator">=</span> System.getSecurityManager();</span><br><span class="line">    <span class="keyword">if</span> (s != <span class="literal">null</span>) &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">final</span> <span class="type">ClassLoader</span> <span class="variable">ccl</span> <span class="operator">=</span> ClassLoader.getClassLoader(caller);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">ClassLoader</span> <span class="variable">cl</span> <span class="operator">=</span> getClassLoader0();</span><br><span class="line">        <span class="keyword">if</span> (which != Member.PUBLIC) &#123;</span><br><span class="line">            <span class="keyword">if</span> (ccl != cl) &#123;</span><br><span class="line">                s.checkPermission(SecurityConstants.CHECK_MEMBER_ACCESS_PERMISSION);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">this</span>.checkPackageAccess(ccl, checkProxyInterfaces);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>上述，Reflection.getCallerClass()实现是一个native方法，用于获取调用这个方法的Class对象，完整源码见sun&#x2F;reflect&#x2F;Reflection.c, 实现最后在<a target="_blank" rel="noopener" href="http://hg.openjdk.java.net/jdk8/jdk8/hotspot/file/87ee5ee27509/src/share/vm/prims/jvm.cpp#l668">jvm.cpp</a>, 这个Reflection.getCallerClass获取栈帧调用者要比我们平时使用Throwable／thread stackTrace／SecurityManager的getClassContext()都要高效，只是1.8抛弃了，目前是JDK内部使用的方法, 而且该方法有CallerSensitive注解。<br>程序通过forname，即1.8中，forName0(className, true, ClassLoader.getClassLoader(caller), caller) 是通过caller class的classloader加载类，然后调用getMethod，即最终通过<br>privateGetMethodRecursive，即其实是依赖 searchMethods(privateGetDeclaredMethods(true)，从缓存或JVM中获取该Class中的方法列表，searchMethods则用于从返回的方法列表里找到一个匹配的对象，该对象名称和参数的方法匹配。<br>forname和getMethod具体写起来也很长，但为了不影响本文主题，不深入探讨。<br>下面，让我们进入正题。</p>
<h1 id="4-MethodAccessor-vs-ReflectionFactory"><a href="#4-MethodAccessor-vs-ReflectionFactory" class="headerlink" title="4. MethodAccessor vs ReflectionFactory"></a>4. MethodAccessor vs ReflectionFactory</h1><p>使用JAVA版本：java version “1.8.0_102”。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Method</span> <span class="keyword">extends</span> <span class="title class_">Executable</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> MethodAccessor methodAccessor;</span><br><span class="line">    <span class="comment">// For sharing of MethodAccessors. This branching structure is</span></span><br><span class="line">    <span class="comment">// currently only two levels deep (i.e., one root Method and</span></span><br><span class="line">    <span class="comment">// potentially many Method objects pointing to it.)</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// If this branching structure would ever contain cycles, deadlocks can</span></span><br><span class="line">    <span class="comment">// occur in annotation code.</span></span><br><span class="line">    <span class="keyword">private</span> Method              root;</span><br><span class="line">    <span class="meta">@CallerSensitive</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object obj, Object... args)</span></span><br><span class="line">        <span class="keyword">throws</span> IllegalAccessException, IllegalArgumentException,</span><br><span class="line">           InvocationTargetException</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!override) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!Reflection.quickCheckMemberAccess(clazz, modifiers)) &#123;</span><br><span class="line">                Class&lt;?&gt; caller = Reflection.getCallerClass();</span><br><span class="line">                checkAccess(caller, clazz, obj, modifiers);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">MethodAccessor</span> <span class="variable">ma</span> <span class="operator">=</span> methodAccessor;             <span class="comment">// read volatile</span></span><br><span class="line">        <span class="keyword">if</span> (ma == <span class="literal">null</span>) &#123;</span><br><span class="line">            ma = acquireMethodAccessor();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ma.invoke(obj, args);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> MethodAccessor <span class="title function_">acquireMethodAccessor</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// First check to see if one has been created yet, and take it</span></span><br><span class="line">        <span class="comment">// if so</span></span><br><span class="line">        <span class="type">MethodAccessor</span> <span class="variable">tmp</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (root != <span class="literal">null</span>) tmp = root.getMethodAccessor();</span><br><span class="line">        <span class="keyword">if</span> (tmp != <span class="literal">null</span>) &#123;</span><br><span class="line">            methodAccessor = tmp;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Otherwise fabricate one and propagate it up to the root</span></span><br><span class="line">            tmp = reflectionFactory.newMethodAccessor(<span class="built_in">this</span>);</span><br><span class="line">            setMethodAccessor(tmp);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> tmp;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>JAVA1.8里，Method extends Executable，Executable新见于1.8，是一个适用于method和constructor的通用类，里面有一些paramter和anntation等通用function Executable extends AccessibleObject; 有人可能会问 CallerSensitive 是什么用处，<a href="#hello">见这里</a>。<br>可以看到实现MethodAccessor代理实现了Method.invoke, MethodAccessor在首次调用初始化进入acquireMethodAccessor方法中，这里root即为自己，root.getMethodAccessor()为null，所以会有reflectionFactory.newMethodAccessor来new一个。<br>看reflectionFactory.newMethodAccessor(this), 源码位于jdk&#x2F;src&#x2F;share&#x2F;classes&#x2F;sun&#x2F;reflect下，<a target="_blank" rel="noopener" href="http://hg.openjdk.java.net/jdk8/jdk8/jdk/file/687fd7c7986d/src/share/classes/sun/reflect/ReflectionFactory.java">点此在线浏览</a>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> sun.reflect;</span><br><span class="line">...</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReflectionFactory</span> &#123;</span><br><span class="line">    <span class="comment">// &quot;Inflation&quot; mechanism. Loading bytecodes to implement</span></span><br><span class="line">    <span class="comment">// Method.invoke() and Constructor.newInstance() currently costs</span></span><br><span class="line">    <span class="comment">// 3-4x more than an invocation via native code for the first</span></span><br><span class="line">    <span class="comment">// invocation (though subsequent invocations have been benchmarked</span></span><br><span class="line">    <span class="comment">// to be over 20x faster). Unfortunately this cost increases</span></span><br><span class="line">    <span class="comment">// startup time for certain applications that use reflection</span></span><br><span class="line">    <span class="comment">// intensively (but only once per class) to bootstrap themselves.</span></span><br><span class="line">    <span class="comment">// To avoid this penalty we reuse the existing JVM entry points</span></span><br><span class="line">    <span class="comment">// for the first few invocations of Methods and Constructors and</span></span><br><span class="line">    <span class="comment">// then switch to the bytecode-based implementations.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// Package-private to be accessible to NativeMethodAccessorImpl</span></span><br><span class="line">    <span class="comment">// and NativeConstructorAccessorImpl</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="variable">noInflation</span>        <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span>     <span class="variable">inflationThreshold</span> <span class="operator">=</span> <span class="number">15</span>;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">public</span> MethodAccessor <span class="title function_">newMethodAccessor</span><span class="params">(Method method)</span> &#123;</span><br><span class="line">        checkInitted();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (noInflation &amp;&amp; !ReflectUtil.isVMAnonymousClass(method.getDeclaringClass())) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MethodAccessorGenerator</span>().</span><br><span class="line">                generateMethod(method.getDeclaringClass(),</span><br><span class="line">                               method.getName(),</span><br><span class="line">                               method.getParameterTypes(),</span><br><span class="line">                               method.getReturnType(),</span><br><span class="line">                               method.getExceptionTypes(),</span><br><span class="line">                               method.getModifiers());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">NativeMethodAccessorImpl</span> <span class="variable">acc</span> <span class="operator">=</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">NativeMethodAccessorImpl</span>(method);</span><br><span class="line">            <span class="type">DelegatingMethodAccessorImpl</span> <span class="variable">res</span> <span class="operator">=</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">DelegatingMethodAccessorImpl</span>(acc);</span><br><span class="line">            acc.setParent(res);</span><br><span class="line">            <span class="keyword">return</span> res;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="4-1-noInflation"><a href="#4-1-noInflation" class="headerlink" title="4.1 noInflation"></a>4.1 noInflation</h3><p>当noInflation为true，默认false，除非设置 -Dsun.reflect.noInflation&#x3D;true，则这时由MethodAccessorGenerator生成一个MethodAccessor，具体逻辑跟接下来要讲述的NativeMethodAccessorImpl的一个分支是一样的。</p>
<h3 id="4-2-NativeMethodAccessorImpl"><a href="#4-2-NativeMethodAccessorImpl" class="headerlink" title="4.2 NativeMethodAccessorImpl"></a>4.2 NativeMethodAccessorImpl</h3><p>noInflation为false，则通过new NativeMethodAccessorImpl并将其赋给代理类使用（这里不是很清楚为何代理，猜测可能编码简便，也使得只需通过setDelegate方式解除引用，NativeMethodAccessorImpl可以被回收掉）。<br>让我们看看NativeMethodAccessorImpl的实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">NativeMethodAccessorImpl</span> <span class="keyword">extends</span> <span class="title class_">MethodAccessorImpl</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Method method;</span><br><span class="line">    <span class="keyword">private</span> DelegatingMethodAccessorImpl parent;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> numInvocations;</span><br><span class="line">    NativeMethodAccessorImpl(Method method) &#123;</span><br><span class="line">        <span class="built_in">this</span>.method = method;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object obj, Object[] args)</span></span><br><span class="line">        <span class="keyword">throws</span> IllegalArgumentException, InvocationTargetException</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// We can&#x27;t inflate methods belonging to vm-anonymous classes because</span></span><br><span class="line">        <span class="comment">// that kind of class can&#x27;t be referred to by name, hence can&#x27;t be</span></span><br><span class="line">        <span class="comment">// found from the generated bytecode.</span></span><br><span class="line">        <span class="keyword">if</span> (++numInvocations &gt; ReflectionFactory.inflationThreshold()</span><br><span class="line">                &amp;&amp; !ReflectUtil.isVMAnonymousClass(method.getDeclaringClass())) &#123;</span><br><span class="line">            <span class="type">MethodAccessorImpl</span> <span class="variable">acc</span> <span class="operator">=</span> (MethodAccessorImpl)</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">MethodAccessorGenerator</span>().</span><br><span class="line">                    generateMethod(method.getDeclaringClass(),</span><br><span class="line">                                   method.getName(),</span><br><span class="line">                                   method.getParameterTypes(),</span><br><span class="line">                                   method.getReturnType(),</span><br><span class="line">                                   method.getExceptionTypes(),</span><br><span class="line">                                   method.getModifiers());</span><br><span class="line">            parent.setDelegate(acc);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> invoke0(method, obj, args);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">setParent</span><span class="params">(DelegatingMethodAccessorImpl parent)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.parent = parent;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">native</span> Object <span class="title function_">invoke0</span><span class="params">(Method m, Object obj, Object[] args)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到当numInvocations超过ReflectionFactory的inflationThreshold(上文ReflectionFactory默认15 )，这时便会通过new MethodAccessorGenerator生成，也就是对应了上文我们说的ReflectionFactory里的noInflation为true的逻辑。</p>
<h3 id="4-3-NativeMethodAccessorImpl-invoke0"><a href="#4-3-NativeMethodAccessorImpl-invoke0" class="headerlink" title="4.3 NativeMethodAccessorImpl.invoke0"></a>4.3 NativeMethodAccessorImpl.invoke0</h3><p>先来看NativeMethodAccessorImpl的invoke0，这是默认的逻辑，即ReflectionFactory提到的<br>    Inflation, Loading bytecodes to implement Method.invoke() and Constructor.newInstance() currently costs 3-4x more than an invocation via native code for the first invocation (though subsequent invocations have been benchmarked to be over 20x faster).<br>java bytecode版本运行快，但是初始化耗时，而native版本启动快，但若长久运行效率不如bytecode版本。<br>在有的文章里说，”调用JNI方法耗时“，如马化腾先生说的，这句话对也不对。因为这句话是没有指明的是耗时的究竟是“调用”这个操作还是“JNI方法”，而且这个“调用”指的是哪些（call，参数校验，java和C的参数／结果转换…）？不过还好平时基本不会用到，所以许多技术交流或者面试这么问这么答对的时候不会有什么大问题。<br>那么究竟是哪个耗时呢？事实上从下面这张火焰图可以明显看出来。</p>
<h1 id="5-JMH-BenchMark"><a href="#5-JMH-BenchMark" class="headerlink" title="5. JMH BenchMark"></a>5. JMH BenchMark</h1><p>MethodAccessorGenerator的代码稍后再做分析，让我们先在此暂停，看一下注释里面提到的二者性能并做一个对比， 这里简化了JMH的日志输出，仅保留VM参数和结果。</p>
<h3 id="5-1-JMH对比结果"><a href="#5-1-JMH对比结果" class="headerlink" title="5.1 JMH对比结果"></a>5.1 JMH对比结果</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># JMH 1.10 (released 776 days ago, please consider updating!)</span></span><br><span class="line"><span class="comment"># VM invoker: /Library/Java/JavaVirtualMachines/jdk1.8.0_102.jdk/Contents/Home/jre/bin/java</span></span><br><span class="line"><span class="comment"># VM options: -Djmh.ignoreLock=true -Dsun.reflect.inflationThreshold=180000000</span></span><br><span class="line"><span class="comment"># Warmup: 1 iterations, 1 s each</span></span><br><span class="line">...</span><br><span class="line">Benchmark                                             (size)  Mode  Cnt    Score    Error    Units</span><br><span class="line">ReflectiveBenchMarkTest.testDirect                   1000000  avgt    3    0.048 ±  0.003    ms/op</span><br><span class="line">ReflectiveBenchMarkTest.testDirect:·threads.alive    1000000  avgt    3    5.000 ±  0.001  threads</span><br><span class="line">ReflectiveBenchMarkTest.testDirect:·threads.daemon   1000000  avgt    3    4.000 ±  0.001  threads</span><br><span class="line">ReflectiveBenchMarkTest.testDirect:·threads.started  1000000  avgt    3    5.000           threads</span><br><span class="line">ReflectiveBenchMarkTest.testInvoke                   1000000  avgt    3  290.985 ± 73.334    ms/op</span><br><span class="line">ReflectiveBenchMarkTest.testInvoke:·threads.alive    1000000  avgt    3    5.000 ±  0.001  threads</span><br><span class="line">ReflectiveBenchMarkTest.testInvoke:·threads.daemon   1000000  avgt    3    4.000 ±  0.001  threads</span><br><span class="line">ReflectiveBenchMarkTest.testInvoke:·threads.started  1000000  avgt    3    5.000           threads</span><br><span class="line">------------------</span><br><span class="line"><span class="comment"># JMH 1.10 (released 776 days ago, please consider updating!)</span></span><br><span class="line"><span class="comment"># VM invoker: /Library/Java/JavaVirtualMachines/jdk1.8.0_102.jdk/Contents/Home/jre/bin/java</span></span><br><span class="line"><span class="comment"># VM options: -Djmh.ignoreLock=true -Dsun.reflect.inflationThreshold=1</span></span><br><span class="line"><span class="comment"># Warmup: 1 iterations, 1 s each</span></span><br><span class="line">...</span><br><span class="line">ReflectiveBenchMarkTest.testDirect                      1000000  avgt    3     0.049 ±    0.012    ms/op</span><br><span class="line">ReflectiveBenchMarkTest.testDirect:·threads.alive       1000000  avgt    3     5.000 ±    0.001  threads</span><br><span class="line">ReflectiveBenchMarkTest.testDirect:·threads.daemon      1000000  avgt    3     4.000 ±    0.001  threads</span><br><span class="line">ReflectiveBenchMarkTest.testDirect:·threads.started     1000000  avgt    3     5.000             threads</span><br><span class="line">ReflectiveBenchMarkTest.testInvoke                      1000000  avgt    3     3.082 ±    1.054    ms/op</span><br><span class="line">ReflectiveBenchMarkTest.testInvoke:·threads.alive       1000000  avgt    3     5.000 ±    0.001  threads</span><br><span class="line">ReflectiveBenchMarkTest.testInvoke:·threads.daemon      1000000  avgt    3     4.000 ±    0.001  threads</span><br><span class="line">ReflectiveBenchMarkTest.testInvoke:·threads.started     1000000  avgt    3     5.000             threads</span><br></pre></td></tr></table></figure>
<p>在我的 Mac 2.9 GHz Intel Core i5，8 GB 1867 MHz DDR3，使用JMH实测几次下来性能差距还是inflationThreshold&#x3D;1和80000000差距还是蛮大的，约80倍(1000000次分别290.985ms,3.082ms)，远大于文中提的20X(1000000次分别0.049ms,3.082ms)[或者测试有误？当然也不排除可能是参数较少的缘故]，而优化的invoke与原生的方法访问性能差60倍，但可以计算到，在反射上的耗时是纳秒计的，这在许多业务系统相对而言几乎可以忽略不计的。</p>
<h3 id="5-2-JMH-BenchMark代码"><a href="#5-2-JMH-BenchMark代码" class="headerlink" title="5.2 JMH BenchMark代码"></a>5.2 JMH BenchMark代码</h3><p>（未想到好的测试first invocation 3-4X的方法，故这里只测两种方法性能）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Warmup(iterations = 1, time = 1, timeUnit = TimeUnit.SECONDS)</span></span><br><span class="line"><span class="meta">@Measurement(iterations = 3, time = 1, timeUnit = TimeUnit.SECONDS)</span></span><br><span class="line"><span class="meta">@Fork(value = 1, jvmArgsAppend = &#123; &quot;-Djmh.ignoreLock=true&quot;, &quot;-Dsun.reflect.inflationThreshold=180000000&quot;&#125;)</span><span class="comment">//&quot;-XX:+TraceClassLoading&quot;, </span></span><br><span class="line"><span class="meta">@BenchmarkMode(Mode.AverageTime)</span></span><br><span class="line"><span class="meta">@OutputTimeUnit(TimeUnit.MILLISECONDS)</span></span><br><span class="line"><span class="meta">@State(Scope.Benchmark)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReflectiveBenchMarkTest</span> <span class="keyword">extends</span> <span class="title class_">MethodTest</span> &#123;</span><br><span class="line">    Method m;</span><br><span class="line">    Object o;</span><br><span class="line">    <span class="type">X</span> <span class="variable">xx</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">X</span>();</span><br><span class="line">    <span class="meta">@Param(&#123; &quot;1000&quot;, &quot;1000000&quot; &#125;)</span></span><br><span class="line">    <span class="type">int</span> size;</span><br><span class="line">    <span class="meta">@Setup</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUp</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Class&lt;?&gt; clz = Class.forName(<span class="string">&quot;org.thomas.chs.X&quot;</span>);</span><br><span class="line">        o = clz.newInstance();</span><br><span class="line">        m = clz.getMethod(<span class="string">&quot;hot&quot;</span>, String.class);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@TearDown</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">tearDown</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Benchmark</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testInvoke</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">            m.invoke(o, <span class="string">&quot;hello&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Benchmark</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testDirect</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">            xx.hot(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="6-JAVA-Flame-Graph"><a href="#6-JAVA-Flame-Graph" class="headerlink" title="6. JAVA Flame Graph"></a>6. JAVA Flame Graph</h1><p>下面是针对上文的App类做的一个JAVA火焰图，<a href="#Appcode">代码在这</a> 使用 <a target="_blank" rel="noopener" href="https://github.com/jvm-profiling-tools/async-profiler">https://github.com/jvm-profiling-tools/async-profiler</a> 的profiler, 在CentOS 7系统。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">java -Dsun.reflect.inflationThreshold=10000000 App 10000000</span><br><span class="line">pgrep java</span><br><span class="line">./profiler.sh -d 80 -o flamegraph -f /tmp/traces.txt 7760</span><br><span class="line">../FlameGraph/flamegraph.pl --colors=java /tmp/traces.txt &gt; ../flamegraph.svg</span><br></pre></td></tr></table></figure>
<img src="/images/flamegraph.png" width = "100%" />
由于blog不支持插入svg，可以点击 <a href="/images/flamegraph.svg" target="_blank">这里看svg原件</a>, 上面看各个方法的CPU采样会很清楚。
上面采样基于nflationThreshold=10_000_000, 上图可以看到sun/Freflect/DelegatingMethodAccessorImpl.invoke上方被分成了GeneratedMethodAccessor1和NativeMethodAccessorImpl两部分, 并且他们的耗时比还是很明显的3:1，但其实程序在NativeMethodAccessorImpl循环一次，GeneratedMethodAccessor1循环499次。
# 7. GeneratedMethodAccessor1是什么？
### 7.1 GeneratedMethodAccessor1的生成
那么GeneratedMethodAccessor1到底是什么？这要看这里通过ASM生成的字节码了。
可以[在线浏览代码MethodAccessorGenerator](http://hg.openjdk.java.net/jdk8/jdk8/jdk/file/687fd7c7986d/src/share/classes/sun/reflect/MethodAccessorGenerator.java#l124)，这里只贴出部分：
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** This routine is not thread-safe */</span></span><br><span class="line"><span class="keyword">private</span> MagicAccessorImpl <span class="title function_">generate</span><span class="params">(<span class="keyword">final</span> Class&lt;?&gt; declaringClass,</span></span><br><span class="line"><span class="params">                                   String name,</span></span><br><span class="line"><span class="params">                                   Class&lt;?&gt;[] parameterTypes,</span></span><br><span class="line"><span class="params">                                   Class&lt;?&gt;   returnType,</span></span><br><span class="line"><span class="params">                                   Class&lt;?&gt;[] checkedExceptions,</span></span><br><span class="line"><span class="params">                                   <span class="type">int</span> modifiers,</span></span><br><span class="line"><span class="params">                                   <span class="type">boolean</span> isConstructor,</span></span><br><span class="line"><span class="params">                                   <span class="type">boolean</span> forSerialization,</span></span><br><span class="line"><span class="params">                                   Class&lt;?&gt; serializationTargetClass)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">ByteVector</span> <span class="variable">vec</span> <span class="operator">=</span> ByteVectorFactory.create();</span><br><span class="line">    asm = <span class="keyword">new</span> <span class="title class_">ClassFileAssembler</span>(vec);</span><br><span class="line">    <span class="built_in">this</span>.declaringClass = declaringClass;</span><br><span class="line">    <span class="built_in">this</span>.parameterTypes = parameterTypes;</span><br><span class="line">    <span class="built_in">this</span>.returnType = returnType;</span><br><span class="line">    <span class="built_in">this</span>.modifiers = modifiers;</span><br><span class="line">    <span class="built_in">this</span>.isConstructor = isConstructor;</span><br><span class="line">    <span class="built_in">this</span>.forSerialization = forSerialization;</span><br><span class="line">    asm.emitMagicAndVersion();</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">final</span> <span class="type">String</span> <span class="variable">generatedName</span> <span class="operator">=</span> generateName(isConstructor, forSerialization);</span><br><span class="line">    asm.emitConstantPoolUTF8(generatedName);</span><br><span class="line">    asm.emitConstantPoolClass(asm.cpi());</span><br><span class="line">    thisClass = asm.cpi();</span><br><span class="line">    <span class="keyword">if</span> (isConstructor) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        asm.emitConstantPoolUTF8(<span class="string">&quot;sun/reflect/MethodAccessorImpl&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    asm.emitConstantPoolClass(asm.cpi());</span><br><span class="line">    ...</span><br><span class="line">    targetMethodRef = asm.cpi();</span><br><span class="line">    <span class="keyword">if</span> (isConstructor) &#123;</span><br><span class="line">        asm.emitConstantPoolUTF8(<span class="string">&quot;newInstance&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        asm.emitConstantPoolUTF8(<span class="string">&quot;invoke&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    invokeIdx = asm.cpi();</span><br><span class="line">    <span class="keyword">if</span> (isConstructor) &#123;</span><br><span class="line">        asm.emitConstantPoolUTF8(<span class="string">&quot;([Ljava/lang/Object;)Ljava/lang/Object;&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        asm.emitConstantPoolUTF8</span><br><span class="line">            (<span class="string">&quot;(Ljava/lang/Object;[Ljava/lang/Object;)Ljava/lang/Object;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">final</span> <span class="type">byte</span>[] bytes = vec.getData();</span><br><span class="line">    <span class="comment">// Note: the class loader is the only thing that really matters</span></span><br><span class="line">    <span class="comment">// here -- it&#x27;s important to get the generated code into the</span></span><br><span class="line">    <span class="comment">// same namespace as the target class. Since the generated code</span></span><br><span class="line">    <span class="comment">// is privileged anyway, the protection domain probably doesn&#x27;t</span></span><br><span class="line">    <span class="comment">// matter.</span></span><br><span class="line">    <span class="keyword">return</span> AccessController.doPrivileged(</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">PrivilegedAction</span>&lt;MagicAccessorImpl&gt;() &#123;</span><br><span class="line">            <span class="keyword">public</span> MagicAccessorImpl <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> (MagicAccessorImpl)</span><br><span class="line">                    ClassDefiner.defineClass</span><br><span class="line">                            (generatedName,</span><br><span class="line">                             bytes,</span><br><span class="line">                             <span class="number">0</span>,</span><br><span class="line">                             bytes.length,</span><br><span class="line">                             declaringClass.getClassLoader()).newInstance();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InstantiationException | IllegalAccessException e) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InternalError</span>(e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
### 7.2 GeneratedMethodAccessor1长啥样
其实不管你是否了解ASM，通过注释可以看出大概这段jvm code是干啥的了，不过有没有办法得到这段字节码呢？记得有个jvm参数可以获取匿名类的字节码，而这里我们也可以通过javaagent方式得到这段字节码的。如下代码：
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomAgent</span> <span class="keyword">implements</span> <span class="title class_">ClassFileTransformer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">premain</span><span class="params">(String agentArgs, Instrumentation inst)</span> &#123;</span><br><span class="line">        inst.addTransformer(<span class="keyword">new</span> <span class="title class_">CustomAgent</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">byte</span>[] transform(ClassLoader loader, String className, Class&lt;?&gt; classBeingRedefined,</span><br><span class="line">            ProtectionDomain protectionDomain, <span class="type">byte</span>[] classfileBuffer) <span class="keyword">throws</span> IllegalClassFormatException &#123;</span><br><span class="line">        <span class="comment">// System.out.println(className);</span></span><br><span class="line">        <span class="keyword">if</span> (className.indexOf(<span class="string">&quot;GeneratedMethodAccessor&quot;</span>)!= -<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">fileName</span> <span class="operator">=</span> className.substring(className.lastIndexOf(<span class="string">&quot;/&quot;</span>)+<span class="number">1</span>)+<span class="string">&quot;.class&quot;</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Files.write(Paths.get(<span class="string">&quot;/Users/thomaslau/ztemp/java/&quot;</span>, fileName), classfileBuffer);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">&quot;succed writing&quot;</span> + className);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> classfileBuffer;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
Manifest.mf文件指定 Premain-Class: thomas.CustomAgent，之后运行

<pre><code>java -javaagent:/Users/thomaslau/custagent.jar App
</code></pre>
<p>得到的GeneratedMethodAccessor1.class见<a href="#generatedMethodAccessor1">附录</a>。<br>下面需要用到decompile工具，有的使用jd，不过要注意需要支持到1.8，有些不能正确反编译，所以我使用了<a target="_blank" rel="noopener" href="https://github.com/deathmarine/Luyten">Luyten+Procyon</a>, 一款Java Decompiler Gui for Procyon，曾经评测得分较高。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> sun.reflect;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.*;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GeneratedMethodAccessor1</span> <span class="keyword">extends</span> <span class="title class_">MethodAccessorImpl</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(<span class="keyword">final</span> Object o, <span class="keyword">final</span> Object[] array)</span> <span class="keyword">throws</span> InvocationTargetException &#123;</span><br><span class="line">        <span class="keyword">if</span> (o == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        X x;</span><br><span class="line">        String s;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            x = (X)o;</span><br><span class="line">            <span class="keyword">if</span> (array.length != <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>();</span><br><span class="line">            &#125;</span><br><span class="line">            s = (String)array[<span class="number">0</span>];</span><br><span class="line">            x.hot(s);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (ClassCastException | NullPointerException ex) &#123;</span><br><span class="line">            <span class="keyword">final</span> Object o3;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(o3.toString());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            x.hot(s);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InvocationTargetException</span>(t);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="7-3-MagicAccessorImpl"><a href="#7-3-MagicAccessorImpl" class="headerlink" title="7.3 MagicAccessorImpl"></a>7.3 MagicAccessorImpl</h3><p>最后，generate返回的是MagicAccessorImpl，因为generate这里为ConstructorAccessorImpl和MethodAccessorImpl共用，二者都是MagicAccessorImpl子类，然后再在各自的方法里强制转换一次。 这里package（sun.reflect）属性的MagicAccessorImpl作用是：</p>
<pre><code>is a marker class in the hierarchy. All subclasses of this class are
&quot;magically&quot; granted access by the VM to otherwise inaccessible
fields and methods of other classes. It is used to hold the code
for dynamically-generated FieldAccessorImpl and MethodAccessorImpl
subclasses. (Use of the word &quot;unsafe&quot; was avoided in this class&#39;s
name to avoid confusion with &#123;@link sun.misc.Unsafe&#125;.)
</code></pre>
<p>这也表明了至少generate底层是支持invoke 到private方法的。<br>    public Object invoke(final Object o, final Object[] array)<br>从这一句我们也可以看到，即便是GeneratedMethodAccessor1，这个Method的对象／参数／返回都退化成了Object，导致需要一些类型check，但这是由外层方法决定的，MethodHandle避免了这类问题。</p>
<h1 id="8-NativeMethodAccessorImpl-invoke0"><a href="#8-NativeMethodAccessorImpl-invoke0" class="headerlink" title="8. NativeMethodAccessorImpl.invoke0"></a>8. NativeMethodAccessorImpl.invoke0</h1><p>最后，让我们看下GeneratedMethodAccessor1之外的选择，invoke0这个native方法，可以从前面的SVG看C代码的调用栈：<br><img src="/images/flamegraph_native.png" width = "100%" /><br>CPU采样也可以看到X.hot的cpu占比远小于JVM_InvokeMethod<br>从NativeAccessor.c找到jvm.cpp, <a target="_blank" rel="noopener" href="http://hg.openjdk.java.net/jdk8/jdk8/hotspot/file/87ee5ee27509/src/share/vm/prims/jvm.cpp#l4010">点这里jvm.cpp</a>,让我们大概了解下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">JVM_ENTRY(jobject, JVM_InvokeMethod(JNIEnv *env, jobject method, jobject obj, jobjectArray args0))</span><br><span class="line">  JVMWrapper(<span class="string">&quot;JVM_InvokeMethod&quot;</span>);</span><br><span class="line">  Handle method_handle;</span><br><span class="line">  <span class="keyword">if</span> (thread-&gt;stack_available((address) &amp;method_handle) &gt;= JVMInvokeMethodSlack) &#123;</span><br><span class="line">    method_handle = Handle(THREAD, JNIHandles::resolve(method));</span><br><span class="line">    Handle <span class="title function_">receiver</span><span class="params">(THREAD, JNIHandles::resolve(obj))</span>;</span><br><span class="line">    objArrayHandle <span class="title function_">args</span><span class="params">(THREAD, objArrayOop(JNIHandles::resolve(args0)))</span>;</span><br><span class="line">    oop result = Reflection::invoke_method(method_handle(), receiver, args, CHECK_NULL);</span><br><span class="line">    jobject res = JNIHandles::make_local(env, result);</span><br><span class="line">    <span class="keyword">if</span> (JvmtiExport::should_post_vm_object_alloc()) &#123;</span><br><span class="line">      oop ret_type = java_lang_reflect_Method::return_type(method_handle());</span><br><span class="line">      assert(ret_type != <span class="literal">NULL</span>, <span class="string">&quot;sanity check: ret_type oop must not be NULL!&quot;</span>);</span><br><span class="line">      <span class="keyword">if</span> (java_lang_Class::is_primitive(ret_type)) &#123;</span><br><span class="line">        <span class="comment">// Only for primitive type vm allocates memory for java object.</span></span><br><span class="line">        <span class="comment">// See box() method.</span></span><br><span class="line">        JvmtiExport::post_vm_object_alloc(JavaThread::current(), result);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    THROW_0(vmSymbols::java_lang_StackOverflowError());</span><br><span class="line">  &#125;</span><br><span class="line">JVM_END</span><br></pre></td></tr></table></figure>
<p>这里往下就是jvm内部，对JIT的黑盒了. <a target="_blank" rel="noopener" href="http://hg.openjdk.java.net/jdk8/jdk8/hotspot/file/87ee5ee27509/src/share/vm/runtime/reflection.cpp#l1117">Reflection.cpp</a></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// This would be nicer if, say, java.lang.reflect.Method was a subclass</span></span><br><span class="line"><span class="comment">// of java.lang.reflect.Constructor</span></span><br><span class="line"></span><br><span class="line"><span class="function">oop <span class="title">Reflection::invoke_method</span><span class="params">(oop method_mirror, Handle receiver, objArrayHandle args, TRAPS)</span> </span>&#123;</span><br><span class="line">  oop mirror             = java_lang_reflect_Method::<span class="built_in">clazz</span>(method_mirror);</span><br><span class="line">  <span class="type">int</span> slot               = java_lang_reflect_Method::<span class="built_in">slot</span>(method_mirror);</span><br><span class="line">  <span class="type">bool</span> <span class="keyword">override</span>          = java_lang_reflect_Method::<span class="built_in">override</span>(method_mirror) != <span class="number">0</span>;</span><br><span class="line">  <span class="function">objArrayHandle <span class="title">ptypes</span><span class="params">(THREAD, objArrayOop(java_lang_reflect_Method::parameter_types(method_mirror)))</span></span>;</span><br><span class="line">  oop return_type_mirror = java_lang_reflect_Method::<span class="built_in">return_type</span>(method_mirror);</span><br><span class="line">  BasicType rtype;</span><br><span class="line">  <span class="keyword">if</span> (java_lang_Class::<span class="built_in">is_primitive</span>(return_type_mirror)) &#123;</span><br><span class="line">    rtype = <span class="built_in">basic_type_mirror_to_basic_type</span>(return_type_mirror, CHECK_NULL);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    rtype = T_OBJECT;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function">instanceKlassHandle <span class="title">klass</span><span class="params">(THREAD, java_lang_Class::as_Klass(mirror))</span></span>;</span><br><span class="line">  Method* m = klass-&gt;<span class="built_in">method_with_idnum</span>(slot);</span><br><span class="line">  <span class="keyword">if</span> (m == <span class="literal">NULL</span>) &#123;</span><br><span class="line">    <span class="built_in">THROW_MSG_0</span>(vmSymbols::<span class="built_in">java_lang_InternalError</span>(), <span class="string">&quot;invoke&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function">methodHandle <span class="title">method</span><span class="params">(THREAD, m)</span></span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">invoke</span>(klass, method, receiver, <span class="keyword">override</span>, ptypes, rtype, args, <span class="literal">true</span>, THREAD);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里除了invoke_method，还有上文constructor也对应invoke_constructor，后者主要在initialize检查，没有这些参数校验，但最终也是调用invoke方法。<br>如果你留意链接里的火焰图，就会发现NativeMethodAccessorImpl.invoke0顶上的一条比较宽的是JavaCalls::call_helper(JavaValue* result, methodHandle* m, JavaCallArguments* args, TRAPS)，没错这里就是最终调用java方法的地方了。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">JavaCalls::call_helper</span><span class="params">(JavaValue* result, methodHandle* m, JavaCallArguments* args, TRAPS)</span> &#123;</span><br><span class="line">  methodHandle method = *m;</span><br><span class="line">  JavaThread* thread = (JavaThread*)THREAD;</span><br><span class="line">  assert(thread-&gt;is_Java_thread(), <span class="string">&quot;must be called by a java thread&quot;</span>);</span><br><span class="line">  assert(method.not_null(), <span class="string">&quot;must have a method to call&quot;</span>);</span><br><span class="line">  assert(!SafepointSynchronize::is_at_safepoint(), <span class="string">&quot;call to Java code during VM operation&quot;</span>);</span><br><span class="line">  assert(!thread-&gt;handle_area()-&gt;no_handle_mark_active(), <span class="string">&quot;cannot call out to Java here&quot;</span>);</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// do call</span></span><br><span class="line">  &#123; JavaCallWrapper <span class="title function_">link</span><span class="params">(method, receiver, result, CHECK)</span>;</span><br><span class="line">    &#123; HandleMark <span class="title function_">hm</span><span class="params">(thread)</span>;  <span class="comment">// HandleMark used by HandleMarkCleaner</span></span><br><span class="line"></span><br><span class="line">      StubRoutines::call_stub()(</span><br><span class="line">        (address)&amp;link,</span><br><span class="line">        <span class="comment">// (intptr_t*)&amp;(result-&gt;_value), // see NOTE above (compiler problem)</span></span><br><span class="line">        result_val_address,          <span class="comment">// see NOTE above (compiler problem)</span></span><br><span class="line">        result_type,</span><br><span class="line">        method(),</span><br><span class="line">        entry_point,</span><br><span class="line">        args-&gt;parameters(),</span><br><span class="line">        args-&gt;size_of_parameters(),</span><br><span class="line">        CHECK</span><br><span class="line">      );</span><br><span class="line"></span><br><span class="line">      result = link.result();  <span class="comment">// circumvent MS C++ 5.0 compiler bug (result ...</span></span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>reflection.cpp invoke等代码过长，就不贴这里了，感兴趣的可以移步到<a target="_blank" rel="noopener" href="http://hg.openjdk.java.net/jdk8/jdk8/hotspot/file/87ee5ee27509/src/share/vm/runtime/reflection.cpp#l901">Reflection.cpp#invoke</a></p>
<h1 id="9-其他"><a href="#9-其他" class="headerlink" title="9. 其他"></a>9. 其他</h1><p>有的会通过机器指令验证，如：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">java -server -Dsun.reflect.inflationThreshold=180000000 -XX:+UnlockDiagnosticVMOptions -XX:+PrintAssembly -XX:+PrintCompilation <span class="string">&#x27;-XX:CompileCommand=compileonly sun/reflect/NativeMethodAccessorImpl.invoke&#x27;</span> App &gt; pure_native_infla18M.txt</span></span><br><span class="line">Java HotSpot(TM) 64-Bit Server VM warning: PrintAssembly is enabled; turning on DebugNonSafepoints to gain additional output</span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">java -server -Dsun.reflect.inflationThreshold=1 -XX:+UnlockDiagnosticVMOptions -XX:+PrintAssembly -XX:+PrintCompilation <span class="string">&#x27;-XX:CompileCommand=compileonly sun/reflect/GeneratedMethodAccessor1.invoke&#x27;</span> App &gt; pure_generate_infla1.txt</span></span><br></pre></td></tr></table></figure>
<p>上面确实可以看到各种inflationThreshold情况下起作用的是GeneratedMethodAccessor1还是NativeMethodAccessorImpl，不过再看就是看到一些callq指令了，性能分析需要引入其他工具。</p>
<h1 id="10-附录"><a href="#10-附录" class="headerlink" title="10. 附录"></a>10. 附录</h1><p><strong>1, <span id="hello">CallerSensitive其实就是实现</span></strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Returns the class of the caller of the method calling this method, ignoring frames </span><br><span class="line">associated with java.lang.reflect.Method.invoke() and its implementation</span><br></pre></td></tr></table></figure>
<p>的功能，这是一个由大神<a target="_blank" rel="noopener" href="https://twitter.com/briangoetz">Brian Goetz</a>于1.8提出的<a target="_blank" rel="noopener" href="http://openjdk.java.net/jeps/176">JEP-176</a>，StackOverFlow<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/22626808/what-does-the-sun-reflect-callersensitive-annotation-mean">里讲的比较概括些</a>，CallerSensitive<a target="_blank" rel="noopener" href="http://hg.openjdk.java.net/jdk8/jdk8/jdk/file/687fd7c7986d/src/share/classes/sun/reflect/CallerSensitive.java">的源码链接</a><br><strong>2, isVMAnonymousClass</strong><br>见 <a target="_blank" rel="noopener" href="http://hg.openjdk.java.net/jdk8/jdk8/jdk/file/687fd7c7986d/src/share/classes/sun/reflect/misc/ReflectUtil.java">ReflectUtil</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Checks if &#123;<span class="doctag">@code</span> Class cls&#125; is a VM-anonymous class</span></span><br><span class="line"><span class="comment"> * as defined by &#123;<span class="doctag">@link</span> sun.misc.Unsafe#defineAnonymousClass&#125;</span></span><br><span class="line"><span class="comment"> * (not to be confused with a Java Language anonymous inner class).</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isVMAnonymousClass</span><span class="params">(Class&lt;?&gt; cls)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> cls.getName().indexOf(<span class="string">&quot;/&quot;</span>) &gt; -<span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>什么是VM-anonymous class？<a target="_blank" rel="noopener" href="https://jcp.org/en/jsr/detail?id=292">JSR292</a>的领导者，亦即为JAVA(java7)引入了动态类型语言支持的<a target="_blank" rel="noopener" href="https://blogs.oracle.com/jrose/anonymous-classes-in-the-vm">John Rose在其Anonymous classes in the VM</a>里面有详述，这是一类独立于class loader、system dictionary的而寄生在hostclass的匿名类（但不是必须），这解决了许多基于JVM的动态语言的问题，<a target="_blank" rel="noopener" href="http://openjdk.java.net/projects/mlvm">OpenJDK Multi-Language VM project</a><br>定义在<a target="_blank" rel="noopener" href="http://hg.openjdk.java.net/jdk8/jdk8/jdk/file/687fd7c7986d/src/share/classes/sun/misc/Unsafe.java">Unsafe</a>的一个native实现，具体实现在Unsafe.cpp,<a target="_blank" rel="noopener" href="http://hg.openjdk.java.net/jdk8u/jdk8u/hotspot/file/c82d1a19ffb5/src/share/vm/prims/unsafe.cpp#l1132">源码点击此处</a><strong>TODO！！</strong>.<br>John Rose贡献了MethodHandles等实现，比如常用于JRuby／Jython等语言的invokedynamic指令，即</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Add a new bytecode, invokedynamic, that supports efficient and flexible </span><br><span class="line">execution of method invocations in the absence of static type information. </span><br></pre></td></tr></table></figure>
<p>事实上，JSR292最初分为三部分，AnonymousClassLoader、MethodHandle(s)和invokedynamic, 1.7主要用AnonymousClass来实现动态语言支持，1.8之后则提供了invokedynamic使用，目前看应该是二者混用的，不过<a target="_blank" rel="noopener" href="http://www.javaworld.com/article/2072319/core-java/a-first-taste-of-invokedynamic.html?page=2">AnonymousClassLoader</a>在1.7声称因非标准API会被废弃掉，目前依旧是<a target="_blank" rel="noopener" href="http://bugs.java.com/view_bug.do?bug_id=6990182">声明状态</a>, 因为1.8的lambda实现中LambdaMetaFactory正是通过Unsafe.defineAnonymousClass将ASM生成的class插入到original 即host class。<br>Nashorn项目也在用它<a target="_blank" rel="noopener" href="https://bugs.openjdk.java.net/browse/JDK-8135251">loading Nashorn script code</a>, 至少截止20170725是如此。<br>invokedynamic于1.7引入，但实际上1.8时javac才支持的。<br>具体目前还未看透，后面可能会再写文章再深入探讨。<br><strong>3，VM-anonymous class与匿名类（anonymous class）的区别？</strong><br>最大的区别是，匿名类经过javac之后是一个有名字(XX.$1)的正常的java class，前者不是，可见上文所述。<br><strong>4，<a target="_blank" rel="noopener" href="https://www.slideshare.net/CharlesNutter/invokedynamic-in-45-minutes">invokeDynamic</a></strong><br>Java语言架构师Brian Goetz也在JSR 335提到jAVA Lambda实现<a target="_blank" rel="noopener" href="http://cr.openjdk.java.net/~briangoetz/lambda/lambda-translation.html">Translation of Lambda Expressions</a>…确实太多了，而Reflection与MethodHandle／dynamic区别，简单来讲可以认为Reflection像是java代码层次，MethodHandle是jvm层次，前者局限于java，后者则适用基于JVM的语言。1.8中InvokeDynamic用于lambda对象的创建，实际调用方法还是invokevirtual&#x2F;inter..&#x2F;speci.., 可以看看<a target="_blank" rel="noopener" href="https://wiki.openjdk.java.net/display/HotSpot/Method+handles+and+invokedynamic">MethodHandles and Invokedynamic</a>, <a target="_blank" rel="noopener" href="http://www.javaworld.com/article/2860079/learn-java/invokedynamic-101.html?page=2">Invokedynamic-101</a>,  <a target="_blank" rel="noopener" href="https://www.infoq.com/articles/Invokedynamic-Javas-secret-weapon">Invokedynamic-Javas-secret-weapon</a>, 或周志明f写的infoq的文章 <a target="_blank" rel="noopener" href="http://www.infoq.com/cn/articles/jdk-dynamically-typed-language">解析JDK 7的动态类型语言支持</a>, blog签名有趣的JRuby专家<a target="_blank" rel="noopener" href="http://blog.headius.com/2008/09/first-taste-of-invokedynamic.html">first-taste-of-invokedynamic</a>, Oracle一篇tech note<a target="_blank" rel="noopener" href="http://docs.oracle.com/javase/8/docs/technotes/guides/vm/multiple-language-support.html">Java Virtual Machine Support for Non-Java Languages</a>, <a target="_blank" rel="noopener" href="http://blog.takipi.com/compiling-lambda-expressions-scala-vs-java-8/">compiling-lambda-expressions-scala-vs-java-8</a>，有趣的perl6贡献者的<a target="_blank" rel="noopener" href="http://jnthn.net/papers/2013-bs-invoke-dynamic.pdf">Using invoke dynamic to teach the JVM a new language </a>这些文章有内容过时但值得一看.<br><strong>具体实现如何，可能需要再写文章探讨</strong>。<br><strong>5，关于JNI调用耗时</strong><br>推荐看看<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/7699020/what-makes-jni-calls-slow">what-makes-jni-calls-slow</a>, 其实“慢”，这么说没有意义，要看怎么比，要看具体逻辑。<br>而实际上，使用jni实现和java原生实现相比，理论上导致差距的地方有，因为jni像个黑盒不会內联不会jit优化，crossing boundaries问题，JAVA和native之间交换数据可能需要拷贝（java访问jni的返回／jni访问java对象）<br><a target="_blank" rel="noopener" href="https://www.slideshare.net/RednaxelaFX/green-teajug-hotspotintrinsics02232013">R神的hotspot intrinsics API</a><br><strong>6，privateGetMethodRecursive</strong><br><a target="_blank" rel="noopener" href="http://hg.openjdk.java.net/jdk8/jdk8/jdk/file/687fd7c7986d/src/share/classes/java/lang/Class.java">代码可见Class.java的privateGetMethodRecursive实现</a>, 如果你仔细看了clazz.newInsstance这块，会发现有 <a target="_blank" rel="noopener" href="http://hg.openjdk.java.net/jdk8/jdk8/jdk/file/687fd7c7986d/src/share/classes/java/lang/Class.java#l2464">ReflectionData</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">ReflectionData</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">volatile</span> Field[] declaredFields;</span><br><span class="line">    <span class="keyword">volatile</span> Field[] publicFields;</span><br><span class="line">    <span class="keyword">volatile</span> Method[] declaredMethods;</span><br><span class="line">    <span class="keyword">volatile</span> Method[] publicMethods;</span><br><span class="line">    <span class="keyword">volatile</span> Constructor&lt;T&gt;[] declaredConstructors;</span><br><span class="line">    <span class="keyword">volatile</span> Constructor&lt;T&gt;[] publicConstructors;</span><br><span class="line">    <span class="comment">// Intermediate results for getFields and getMethods</span></span><br><span class="line">    <span class="keyword">volatile</span> Field[] declaredPublicFields;</span><br><span class="line">    <span class="keyword">volatile</span> Method[] declaredPublicMethods;</span><br><span class="line">    <span class="keyword">volatile</span> Class&lt;?&gt;[] interfaces;</span><br><span class="line">    <span class="comment">// Value of classRedefinedCount when we created this ReflectionData instance</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> redefinedCount;</span><br><span class="line">    ReflectionData(<span class="type">int</span> redefinedCount) &#123;</span><br><span class="line">        <span class="built_in">this</span>.redefinedCount = redefinedCount;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里面有 Constructor，在newReflectionData，newInstance都是可关注的地方，这里Constructor的构建，其实也是类似本文Method的逻辑，通过ReflectionFactory.newConstructorAccessor提供了一个基于native的NativeConstructorAccessorImpl实现，而另一个就是同样的基于asm bytecode的MethodAccessorGenerator().generateConstructor实现，但是有一个例外，当。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Bootstrapping issue: since we use Class.newInstance() in</span></span><br><span class="line"><span class="comment">// the ConstructorAccessor generation process, we have to</span></span><br><span class="line"><span class="comment">// break the cycle here.</span></span><br><span class="line"><span class="keyword">if</span> (Reflection.isSubclassOf(declaringClass,</span><br><span class="line">                            ConstructorAccessorImpl.class)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BootstrapConstructorAccessorImpl</span>(c);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>满足上述条件时，返回的是BootstrapConstructorAccessorImpl，而它然后就直接通过 UnsafeFieldAccessorImpl.unsafe.allocateInstance(constructor.getDeclaringClass())来newInstance的。<br><strong>7, <span id="generatedMethodAccessor1">GeneratedMethodAccessor1.class</span></strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">public java.lang.Object invoke(java.lang.Object, java.lang.Object[]) throws java.lang.reflect.InvocationTargetException;</span><br><span class="line">  descriptor: (Ljava/lang/Object;[Ljava/lang/Object;)Ljava/lang/Object;</span><br><span class="line">  flags: ACC_PUBLIC</span><br><span class="line">  Code:</span><br><span class="line">    stack=5, locals=3, args_size=3</span><br><span class="line">       0: aload_1</span><br><span class="line">       1: ifnonnull     12</span><br><span class="line">       4: new           #20                 // class java/lang/NullPointerException</span><br><span class="line">       7: dup</span><br><span class="line">       8: invokespecial #28                 // Method java/lang/NullPointerException.&quot;&lt;init&gt;&quot;:()V</span><br><span class="line">      11: athrow</span><br><span class="line">      12: aload_1</span><br><span class="line">      13: checkcast     #6                  // class X</span><br><span class="line">      16: aload_2</span><br><span class="line">      17: arraylength</span><br><span class="line">      18: sipush        1</span><br><span class="line">      21: if_icmpeq     32</span><br><span class="line">      24: new           #22                 // class java/lang/IllegalArgumentException</span><br><span class="line">      27: dup</span><br><span class="line">      28: invokespecial #29                 // Method java/lang/IllegalArgumentException.&quot;&lt;init&gt;&quot;:()V</span><br><span class="line">      31: athrow</span><br><span class="line">      32: aload_2</span><br><span class="line">      33: sipush        0</span><br><span class="line">      36: aaload</span><br><span class="line">      37: checkcast     #14                 // class java/lang/String</span><br><span class="line">      40: invokevirtual #10                 // Method X.hot:(Ljava/lang/String;)V</span><br><span class="line">      43: aconst_null</span><br><span class="line">      44: areturn</span><br><span class="line">      45: invokespecial #42                 // Method java/lang/Object.toString:()Ljava/lang/String;</span><br><span class="line">      48: new           #22                 // class java/lang/IllegalArgumentException</span><br><span class="line">      51: dup_x1</span><br><span class="line">      52: swap</span><br><span class="line">      53: invokespecial #32                 // Method java/lang/IllegalArgumentException.&quot;&lt;init&gt;&quot;:(Ljava/lang/String;)V</span><br><span class="line">      56: athrow</span><br><span class="line">      57: new           #24                 // class java/lang/reflect/InvocationTargetException</span><br><span class="line">      60: dup_x1</span><br><span class="line">      61: swap</span><br><span class="line">      62: invokespecial #35                 // Method java/lang/reflect/InvocationTargetException.&quot;&lt;init&gt;&quot;:(Ljava/lang/Throwable;)V</span><br><span class="line">      65: athrow</span><br></pre></td></tr></table></figure>
<p><strong>8，</strong> JAVA StackTrace方法的性能可以参考 stackoverflow的一个问答<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/421280/how-do-i-find-the-caller-of-a-method-using-stacktrace-or-reflection">how-do-i-find-the-caller-of-a-method-using-stacktrace-or-reflection</a></p>
<h1 id="11-引用"><a href="#11-引用" class="headerlink" title="11. 引用"></a>11. 引用</h1><ol>
<li><a target="_blank" rel="noopener" href="http://rednaxelafx.iteye.com/blog/548536">关于反射调用方法的一个log</a>, <strong>RednaxelaFX</strong>, 也就是国内已知公认JVM专家R大，也即许多ppt作者为 莫枢得，写过一篇文章讨论了这个问题</li>
<li>关于Java Flame，这里列出几篇参考文章：</li>
</ol>
<ul>
<li>2.1<br>  Brendan Gregg大牛写过 使用google 的<a target="_blank" rel="noopener" href="http://www.brendangregg.com/blog/2014-06-12/java-flame-graphs.html">Lightweight Java Profiler</a>结合其<a target="_blank" rel="noopener" href="https://github.com/brendangregg/FlameGraph">火焰图工具FlameGraph</a>如何制作java火焰图的文章，比如里面也可以使用 Richard Warburton开发的<a target="_blank" rel="noopener" href="https://github.com/RichardWarburton/honest-profiler">honest-profiler</a>来采样。</li>
<li>2.2<br>  Brendan Gregg在后来的文章里更新了使用Linux perf_events来一起显示Java和系统代码<a target="_blank" rel="noopener" href="http://www.brendangregg.com/FlameGraphs/cpuflamegraphs.html#Java">cpuflamegraphs</a>，<a target="_blank" rel="noopener" href="https://medium.com/netflix-techblog/java-in-flames-e763b3d32166">netflix java-in-flames</a>, 不过有一种适用旧版本不影响性能的<a target="_blank" rel="noopener" href="https://github.com/jvm-profiling-tools/async-profiler">基于AsyncGetCallTrace + perf_events的采样方式</a>, 但 AsyncGetCallTrace is not an official API to the JVM。</li>
<li>2.3<br>  有人使用hprof作cpu采样，但是 正如2.1 java-flame-graphs提到的 <a target="_blank" rel="noopener" href="http://www.brendangregg.com/blog/2014-06-09/java-cpu-sampling-using-hprof.html">这篇文章</a> 做了指正。</li>
<li>2.4<br>  有最新的一篇文章介绍了 <a target="_blank" rel="noopener" href="http://www.brendangregg.com/blog/2017-06-30/package-flame-graph.html">Java Package Flame Graph</a>并引出了<a target="_blank" rel="noopener" href="http://www.brendangregg.com/FlameGraphs/cpuflamegraphs.html#Java">CPU Flame Graphs</a></li>
<li>2.5<br>  上述在<a target="_blank" rel="noopener" href="http://www.brendangregg.com/flamegraphs.html#Updates">updates</a>都可以找到, Brendan Gregg的flamegraphs更新页面，几乎记录了优质的跟flamegraphs有关的链接。</li>
</ul>
<ol start="3">
<li><a target="_blank" rel="noopener" href="http://www.brendangregg.com/linuxperf.html">Brendan Gregg的站点，记录了些高效的Linux性能工具</a></li>
<li>两篇不错的文章 <a target="_blank" rel="noopener" href="http://psy-lob-saw.blogspot.co.za/2017/02/flamegraphs-intro-fire-for-everyone.html">flamegraphs-intro-fire-for-everyone</a>,<a target="_blank" rel="noopener" href="http://psy-lob-saw.blogspot.co.za/2016/06/the-pros-and-cons-of-agct.html">The Pros and Cons of AsyncGetCallTrace Profilers</a></li>
<li>几个常用参考页面：<br>  Oracle官方的 <a target="_blank" rel="noopener" href="http://www.oracle.com/technetwork/articles/java/vmoptions-jsp-140102.html">Java HotSpot VM Options</a>, <a target="_blank" rel="noopener" href="http://www.cnblogs.com/redcreen/archive/2011/05/04/2037057.html">VM参数中文版，有些已过期</a><br>  Oracle官方的 <a target="_blank" rel="noopener" href="http://docs.oracle.com/javase/8/docs/technotes/tools/windows/java.html">JAVA Options</a>，R大的 [JVM调优的”标准参数”的各种陷阱]](<a target="_blank" rel="noopener" href="http://hllvm.group.iteye.com/group/topic/27945),%E5%8F%AF%E4%BB%A5%E5%8F%82%E8%80%83HotSpot">http://hllvm.group.iteye.com/group/topic/27945),可以参考HotSpot</a> VM里的各个globals.hpp文件</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://thomaslau.github.io/2017/07/25/2017-07-25-from_noInflation_to_Java_Method_invoke/" data-id="cm7c6vn34000tuexa7lulhg24" data-title="从noInflation看Java Method.invoke" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JAVA-Flame-Graph/" rel="tag">JAVA Flame Graph</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JMH/" rel="tag">JMH</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JVM/" rel="tag">JVM</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java/" rel="tag">Java</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2017/07/31/2017-07-31-Blogs_2017_07_31/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Blogs_20170731
        
      </div>
    </a>
  
  
    <a href="/2017/06/19/2017-06-19-from_Monte_Carlo_to_pySpark_fork_Bug/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">从Monte Carlo谈pySpark的fork引发的Bug</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/17monipdb/" rel="tag">17monipdb</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/B-Tree/" rel="tag">B Tree</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/BigData/" rel="tag">BigData</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/BlogDigests/" rel="tag">BlogDigests</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CAS-SSO/" rel="tag">CAS SSO</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Chrome/" rel="tag">Chrome</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Consistent-Hashing/" rel="tag">Consistent Hashing</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Eclipse/" rel="tag">Eclipse</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Elasticsearch/" rel="tag">Elasticsearch</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HashTable/" rel="tag">HashTable</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hyperloglog/" rel="tag">Hyperloglog</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JAVA-Flame-Graph/" rel="tag">JAVA Flame Graph</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JIT/" rel="tag">JIT</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JMH/" rel="tag">JMH</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JPG-DCT/" rel="tag">JPG&#x2F;DCT</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JS/" rel="tag">JS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JVM/" rel="tag">JVM</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/" rel="tag">Java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Leaky/" rel="tag">Leaky</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Life/" rel="tag">Life</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Lucene/" rel="tag">Lucene</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ML/" rel="tag">ML</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Maven/" rel="tag">Maven</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Minhash/" rel="tag">Minhash</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Monte-Carlo/" rel="tag">Monte Carlo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MySQL/" rel="tag">MySQL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Nginx/" rel="tag">Nginx</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Object-hashCode/" rel="tag">Object.hashCode</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Python/" rel="tag">Python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Redis/" rel="tag">Redis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RedisCluster/" rel="tag">RedisCluster</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RedisLua/" rel="tag">RedisLua</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Security/" rel="tag">Security</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SimHash/" rel="tag">SimHash</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spark/" rel="tag">Spark</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SpringCloud/" rel="tag">SpringCloud</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SpringSecurity/" rel="tag">SpringSecurity</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Tech/" rel="tag">Tech</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TextSimilarity/" rel="tag">TextSimilarity</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Thoughts/" rel="tag">Thoughts</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Tools/" rel="tag">Tools</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/antirez/" rel="tag">antirez</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/architecture/" rel="tag">architecture</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/bloomfilter/" rel="tag">bloomfilter</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/elasticsearch/" rel="tag">elasticsearch</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/geohash/" rel="tag">geohash</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/guava/" rel="tag">guava</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/guava-ratelimiter/" rel="tag">guava ratelimiter</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hash/" rel="tag">hash</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kafka/" rel="tag">kafka</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/life/" rel="tag">life</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pHash-dHash/" rel="tag">pHash&#x2F;dHash</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/performance/" rel="tag">performance</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ratelimiter/" rel="tag">ratelimiter</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/redis/" rel="tag">redis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/roaringbitmap/" rel="tag">roaringbitmap</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sql-count/" rel="tag">sql.count</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/twitter/" rel="tag">twitter</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/unix-Epoch/" rel="tag">unix Epoch</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/weeklyreading/" rel="tag">weeklyreading</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/yearly/" rel="tag">yearly</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%B8%AD%E5%8F%B0/" rel="tag">中台</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%A2%8E%E8%A8%80%E7%A2%8E%E8%AF%AD/" rel="tag">碎言碎语</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%97%B0%E7%A7%92/" rel="tag">闰秒</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9A%8F%E6%84%9F/" rel="tag">随感</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/17monipdb/" style="font-size: 10px;">17monipdb</a> <a href="/tags/B-Tree/" style="font-size: 10px;">B Tree</a> <a href="/tags/BigData/" style="font-size: 10px;">BigData</a> <a href="/tags/BlogDigests/" style="font-size: 10px;">BlogDigests</a> <a href="/tags/CAS-SSO/" style="font-size: 10px;">CAS SSO</a> <a href="/tags/Chrome/" style="font-size: 10px;">Chrome</a> <a href="/tags/Consistent-Hashing/" style="font-size: 10px;">Consistent Hashing</a> <a href="/tags/Eclipse/" style="font-size: 10px;">Eclipse</a> <a href="/tags/Elasticsearch/" style="font-size: 14px;">Elasticsearch</a> <a href="/tags/HashTable/" style="font-size: 10px;">HashTable</a> <a href="/tags/Hyperloglog/" style="font-size: 10px;">Hyperloglog</a> <a href="/tags/JAVA-Flame-Graph/" style="font-size: 10px;">JAVA Flame Graph</a> <a href="/tags/JIT/" style="font-size: 10px;">JIT</a> <a href="/tags/JMH/" style="font-size: 10px;">JMH</a> <a href="/tags/JPG-DCT/" style="font-size: 10px;">JPG/DCT</a> <a href="/tags/JS/" style="font-size: 10px;">JS</a> <a href="/tags/JVM/" style="font-size: 12px;">JVM</a> <a href="/tags/Java/" style="font-size: 10px;">Java</a> <a href="/tags/Leaky/" style="font-size: 10px;">Leaky</a> <a href="/tags/Life/" style="font-size: 16px;">Life</a> <a href="/tags/Lucene/" style="font-size: 12px;">Lucene</a> <a href="/tags/ML/" style="font-size: 12px;">ML</a> <a href="/tags/Maven/" style="font-size: 10px;">Maven</a> <a href="/tags/Minhash/" style="font-size: 10px;">Minhash</a> <a href="/tags/Monte-Carlo/" style="font-size: 10px;">Monte Carlo</a> <a href="/tags/MySQL/" style="font-size: 10px;">MySQL</a> <a href="/tags/Nginx/" style="font-size: 12px;">Nginx</a> <a href="/tags/Object-hashCode/" style="font-size: 10px;">Object.hashCode</a> <a href="/tags/Python/" style="font-size: 10px;">Python</a> <a href="/tags/Redis/" style="font-size: 12px;">Redis</a> <a href="/tags/RedisCluster/" style="font-size: 10px;">RedisCluster</a> <a href="/tags/RedisLua/" style="font-size: 10px;">RedisLua</a> <a href="/tags/Security/" style="font-size: 12px;">Security</a> <a href="/tags/SimHash/" style="font-size: 10px;">SimHash</a> <a href="/tags/Spark/" style="font-size: 10px;">Spark</a> <a href="/tags/SpringCloud/" style="font-size: 10px;">SpringCloud</a> <a href="/tags/SpringSecurity/" style="font-size: 10px;">SpringSecurity</a> <a href="/tags/Tech/" style="font-size: 20px;">Tech</a> <a href="/tags/TextSimilarity/" style="font-size: 10px;">TextSimilarity</a> <a href="/tags/Thoughts/" style="font-size: 10px;">Thoughts</a> <a href="/tags/Tools/" style="font-size: 14px;">Tools</a> <a href="/tags/antirez/" style="font-size: 12px;">antirez</a> <a href="/tags/architecture/" style="font-size: 12px;">architecture</a> <a href="/tags/bloomfilter/" style="font-size: 10px;">bloomfilter</a> <a href="/tags/elasticsearch/" style="font-size: 12px;">elasticsearch</a> <a href="/tags/geohash/" style="font-size: 10px;">geohash</a> <a href="/tags/guava/" style="font-size: 10px;">guava</a> <a href="/tags/guava-ratelimiter/" style="font-size: 10px;">guava ratelimiter</a> <a href="/tags/hash/" style="font-size: 10px;">hash</a> <a href="/tags/kafka/" style="font-size: 12px;">kafka</a> <a href="/tags/life/" style="font-size: 12px;">life</a> <a href="/tags/pHash-dHash/" style="font-size: 10px;">pHash/dHash</a> <a href="/tags/performance/" style="font-size: 10px;">performance</a> <a href="/tags/ratelimiter/" style="font-size: 12px;">ratelimiter</a> <a href="/tags/redis/" style="font-size: 10px;">redis</a> <a href="/tags/roaringbitmap/" style="font-size: 10px;">roaringbitmap</a> <a href="/tags/sql-count/" style="font-size: 10px;">sql.count</a> <a href="/tags/twitter/" style="font-size: 10px;">twitter</a> <a href="/tags/unix-Epoch/" style="font-size: 10px;">unix Epoch</a> <a href="/tags/weeklyreading/" style="font-size: 18px;">weeklyreading</a> <a href="/tags/yearly/" style="font-size: 10px;">yearly</a> <a href="/tags/%E4%B8%AD%E5%8F%B0/" style="font-size: 10px;">中台</a> <a href="/tags/%E7%A2%8E%E8%A8%80%E7%A2%8E%E8%AF%AD/" style="font-size: 10px;">碎言碎语</a> <a href="/tags/%E9%97%B0%E7%A7%92/" style="font-size: 10px;">闰秒</a> <a href="/tags/%E9%9A%8F%E6%84%9F/" style="font-size: 12px;">随感</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/02/">February 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/01/">January 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">November 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">September 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">August 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">June 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">May 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">January 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">November 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">October 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">August 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">July 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">June 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">May 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">March 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">September 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">August 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">July 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">June 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/07/">July 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/03/">March 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/02/">February 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/01/">January 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/12/">December 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/11/">November 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/10/">October 2014</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2025/02/14/2025-02-14-on_computor_time/">计算机时间捡拾</a>
          </li>
        
          <li>
            <a href="/2025/01/02/2025-01-02-on_text_similarity/">如何做好网文段落匹配</a>
          </li>
        
          <li>
            <a href="/2020/11/10/2020-11-10-on_chain_of_trust/">软件研发中的信任链问题</a>
          </li>
        
          <li>
            <a href="/2020/10/23/2020-10-23-on_middle_platform/">什么是中台</a>
          </li>
        
          <li>
            <a href="/2020/09/21/2020-09-21-on_consistent_hash/">正确理解一致性哈希</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2025 Thomas Lau<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>