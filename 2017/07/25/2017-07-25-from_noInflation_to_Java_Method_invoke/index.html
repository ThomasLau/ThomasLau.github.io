<!doctype html>




<html class="theme-next mist" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="JVM,Java,JAVA Flame Graph,JMH," />





  <link rel="alternate" href="/atom.xml" title="e+Thomas" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon32.ico?v=5.1.1" />






<meta name="description" content="旧文，现重新整理下： 1. 缘起最近有同事发来如下一段异常，程序已开始运行正常，只是很快就会莫名其妙的抛这个异常，不知道如何着手解决:12345678910111213141516Exception in thread &quot;main&quot; java.lang.NoClassDefFoundError: sun/reflect/ConstructorAccessorImpl    at sun.misc.">
<meta name="keywords" content="JVM,Java,JAVA Flame Graph,JMH">
<meta property="og:type" content="article">
<meta property="og:title" content="从noInflation看Java Method.invoke">
<meta property="og:url" content="http://thomaslau.github.io/2017/07/25/2017-07-25-from_noInflation_to_Java_Method_invoke/index.html">
<meta property="og:site_name" content="e+Thomas">
<meta property="og:description" content="旧文，现重新整理下： 1. 缘起最近有同事发来如下一段异常，程序已开始运行正常，只是很快就会莫名其妙的抛这个异常，不知道如何着手解决:12345678910111213141516Exception in thread &quot;main&quot; java.lang.NoClassDefFoundError: sun/reflect/ConstructorAccessorImpl    at sun.misc.">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://thomaslau.github.io/images/flamegraph.png">
<meta property="og:image" content="http://thomaslau.github.io/images/flamegraph_native.png">
<meta property="og:updated_time" content="2017-07-28T13:31:33.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="从noInflation看Java Method.invoke">
<meta name="twitter:description" content="旧文，现重新整理下： 1. 缘起最近有同事发来如下一段异常，程序已开始运行正常，只是很快就会莫名其妙的抛这个异常，不知道如何着手解决:12345678910111213141516Exception in thread &quot;main&quot; java.lang.NoClassDefFoundError: sun/reflect/ConstructorAccessorImpl    at sun.misc.">
<meta name="twitter:image" content="http://thomaslau.github.io/images/flamegraph.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"hide","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: false,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://thomaslau.github.io/2017/07/25/2017-07-25-from_noInflation_to_Java_Method_invoke/"/>





  <title>从noInflation看Java Method.invoke | e+Thomas</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?22bda74eb54c0d90672fd5c06458004c";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>










</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">e+Thomas</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://thomaslau.github.io/2017/07/25/2017-07-25-from_noInflation_to_Java_Method_invoke/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Thomas Lau">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/myLogo.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="e+Thomas">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">从noInflation看Java Method.invoke</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-25T21:01:07+08:00">
                2017-07-25
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>旧文，现重新整理下：</p>
<h1 id="1-缘起"><a href="#1-缘起" class="headerlink" title="1. 缘起"></a>1. 缘起</h1><p>最近有同事发来如下一段异常，程序已开始运行正常，只是很快就会莫名其妙的抛这个异常，不知道如何着手解决:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">Exception <span class="keyword">in</span> thread <span class="string">"main"</span> java.lang.NoClassDefFoundError: sun/reflect/ConstructorAccessorImpl</div><div class="line">    at sun.misc.Unsafe.defineClass(Native Method)</div><div class="line">    at sun.reflect.ClassDefiner.defineClass(ClassDefiner.java:63)</div><div class="line">    at sun.reflect.MethodAccessorGenerator<span class="variable">$1</span>.run(MethodAccessorGenerator.java:399)</div><div class="line">    at sun.reflect.MethodAccessorGenerator<span class="variable">$1</span>.run(MethodAccessorGenerator.java:394)</div><div class="line">    at java.security.AccessController.doPrivileged(Native Method)</div><div class="line">    at sun.reflect.MethodAccessorGenerator.generate(MethodAccessorGenerator.java:393)</div><div class="line">    at sun.reflect.MethodAccessorGenerator.generateConstructor(MethodAccessorGenerator.java:92)</div><div class="line">    at sun.reflect.NativeConstructorAccessorImpl.newInstance(NativeConstructorAccessorImpl.java:55)</div><div class="line">    at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45)</div><div class="line">    at java.lang.reflect.Constructor.newInstance(Constructor.java:423)</div><div class="line">    at java.lang.Class.newInstance(Class.java:442)</div><div class="line">    at com.thomas.classloader.unload.MonitorHotSwap.main(MonitorHotSwap.java:34)</div><div class="line">Caused by: java.lang.ClassNotFoundException: sun.reflect.ConstructorAccessorImpl</div><div class="line">    at java.net.URLClassLoader.findClass(URLClassLoader.java:381)</div><div class="line">    ...</div></pre></td></tr></table></figure></p>
<p>我把他的代码稍作简化，主要部分是类似下面的逻辑，功能是程序监控某几个文件的变动，发现符合条件就会编译并会重新加载class，<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HotSwapURLClassLoader</span> <span class="keyword">extends</span> <span class="title">URLClassLoader</span> </span>&#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> Class&lt;?&gt; loadClass(String name, <span class="keyword">boolean</span> resolve) <span class="keyword">throws</span> ClassNotFoundException &#123;</div><div class="line">        Class&lt;?&gt; clazz = <span class="keyword">null</span>;</div><div class="line">        clazz = findLoadedClass(name);</div><div class="line">        <span class="keyword">if</span> (clazz != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="comment">//...一段热替换逻辑</span></div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (name.startsWith(<span class="string">"java."</span>)) &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                ClassLoader system = ClassLoader.getSystemClassLoader();</div><div class="line">                clazz = system.loadClass(name);</div><div class="line">                <span class="keyword">if</span> (clazz != <span class="keyword">null</span>) &#123;</div><div class="line">                    <span class="keyword">if</span> (resolve)</div><div class="line">                        resolveClass(clazz);</div><div class="line">                    <span class="keyword">return</span> (clazz);</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</div><div class="line">                <span class="comment">// Ignore</span></div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> customLoad(name, <span class="keyword">this</span>);</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">&#125;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">X</span> </span>&#123;</div><div class="line">    ...</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">hot</span><span class="params">(String msg)</span> </span>&#123;</div><div class="line">        <span class="comment">//System.out.println(String.format("ver:%s, classLoader: %s.", ver, this.getClass().getClassLoader()));</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>上面的异常，不同于常遇到的异常，我们根据异常栈逆推可能不会很容易的定位到root cause。所以我在hot方法加了一条日志信息，即注释打开，运行多次，发现每次都是<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">ver:15, classLoader: com.thomas.unload.HotSwapURLClassLoader@4e25154f.</div><div class="line">Exception <span class="keyword">in</span> thread <span class="string">"main"</span> java.lang.NoClassDefFoundError: sun/reflect/ConstructorAccessorImpl</div></pre></td></tr></table></figure></p>
<p>这让我想起了JVM参数有inflationThreshold=15<br><a id="more"></a></p>
<h1 id="2-复现"><a href="#2-复现" class="headerlink" title="2. 复现"></a>2. 复现</h1><p><span id="Appcode">我们可以通过下面demo来深入问题，运行时候加入 -verbose或者 -XX:+TraceClassLoading 参数：</span><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        <span class="keyword">int</span> size = args.length &gt; <span class="number">0</span> ? Integer.valueOf(args[<span class="number">0</span>]) : <span class="number">1_000_000</span>;</div><div class="line">        Class&lt;?&gt; clz = Class.forName(<span class="string">"X"</span>);</div><div class="line">        Object o = clz.newInstance();</div><div class="line">        Method m = clz.getMethod(<span class="string">"hot"</span>, String.class);</div><div class="line">        Thread.sleep(<span class="number">20_000</span>);</div><div class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="number">500</span>; i++) &#123;</div><div class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>; j&lt;size; j++)&#123;  </div><div class="line">               m.invoke(o, <span class="string">"hello"</span>+i);</div><div class="line">            &#125;</div><div class="line">            Thread.sleep(<span class="number">50</span>);</div><div class="line">        &#125;</div><div class="line">        System.out.println(<span class="string">"---finish loop----"</span>);</div><div class="line">        Thread.sleep(<span class="number">20_000</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们可以看到输出<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line">[Loaded sun.reflect.DelegatingMethodAccessorImpl from /Library/Java/JavaVirtualMachines/jdk1.8.0_102.jdk/Contents/Home/jre/lib/rt.jar]</div><div class="line">Hello, hello0</div><div class="line">...</div><div class="line">Hello, hello14</div><div class="line">[Loaded sun.reflect.ClassFileConstants from /Library/Java/JavaVirtualMachines/jdk1.8.0_102.jdk/Contents/Home/jre/lib/rt.jar]</div><div class="line">[Loaded sun.reflect.AccessorGenerator from /Library/Java/JavaVirtualMachines/jdk1.8.0_102.jdk/Contents/Home/jre/lib/rt.jar]</div><div class="line">[Loaded sun.reflect.MethodAccessorGenerator from /Library/Java/JavaVirtualMachines/jdk1.8.0_102.jdk/Contents/Home/jre/lib/rt.jar]</div><div class="line">[Loaded sun.reflect.ByteVectorFactory from /Library/Java/JavaVirtualMachines/jdk1.8.0_102.jdk/Contents/Home/jre/lib/rt.jar]</div><div class="line">[Loaded sun.reflect.ByteVector from /Library/Java/JavaVirtualMachines/jdk1.8.0_102.jdk/Contents/Home/jre/lib/rt.jar]</div><div class="line">[Loaded sun.reflect.ByteVectorImpl from /Library/Java/JavaVirtualMachines/jdk1.8.0_102.jdk/Contents/Home/jre/lib/rt.jar]</div><div class="line">[Loaded sun.reflect.ClassFileAssembler from /Library/Java/JavaVirtualMachines/jdk1.8.0_102.jdk/Contents/Home/jre/lib/rt.jar]</div><div class="line">[Loaded sun.reflect.UTF8 from /Library/Java/JavaVirtualMachines/jdk1.8.0_102.jdk/Contents/Home/jre/lib/rt.jar]</div><div class="line">[Loaded sun.reflect.Label from /Library/Java/JavaVirtualMachines/jdk1.8.0_102.jdk/Contents/Home/jre/lib/rt.jar]</div><div class="line">[Loaded sun.reflect.Label<span class="variable">$PatchInfo</span> from /Library/Java/JavaVirtualMachines/jdk1.8.0_102.jdk/Contents/Home/jre/lib/rt.jar]</div><div class="line">[Loaded java.util.ArrayList<span class="variable">$Itr</span> from /Library/Java/JavaVirtualMachines/jdk1.8.0_102.jdk/Contents/Home/jre/lib/rt.jar]</div><div class="line">[Loaded sun.reflect.MethodAccessorGenerator<span class="variable">$1</span> from /Library/Java/JavaVirtualMachines/jdk1.8.0_102.jdk/Contents/Home/jre/lib/rt.jar]</div><div class="line">[Loaded sun.reflect.ClassDefiner from /Library/Java/JavaVirtualMachines/jdk1.8.0_102.jdk/Contents/Home/jre/lib/rt.jar]</div><div class="line">[Loaded sun.reflect.ClassDefiner<span class="variable">$1</span> from /Library/Java/JavaVirtualMachines/jdk1.8.0_102.jdk/Contents/Home/jre/lib/rt.jar]</div><div class="line">[Loaded sun.reflect.GeneratedMethodAccessor1 from __JVM_DefineClass__]</div><div class="line">Hello, hello15</div><div class="line">Hello, hello16</div><div class="line">Hello, hello17</div><div class="line">[Loaded java.lang.Shutdown from /Library/Java/JavaVirtualMachines/jdk1.8.0_102.jdk/Contents/Home/jre/lib/rt.jar]</div><div class="line">[Loaded java.lang.Shutdown<span class="variable">$Lock</span> from /Library/Java/JavaVirtualMachines/jdk1.8.0_102.jdk/Contents/Home/jre/lib/rt.jar]</div></pre></td></tr></table></figure></p>
<p>注意到最开始load的是DelegatingMethodAccessorImpl 可是到第15次执行该方法的时候就开始load MethodAccessorGenerator -&gt; sun.reflect.GeneratedMethodAccessor1了, 前面都是from jre/lib/rt.jar的，而 GeneratedMethodAccessor1 from __JVM_DefineClass__，那么这个类是怎么generate出来的呢？<br>让我们从Method源码开始吧.</p>
<h1 id="3-Class-getMethod"><a href="#3-Class-getMethod" class="headerlink" title="3. Class.getMethod"></a>3. Class.getMethod</h1><p>先看Method的获取，clazz.getMethod获取public方法，这里也可以使用getDeclaredMethod，后者可以获取declared[含private／protect／public]的方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@CallerSensitive</span></div><div class="line"><span class="function"><span class="keyword">public</span> Method <span class="title">getMethod</span><span class="params">(String name, Class&lt;?&gt;... parameterTypes)</span></span></div><div class="line">    <span class="keyword">throws</span> NoSuchMethodException, SecurityException &#123;</div><div class="line">    checkMemberAccess(Member.PUBLIC, Reflection.getCallerClass(), <span class="keyword">true</span>);</div><div class="line">    Method method = getMethod0(name, parameterTypes, <span class="keyword">true</span>);</div><div class="line">    <span class="keyword">if</span> (method == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NoSuchMethodException(getName() + <span class="string">"."</span> + name + argumentTypesToString(parameterTypes));</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> method;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">checkMemberAccess</span><span class="params">(<span class="keyword">int</span> which, Class&lt;?&gt; caller, <span class="keyword">boolean</span> checkProxyInterfaces)</span> </span>&#123;</div><div class="line">    <span class="keyword">final</span> SecurityManager s = System.getSecurityManager();</div><div class="line">    <span class="keyword">if</span> (s != <span class="keyword">null</span>) &#123;</div><div class="line">        ...</div><div class="line">        <span class="keyword">final</span> ClassLoader ccl = ClassLoader.getClassLoader(caller);</div><div class="line">        <span class="keyword">final</span> ClassLoader cl = getClassLoader0();</div><div class="line">        <span class="keyword">if</span> (which != Member.PUBLIC) &#123;</div><div class="line">            <span class="keyword">if</span> (ccl != cl) &#123;</div><div class="line">                s.checkPermission(SecurityConstants.CHECK_MEMBER_ACCESS_PERMISSION);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">this</span>.checkPackageAccess(ccl, checkProxyInterfaces);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>上述，Reflection.getCallerClass()实现是一个native方法，用于获取调用这个方法的Class对象，完整源码见sun/reflect/Reflection.c, 实现最后在<a href="http://hg.openjdk.java.net/jdk8/jdk8/hotspot/file/87ee5ee27509/src/share/vm/prims/jvm.cpp#l668" target="_blank" rel="external">jvm.cpp</a>, 这个Reflection.getCallerClass获取栈帧调用者要比我们平时使用Throwable／thread stackTrace／SecurityManager的getClassContext()都要高效，只是1.8抛弃了，目前是JDK内部使用的方法, 而且该方法有CallerSensitive注解。<br>程序通过forname，即1.8中，forName0(className, true, ClassLoader.getClassLoader(caller), caller) 是通过caller class的classloader加载类，然后调用getMethod，即最终通过<br>privateGetMethodRecursive，即其实是依赖 searchMethods(privateGetDeclaredMethods(true)，从缓存或JVM中获取该Class中的方法列表，searchMethods则用于从返回的方法列表里找到一个匹配的对象，该对象名称和参数的方法匹配。<br>forname和getMethod具体写起来也很长，但为了不影响本文主题，不深入探讨。<br>下面，让我们进入正题。</p>
<h1 id="4-MethodAccessor-vs-ReflectionFactory"><a href="#4-MethodAccessor-vs-ReflectionFactory" class="headerlink" title="4. MethodAccessor vs ReflectionFactory"></a>4. MethodAccessor vs ReflectionFactory</h1><p>使用JAVA版本：java version “1.8.0_102”。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Method</span> <span class="keyword">extends</span> <span class="title">Executable</span> </span>&#123;</div><div class="line">    ...</div><div class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> MethodAccessor methodAccessor;</div><div class="line">    <span class="comment">// For sharing of MethodAccessors. This branching structure is</span></div><div class="line">    <span class="comment">// currently only two levels deep (i.e., one root Method and</span></div><div class="line">    <span class="comment">// potentially many Method objects pointing to it.)</span></div><div class="line">    <span class="comment">//</span></div><div class="line">    <span class="comment">// If this branching structure would ever contain cycles, deadlocks can</span></div><div class="line">    <span class="comment">// occur in annotation code.</span></div><div class="line">    <span class="keyword">private</span> Method              root;</div><div class="line">    <span class="meta">@CallerSensitive</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object obj, Object... args)</span></span></div><div class="line">        <span class="keyword">throws</span> IllegalAccessException, IllegalArgumentException,</div><div class="line">           InvocationTargetException</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">if</span> (!override) &#123;</div><div class="line">            <span class="keyword">if</span> (!Reflection.quickCheckMemberAccess(clazz, modifiers)) &#123;</div><div class="line">                Class&lt;?&gt; caller = Reflection.getCallerClass();</div><div class="line">                checkAccess(caller, clazz, obj, modifiers);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        MethodAccessor ma = methodAccessor;             <span class="comment">// read volatile</span></div><div class="line">        <span class="keyword">if</span> (ma == <span class="keyword">null</span>) &#123;</div><div class="line">            ma = acquireMethodAccessor();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> ma.invoke(obj, args);</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">private</span> MethodAccessor <span class="title">acquireMethodAccessor</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">// First check to see if one has been created yet, and take it</span></div><div class="line">        <span class="comment">// if so</span></div><div class="line">        MethodAccessor tmp = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">if</span> (root != <span class="keyword">null</span>) tmp = root.getMethodAccessor();</div><div class="line">        <span class="keyword">if</span> (tmp != <span class="keyword">null</span>) &#123;</div><div class="line">            methodAccessor = tmp;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">// Otherwise fabricate one and propagate it up to the root</span></div><div class="line">            tmp = reflectionFactory.newMethodAccessor(<span class="keyword">this</span>);</div><div class="line">            setMethodAccessor(tmp);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> tmp;</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>JAVA1.8里，Method extends Executable，Executable新见于1.8，是一个适用于method和constructor的通用类，里面有一些paramter和anntation等通用function Executable extends AccessibleObject; 有人可能会问 CallerSensitive 是什么用处，<a href="#hello">见这里</a>。<br>可以看到实现MethodAccessor代理实现了Method.invoke, MethodAccessor在首次调用初始化进入acquireMethodAccessor方法中，这里root即为自己，root.getMethodAccessor()为null，所以会有reflectionFactory.newMethodAccessor来new一个。<br>看reflectionFactory.newMethodAccessor(this), 源码位于jdk/src/share/classes/sun/reflect下，<a href="http://hg.openjdk.java.net/jdk8/jdk8/jdk/file/687fd7c7986d/src/share/classes/sun/reflect/ReflectionFactory.java" target="_blank" rel="external">点此在线浏览</a>：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> sun.reflect;</div><div class="line">...</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReflectionFactory</span> </span>&#123;</div><div class="line">    <span class="comment">// "Inflation" mechanism. Loading bytecodes to implement</span></div><div class="line">    <span class="comment">// Method.invoke() and Constructor.newInstance() currently costs</span></div><div class="line">    <span class="comment">// 3-4x more than an invocation via native code for the first</span></div><div class="line">    <span class="comment">// invocation (though subsequent invocations have been benchmarked</span></div><div class="line">    <span class="comment">// to be over 20x faster). Unfortunately this cost increases</span></div><div class="line">    <span class="comment">// startup time for certain applications that use reflection</span></div><div class="line">    <span class="comment">// intensively (but only once per class) to bootstrap themselves.</span></div><div class="line">    <span class="comment">// To avoid this penalty we reuse the existing JVM entry points</span></div><div class="line">    <span class="comment">// for the first few invocations of Methods and Constructors and</span></div><div class="line">    <span class="comment">// then switch to the bytecode-based implementations.</span></div><div class="line">    <span class="comment">//</span></div><div class="line">    <span class="comment">// Package-private to be accessible to NativeMethodAccessorImpl</span></div><div class="line">    <span class="comment">// and NativeConstructorAccessorImpl</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> noInflation        = <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span>     inflationThreshold = <span class="number">15</span>;</div><div class="line">    ...</div><div class="line">    <span class="function"><span class="keyword">public</span> MethodAccessor <span class="title">newMethodAccessor</span><span class="params">(Method method)</span> </span>&#123;</div><div class="line">        checkInitted();</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (noInflation &amp;&amp; !ReflectUtil.isVMAnonymousClass(method.getDeclaringClass())) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> MethodAccessorGenerator().</div><div class="line">                generateMethod(method.getDeclaringClass(),</div><div class="line">                               method.getName(),</div><div class="line">                               method.getParameterTypes(),</div><div class="line">                               method.getReturnType(),</div><div class="line">                               method.getExceptionTypes(),</div><div class="line">                               method.getModifiers());</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            NativeMethodAccessorImpl acc =</div><div class="line">                <span class="keyword">new</span> NativeMethodAccessorImpl(method);</div><div class="line">            DelegatingMethodAccessorImpl res =</div><div class="line">                <span class="keyword">new</span> DelegatingMethodAccessorImpl(acc);</div><div class="line">            acc.setParent(res);</div><div class="line">            <span class="keyword">return</span> res;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="4-1-noInflation"><a href="#4-1-noInflation" class="headerlink" title="4.1 noInflation"></a>4.1 noInflation</h3><p>当noInflation为true，默认false，除非设置 -Dsun.reflect.noInflation=true，则这时由MethodAccessorGenerator生成一个MethodAccessor，具体逻辑跟接下来要讲述的NativeMethodAccessorImpl的一个分支是一样的。</p>
<h3 id="4-2-NativeMethodAccessorImpl"><a href="#4-2-NativeMethodAccessorImpl" class="headerlink" title="4.2 NativeMethodAccessorImpl"></a>4.2 NativeMethodAccessorImpl</h3><p>noInflation为false，则通过new NativeMethodAccessorImpl并将其赋给代理类使用（这里不是很清楚为何代理，猜测可能编码简便，也使得只需通过setDelegate方式解除引用，NativeMethodAccessorImpl可以被回收掉）。<br>让我们看看NativeMethodAccessorImpl的实现<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">NativeMethodAccessorImpl</span> <span class="keyword">extends</span> <span class="title">MethodAccessorImpl</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> Method method;</div><div class="line">    <span class="keyword">private</span> DelegatingMethodAccessorImpl parent;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> numInvocations;</div><div class="line">    NativeMethodAccessorImpl(Method method) &#123;</div><div class="line">        <span class="keyword">this</span>.method = method;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object obj, Object[] args)</span></span></div><div class="line">        <span class="keyword">throws</span> IllegalArgumentException, InvocationTargetException</div><div class="line">    &#123;</div><div class="line">        <span class="comment">// We can't inflate methods belonging to vm-anonymous classes because</span></div><div class="line">        <span class="comment">// that kind of class can't be referred to by name, hence can't be</span></div><div class="line">        <span class="comment">// found from the generated bytecode.</span></div><div class="line">        <span class="keyword">if</span> (++numInvocations &gt; ReflectionFactory.inflationThreshold()</div><div class="line">                &amp;&amp; !ReflectUtil.isVMAnonymousClass(method.getDeclaringClass())) &#123;</div><div class="line">            MethodAccessorImpl acc = (MethodAccessorImpl)</div><div class="line">                <span class="keyword">new</span> MethodAccessorGenerator().</div><div class="line">                    generateMethod(method.getDeclaringClass(),</div><div class="line">                                   method.getName(),</div><div class="line">                                   method.getParameterTypes(),</div><div class="line">                                   method.getReturnType(),</div><div class="line">                                   method.getExceptionTypes(),</div><div class="line">                                   method.getModifiers());</div><div class="line">            parent.setDelegate(acc);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> invoke0(method, obj, args);</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setParent</span><span class="params">(DelegatingMethodAccessorImpl parent)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.parent = parent;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">native</span> Object <span class="title">invoke0</span><span class="params">(Method m, Object obj, Object[] args)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看到当numInvocations超过ReflectionFactory的inflationThreshold(上文ReflectionFactory默认15 )，这时便会通过new MethodAccessorGenerator生成，也就是对应了上文我们说的ReflectionFactory里的noInflation为true的逻辑。</p>
<h3 id="4-3-NativeMethodAccessorImpl-invoke0"><a href="#4-3-NativeMethodAccessorImpl-invoke0" class="headerlink" title="4.3 NativeMethodAccessorImpl.invoke0"></a>4.3 NativeMethodAccessorImpl.invoke0</h3><p>先来看NativeMethodAccessorImpl的invoke0，这是默认的逻辑，即ReflectionFactory提到的<br>    Inflation, Loading bytecodes to implement Method.invoke() and Constructor.newInstance() currently costs 3-4x more than an invocation via native code for the first invocation (though subsequent invocations have been benchmarked to be over 20x faster).<br>java bytecode版本运行快，但是初始化耗时，而native版本启动快，但若长久运行效率不如bytecode版本。<br>在有的文章里说，”调用JNI方法耗时“，如马化腾先生说的，这句话对也不对。因为这句话是没有指明的是耗时的究竟是“调用”这个操作还是“JNI方法”，而且这个“调用”指的是哪些（call，参数校验，java和C的参数／结果转换…）？不过还好平时基本不会用到，所以许多技术交流或者面试这么问这么答对的时候不会有什么大问题。<br>那么究竟是哪个耗时呢？事实上从下面这张火焰图可以明显看出来。</p>
<h1 id="5-JMH-BenchMark"><a href="#5-JMH-BenchMark" class="headerlink" title="5. JMH BenchMark"></a>5. JMH BenchMark</h1><p>MethodAccessorGenerator的代码稍后再做分析，让我们先在此暂停，看一下注释里面提到的二者性能并做一个对比， 这里简化了JMH的日志输出，仅保留VM参数和结果。</p>
<h3 id="5-1-JMH对比结果"><a href="#5-1-JMH对比结果" class="headerlink" title="5.1 JMH对比结果"></a>5.1 JMH对比结果</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># JMH 1.10 (released 776 days ago, please consider updating!)</span></div><div class="line"><span class="comment"># VM invoker: /Library/Java/JavaVirtualMachines/jdk1.8.0_102.jdk/Contents/Home/jre/bin/java</span></div><div class="line"><span class="comment"># VM options: -Djmh.ignoreLock=true -Dsun.reflect.inflationThreshold=180000000</span></div><div class="line"><span class="comment"># Warmup: 1 iterations, 1 s each</span></div><div class="line">...</div><div class="line">Benchmark                                             (size)  Mode  Cnt    Score    Error    Units</div><div class="line">ReflectiveBenchMarkTest.testDirect                   1000000  avgt    3    0.048 ±  0.003    ms/op</div><div class="line">ReflectiveBenchMarkTest.testDirect:·threads.alive    1000000  avgt    3    5.000 ±  0.001  threads</div><div class="line">ReflectiveBenchMarkTest.testDirect:·threads.daemon   1000000  avgt    3    4.000 ±  0.001  threads</div><div class="line">ReflectiveBenchMarkTest.testDirect:·threads.started  1000000  avgt    3    5.000           threads</div><div class="line">ReflectiveBenchMarkTest.testInvoke                   1000000  avgt    3  290.985 ± 73.334    ms/op</div><div class="line">ReflectiveBenchMarkTest.testInvoke:·threads.alive    1000000  avgt    3    5.000 ±  0.001  threads</div><div class="line">ReflectiveBenchMarkTest.testInvoke:·threads.daemon   1000000  avgt    3    4.000 ±  0.001  threads</div><div class="line">ReflectiveBenchMarkTest.testInvoke:·threads.started  1000000  avgt    3    5.000           threads</div><div class="line">------------------</div><div class="line"><span class="comment"># JMH 1.10 (released 776 days ago, please consider updating!)</span></div><div class="line"><span class="comment"># VM invoker: /Library/Java/JavaVirtualMachines/jdk1.8.0_102.jdk/Contents/Home/jre/bin/java</span></div><div class="line"><span class="comment"># VM options: -Djmh.ignoreLock=true -Dsun.reflect.inflationThreshold=1</span></div><div class="line"><span class="comment"># Warmup: 1 iterations, 1 s each</span></div><div class="line">...</div><div class="line">ReflectiveBenchMarkTest.testDirect                      1000000  avgt    3     0.049 ±    0.012    ms/op</div><div class="line">ReflectiveBenchMarkTest.testDirect:·threads.alive       1000000  avgt    3     5.000 ±    0.001  threads</div><div class="line">ReflectiveBenchMarkTest.testDirect:·threads.daemon      1000000  avgt    3     4.000 ±    0.001  threads</div><div class="line">ReflectiveBenchMarkTest.testDirect:·threads.started     1000000  avgt    3     5.000             threads</div><div class="line">ReflectiveBenchMarkTest.testInvoke                      1000000  avgt    3     3.082 ±    1.054    ms/op</div><div class="line">ReflectiveBenchMarkTest.testInvoke:·threads.alive       1000000  avgt    3     5.000 ±    0.001  threads</div><div class="line">ReflectiveBenchMarkTest.testInvoke:·threads.daemon      1000000  avgt    3     4.000 ±    0.001  threads</div><div class="line">ReflectiveBenchMarkTest.testInvoke:·threads.started     1000000  avgt    3     5.000             threads</div></pre></td></tr></table></figure>
<p>在我的 Mac 2.9 GHz Intel Core i5，8 GB 1867 MHz DDR3，使用JMH实测几次下来性能差距还是inflationThreshold=1和80000000差距还是蛮大的，约80倍(1000000次分别290.985ms,3.082ms)，远大于文中提的20X(1000000次分别0.049ms,3.082ms)[或者测试有误？当然也不排除可能是参数较少的缘故]，而优化的invoke与原生的方法访问性能差60倍，但可以计算到，在反射上的耗时是纳秒计的，这在许多业务系统相对而言几乎可以忽略不计的。</p>
<h3 id="5-2-JMH-BenchMark代码"><a href="#5-2-JMH-BenchMark代码" class="headerlink" title="5.2 JMH BenchMark代码"></a>5.2 JMH BenchMark代码</h3><p>（未想到好的测试first invocation 3-4X的方法，故这里只测两种方法性能）<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Warmup</span>(iterations = <span class="number">1</span>, time = <span class="number">1</span>, timeUnit = TimeUnit.SECONDS)</div><div class="line"><span class="meta">@Measurement</span>(iterations = <span class="number">3</span>, time = <span class="number">1</span>, timeUnit = TimeUnit.SECONDS)</div><div class="line"><span class="meta">@Fork</span>(value = <span class="number">1</span>, jvmArgsAppend = &#123; <span class="string">"-Djmh.ignoreLock=true"</span>, <span class="string">"-Dsun.reflect.inflationThreshold=180000000"</span>&#125;)<span class="comment">//"-XX:+TraceClassLoading", </span></div><div class="line"><span class="meta">@BenchmarkMode</span>(Mode.AverageTime)</div><div class="line"><span class="meta">@OutputTimeUnit</span>(TimeUnit.MILLISECONDS)</div><div class="line"><span class="meta">@State</span>(Scope.Benchmark)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReflectiveBenchMarkTest</span> <span class="keyword">extends</span> <span class="title">MethodTest</span> </span>&#123;</div><div class="line">    Method m;</div><div class="line">    Object o;</div><div class="line">    X xx = <span class="keyword">new</span> X();</div><div class="line">    <span class="meta">@Param</span>(&#123; <span class="string">"1000"</span>, <span class="string">"1000000"</span> &#125;)</div><div class="line">    <span class="keyword">int</span> size;</div><div class="line">    <span class="meta">@Setup</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUp</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        Class&lt;?&gt; clz = Class.forName(<span class="string">"org.thomas.chs.X"</span>);</div><div class="line">        o = clz.newInstance();</div><div class="line">        m = clz.getMethod(<span class="string">"hot"</span>, String.class);</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@TearDown</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">tearDown</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Benchmark</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testInvoke</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i++) &#123;</div><div class="line">            m.invoke(o, <span class="string">"hello"</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Benchmark</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testDirect</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i++) &#123;</div><div class="line">            xx.hot(<span class="string">"hello"</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1 id="6-JAVA-Flame-Graph"><a href="#6-JAVA-Flame-Graph" class="headerlink" title="6. JAVA Flame Graph"></a>6. JAVA Flame Graph</h1><p>下面是针对上文的App类做的一个JAVA火焰图，<a href="#Appcode">代码在这</a> 使用 <a href="https://github.com/jvm-profiling-tools/async-profiler" target="_blank" rel="external">https://github.com/jvm-profiling-tools/async-profiler</a> 的profiler, 在CentOS 7系统。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">java -Dsun.reflect.inflationThreshold=10000000 App 10000000</div><div class="line">pgrep java</div><div class="line">./profiler.sh -d 80 -o flamegraph -f /tmp/traces.txt 7760</div><div class="line">../FlameGraph/flamegraph.pl --colors=java /tmp/traces.txt &gt; ../flamegraph.svg</div></pre></td></tr></table></figure></p>
<p><img src="/images/flamegraph.png" width="100%"><br>由于blog不支持插入svg，可以点击 <a href="/images/flamegraph.svg" target="_blank">这里看svg原件</a>, 上面看各个方法的CPU采样会很清楚。<br>上面采样基于nflationThreshold=10_000_000, 上图可以看到sun/Freflect/DelegatingMethodAccessorImpl.invoke上方被分成了GeneratedMethodAccessor1和NativeMethodAccessorImpl两部分, 并且他们的耗时比还是很明显的3:1，但其实程序在NativeMethodAccessorImpl循环一次，GeneratedMethodAccessor1循环499次。</p>
<h1 id="7-GeneratedMethodAccessor1是什么？"><a href="#7-GeneratedMethodAccessor1是什么？" class="headerlink" title="7. GeneratedMethodAccessor1是什么？"></a>7. GeneratedMethodAccessor1是什么？</h1><h3 id="7-1-GeneratedMethodAccessor1的生成"><a href="#7-1-GeneratedMethodAccessor1的生成" class="headerlink" title="7.1 GeneratedMethodAccessor1的生成"></a>7.1 GeneratedMethodAccessor1的生成</h3><p>那么GeneratedMethodAccessor1到底是什么？这要看这里通过ASM生成的字节码了。<br>可以<a href="http://hg.openjdk.java.net/jdk8/jdk8/jdk/file/687fd7c7986d/src/share/classes/sun/reflect/MethodAccessorGenerator.java#l124" target="_blank" rel="external">在线浏览代码MethodAccessorGenerator</a>，这里只贴出部分：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/** This routine is not thread-safe */</span></div><div class="line"><span class="function"><span class="keyword">private</span> MagicAccessorImpl <span class="title">generate</span><span class="params">(<span class="keyword">final</span> Class&lt;?&gt; declaringClass,</span></span></div><div class="line">                                   String name,</div><div class="line">                                   Class&lt;?&gt;[] parameterTypes,</div><div class="line">                                   Class&lt;?&gt;   returnType,</div><div class="line">                                   Class&lt;?&gt;[] checkedExceptions,</div><div class="line">                                   <span class="keyword">int</span> modifiers,</div><div class="line">                                   <span class="keyword">boolean</span> isConstructor,</div><div class="line">                                   <span class="keyword">boolean</span> forSerialization,</div><div class="line">                                   Class&lt;?&gt; serializationTargetClass)</div><div class="line">&#123;</div><div class="line">    ByteVector vec = ByteVectorFactory.create();</div><div class="line">    asm = <span class="keyword">new</span> ClassFileAssembler(vec);</div><div class="line">    <span class="keyword">this</span>.declaringClass = declaringClass;</div><div class="line">    <span class="keyword">this</span>.parameterTypes = parameterTypes;</div><div class="line">    <span class="keyword">this</span>.returnType = returnType;</div><div class="line">    <span class="keyword">this</span>.modifiers = modifiers;</div><div class="line">    <span class="keyword">this</span>.isConstructor = isConstructor;</div><div class="line">    <span class="keyword">this</span>.forSerialization = forSerialization;</div><div class="line">    asm.emitMagicAndVersion();</div><div class="line">    ...</div><div class="line">    <span class="keyword">final</span> String generatedName = generateName(isConstructor, forSerialization);</div><div class="line">    asm.emitConstantPoolUTF8(generatedName);</div><div class="line">    asm.emitConstantPoolClass(asm.cpi());</div><div class="line">    thisClass = asm.cpi();</div><div class="line">    <span class="keyword">if</span> (isConstructor) &#123;</div><div class="line">        ...</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        asm.emitConstantPoolUTF8(<span class="string">"sun/reflect/MethodAccessorImpl"</span>);</div><div class="line">    &#125;</div><div class="line">    asm.emitConstantPoolClass(asm.cpi());</div><div class="line">    ...</div><div class="line">    targetMethodRef = asm.cpi();</div><div class="line">    <span class="keyword">if</span> (isConstructor) &#123;</div><div class="line">        asm.emitConstantPoolUTF8(<span class="string">"newInstance"</span>);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        asm.emitConstantPoolUTF8(<span class="string">"invoke"</span>);</div><div class="line">    &#125;</div><div class="line">    invokeIdx = asm.cpi();</div><div class="line">    <span class="keyword">if</span> (isConstructor) &#123;</div><div class="line">        asm.emitConstantPoolUTF8(<span class="string">"([Ljava/lang/Object;)Ljava/lang/Object;"</span>);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        asm.emitConstantPoolUTF8</div><div class="line">            (<span class="string">"(Ljava/lang/Object;[Ljava/lang/Object;)Ljava/lang/Object;"</span>);</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">    <span class="keyword">final</span> <span class="keyword">byte</span>[] bytes = vec.getData();</div><div class="line">    <span class="comment">// Note: the class loader is the only thing that really matters</span></div><div class="line">    <span class="comment">// here -- it's important to get the generated code into the</span></div><div class="line">    <span class="comment">// same namespace as the target class. Since the generated code</span></div><div class="line">    <span class="comment">// is privileged anyway, the protection domain probably doesn't</span></div><div class="line">    <span class="comment">// matter.</span></div><div class="line">    <span class="keyword">return</span> AccessController.doPrivileged(</div><div class="line">        <span class="keyword">new</span> PrivilegedAction&lt;MagicAccessorImpl&gt;() &#123;</div><div class="line">            <span class="function"><span class="keyword">public</span> MagicAccessorImpl <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                    <span class="keyword">try</span> &#123;</div><div class="line">                    <span class="keyword">return</span> (MagicAccessorImpl)</div><div class="line">                    ClassDefiner.defineClass</div><div class="line">                            (generatedName,</div><div class="line">                             bytes,</div><div class="line">                             <span class="number">0</span>,</div><div class="line">                             bytes.length,</div><div class="line">                             declaringClass.getClassLoader()).newInstance();</div><div class="line">                    &#125; <span class="keyword">catch</span> (InstantiationException | IllegalAccessException e) &#123;</div><div class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> InternalError(e);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="7-2-GeneratedMethodAccessor1长啥样"><a href="#7-2-GeneratedMethodAccessor1长啥样" class="headerlink" title="7.2 GeneratedMethodAccessor1长啥样"></a>7.2 GeneratedMethodAccessor1长啥样</h3><p>其实不管你是否了解ASM，通过注释可以看出大概这段jvm code是干啥的了，不过有没有办法得到这段字节码呢？记得有个jvm参数可以获取匿名类的字节码，而这里我们也可以通过javaagent方式得到这段字节码的。如下代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomAgent</span> <span class="keyword">implements</span> <span class="title">ClassFileTransformer</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">premain</span><span class="params">(String agentArgs, Instrumentation inst)</span> </span>&#123;</div><div class="line">        inst.addTransformer(<span class="keyword">new</span> CustomAgent());</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">byte</span>[] transform(ClassLoader loader, String className, Class&lt;?&gt; classBeingRedefined,</div><div class="line">            ProtectionDomain protectionDomain, <span class="keyword">byte</span>[] classfileBuffer) <span class="keyword">throws</span> IllegalClassFormatException &#123;</div><div class="line">        <span class="comment">// System.out.println(className);</span></div><div class="line">        <span class="keyword">if</span> (className.indexOf(<span class="string">"GeneratedMethodAccessor"</span>)!= -<span class="number">1</span>) &#123;</div><div class="line">            String fileName = className.substring(className.lastIndexOf(<span class="string">"/"</span>)+<span class="number">1</span>)+<span class="string">".class"</span>;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                Files.write(Paths.get(<span class="string">"/Users/thomaslau/ztemp/java/"</span>, fileName), classfileBuffer);</div><div class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">                e.printStackTrace();</div><div class="line">            &#125;</div><div class="line">            System.out.println(<span class="string">"succed writing"</span> + className);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> classfileBuffer;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Manifest.mf文件指定 Premain-Class: thomas.CustomAgent，之后运行</p>
<pre><code>java -javaagent:/Users/thomaslau/custagent.jar App
</code></pre><p>得到的GeneratedMethodAccessor1.class见<a href="#generatedMethodAccessor1">附录</a>。<br>下面需要用到decompile工具，有的使用jd，不过要注意需要支持到1.8，有些不能正确反编译，所以我使用了<a href="https://github.com/deathmarine/Luyten" target="_blank" rel="external">Luyten+Procyon</a>, 一款Java Decompiler Gui for Procyon，曾经评测得分较高。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> sun.reflect;</div><div class="line"><span class="keyword">import</span> java.lang.reflect.*;</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GeneratedMethodAccessor1</span> <span class="keyword">extends</span> <span class="title">MethodAccessorImpl</span></span></div><div class="line">&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(<span class="keyword">final</span> Object o, <span class="keyword">final</span> Object[] array)</span> <span class="keyword">throws</span> InvocationTargetException </span>&#123;</div><div class="line">        <span class="keyword">if</span> (o == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</div><div class="line">        &#125;</div><div class="line">        X x;</div><div class="line">        String s;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            x = (X)o;</div><div class="line">            <span class="keyword">if</span> (array.length != <span class="number">1</span>) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();</div><div class="line">            &#125;</div><div class="line">            s = (String)array[<span class="number">0</span>];</div><div class="line">            x.hot(s);</div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">catch</span> (ClassCastException | NullPointerException ex) &#123;</div><div class="line">            <span class="keyword">final</span> Object o3;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(o3.toString());</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            x.hot(s);</div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InvocationTargetException(t);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="7-3-MagicAccessorImpl"><a href="#7-3-MagicAccessorImpl" class="headerlink" title="7.3 MagicAccessorImpl"></a>7.3 MagicAccessorImpl</h3><p>最后，generate返回的是MagicAccessorImpl，因为generate这里为ConstructorAccessorImpl和MethodAccessorImpl共用，二者都是MagicAccessorImpl子类，然后再在各自的方法里强制转换一次。 这里package（sun.reflect）属性的MagicAccessorImpl作用是：</p>
<pre><code>is a marker class in the hierarchy. All subclasses of this class are
&quot;magically&quot; granted access by the VM to otherwise inaccessible
fields and methods of other classes. It is used to hold the code
for dynamically-generated FieldAccessorImpl and MethodAccessorImpl
subclasses. (Use of the word &quot;unsafe&quot; was avoided in this class&apos;s
name to avoid confusion with {@link sun.misc.Unsafe}.)
</code></pre><p>这也表明了至少generate底层是支持invoke 到private方法的。<br>    public Object invoke(final Object o, final Object[] array)<br>从这一句我们也可以看到，即便是GeneratedMethodAccessor1，这个Method的对象／参数／返回都退化成了Object，导致需要一些类型check，但这是由外层方法决定的，MethodHandle避免了这类问题。</p>
<h1 id="8-NativeMethodAccessorImpl-invoke0"><a href="#8-NativeMethodAccessorImpl-invoke0" class="headerlink" title="8. NativeMethodAccessorImpl.invoke0"></a>8. NativeMethodAccessorImpl.invoke0</h1><p>最后，让我们看下GeneratedMethodAccessor1之外的选择，invoke0这个native方法，可以从前面的SVG看C代码的调用栈：<br><img src="/images/flamegraph_native.png" width="100%"><br>CPU采样也可以看到X.hot的cpu占比远小于JVM_InvokeMethod<br>从NativeAccessor.c找到jvm.cpp, <a href="http://hg.openjdk.java.net/jdk8/jdk8/hotspot/file/87ee5ee27509/src/share/vm/prims/jvm.cpp#l4010" target="_blank" rel="external">点这里jvm.cpp</a>,让我们大概了解下<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">JVM_ENTRY(jobject, JVM_InvokeMethod(JNIEnv *env, jobject method, jobject obj, jobjectArray args0))</div><div class="line">  JVMWrapper("JVM_InvokeMethod");</div><div class="line">  Handle method_handle;</div><div class="line">  if (thread-&gt;stack_available((address) &amp;method_handle) &gt;= JVMInvokeMethodSlack) &#123;</div><div class="line">    method_handle = Handle(THREAD, JNIHandles::resolve(method));</div><div class="line">    Handle receiver(THREAD, JNIHandles::resolve(obj));</div><div class="line">    objArrayHandle args(THREAD, objArrayOop(JNIHandles::resolve(args0)));</div><div class="line">    oop result = Reflection::invoke_method(method_handle(), receiver, args, CHECK_NULL);</div><div class="line">    jobject res = JNIHandles::make_local(env, result);</div><div class="line">    if (JvmtiExport::should_post_vm_object_alloc()) &#123;</div><div class="line">      oop ret_type = java_lang_reflect_Method::return_type(method_handle());</div><div class="line">      assert(ret_type != NULL, "sanity check: ret_type oop must not be NULL!");</div><div class="line">      if (java_lang_Class::is_primitive(ret_type)) &#123;</div><div class="line">        // Only for primitive type vm allocates memory for java object.</div><div class="line">        // See box() method.</div><div class="line">        JvmtiExport::post_vm_object_alloc(JavaThread::current(), result);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">    return res;</div><div class="line">  &#125; else &#123;</div><div class="line">    THROW_0(vmSymbols::java_lang_StackOverflowError());</div><div class="line">  &#125;</div><div class="line">JVM_END</div></pre></td></tr></table></figure></p>
<p>这里往下就是jvm内部，对JIT的黑盒了. <a href="http://hg.openjdk.java.net/jdk8/jdk8/hotspot/file/87ee5ee27509/src/share/vm/runtime/reflection.cpp#l1117" target="_blank" rel="external">Reflection.cpp</a><br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">// This would be nicer if, say, java.lang.reflect.Method was a subclass</div><div class="line">// of java.lang.reflect.Constructor</div><div class="line"></div><div class="line">oop Reflection::invoke_method(oop method_mirror, Handle receiver, objArrayHandle args, TRAPS) &#123;</div><div class="line">  oop mirror             = java_lang_reflect_Method::clazz(method_mirror);</div><div class="line">  int slot               = java_lang_reflect_Method::slot(method_mirror);</div><div class="line">  bool override          = java_lang_reflect_Method::override(method_mirror) != 0;</div><div class="line">  objArrayHandle ptypes(THREAD, objArrayOop(java_lang_reflect_Method::parameter_types(method_mirror)));</div><div class="line">  oop return_type_mirror = java_lang_reflect_Method::return_type(method_mirror);</div><div class="line">  BasicType rtype;</div><div class="line">  if (java_lang_Class::is_primitive(return_type_mirror)) &#123;</div><div class="line">    rtype = basic_type_mirror_to_basic_type(return_type_mirror, CHECK_NULL);</div><div class="line">  &#125; else &#123;</div><div class="line">    rtype = T_OBJECT;</div><div class="line">  &#125;</div><div class="line">  instanceKlassHandle klass(THREAD, java_lang_Class::as_Klass(mirror));</div><div class="line">  Method* m = klass-&gt;method_with_idnum(slot);</div><div class="line">  if (m == NULL) &#123;</div><div class="line">    THROW_MSG_0(vmSymbols::java_lang_InternalError(), "invoke");</div><div class="line">  &#125;</div><div class="line">  methodHandle method(THREAD, m);</div><div class="line">  return invoke(klass, method, receiver, override, ptypes, rtype, args, true, THREAD);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这里除了invoke_method，还有上文constructor也对应invoke_constructor，后者主要在initialize检查，没有这些参数校验，但最终也是调用invoke方法。<br>如果你留意链接里的火焰图，就会发现NativeMethodAccessorImpl.invoke0顶上的一条比较宽的是JavaCalls::call_helper(JavaValue<em> result, methodHandle</em> m, JavaCallArguments* args, TRAPS)，没错这里就是最终调用java方法的地方了。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> JavaCalls::call_helper(JavaValue* result, methodHandle* m, JavaCallArguments* args, TRAPS) &#123;</div><div class="line">  methodHandle method = *m;</div><div class="line">  JavaThread* thread = (JavaThread*)THREAD;</div><div class="line">  assert(thread-&gt;is_Java_thread(), <span class="string">"must be called by a java thread"</span>);</div><div class="line">  assert(method.not_null(), <span class="string">"must have a method to call"</span>);</div><div class="line">  assert(!SafepointSynchronize::is_at_safepoint(), <span class="string">"call to Java code during VM operation"</span>);</div><div class="line">  assert(!thread-&gt;handle_area()-&gt;no_handle_mark_active(), <span class="string">"cannot call out to Java here"</span>);</div><div class="line">  ...</div><div class="line">  <span class="comment">// do call</span></div><div class="line">  &#123; <span class="function">JavaCallWrapper <span class="title">link</span><span class="params">(method, receiver, result, CHECK)</span></span>;</div><div class="line">    &#123; <span class="function">HandleMark <span class="title">hm</span><span class="params">(thread)</span></span>;  <span class="comment">// HandleMark used by HandleMarkCleaner</span></div><div class="line"></div><div class="line">      StubRoutines::call_stub()(</div><div class="line">        (address)&amp;link,</div><div class="line">        <span class="comment">// (intptr_t*)&amp;(result-&gt;_value), // see NOTE above (compiler problem)</span></div><div class="line">        result_val_address,          <span class="comment">// see NOTE above (compiler problem)</span></div><div class="line">        result_type,</div><div class="line">        method(),</div><div class="line">        entry_point,</div><div class="line">        args-&gt;parameters(),</div><div class="line">        args-&gt;size_of_parameters(),</div><div class="line">        CHECK</div><div class="line">      );</div><div class="line"></div><div class="line">      result = link.result();  <span class="comment">// circumvent MS C++ 5.0 compiler bug (result ...</span></div><div class="line">      &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>reflection.cpp invoke等代码过长，就不贴这里了，感兴趣的可以移步到<a href="http://hg.openjdk.java.net/jdk8/jdk8/hotspot/file/87ee5ee27509/src/share/vm/runtime/reflection.cpp#l901" target="_blank" rel="external">Reflection.cpp#invoke</a></p>
<h1 id="9-其他"><a href="#9-其他" class="headerlink" title="9. 其他"></a>9. 其他</h1><p>有的会通过机器指令验证，如：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;</span><span class="bash">java -server -Dsun.reflect.inflationThreshold=180000000 -XX:+UnlockDiagnosticVMOptions -XX:+PrintAssembly -XX:+PrintCompilation <span class="string">'-XX:CompileCommand=compileonly sun/reflect/NativeMethodAccessorImpl.invoke'</span> App &gt; pure_native_infla18M.txt</span></div><div class="line">Java HotSpot(TM) 64-Bit Server VM warning: PrintAssembly is enabled; turning on DebugNonSafepoints to gain additional output</div><div class="line"><span class="meta">&gt;</span><span class="bash">java -server -Dsun.reflect.inflationThreshold=1 -XX:+UnlockDiagnosticVMOptions -XX:+PrintAssembly -XX:+PrintCompilation <span class="string">'-XX:CompileCommand=compileonly sun/reflect/GeneratedMethodAccessor1.invoke'</span> App &gt; pure_generate_infla1.txt</span></div></pre></td></tr></table></figure></p>
<p>上面确实可以看到各种inflationThreshold情况下起作用的是GeneratedMethodAccessor1还是NativeMethodAccessorImpl，不过再看就是看到一些callq指令了，性能分析需要引入其他工具。</p>
<h1 id="10-附录"><a href="#10-附录" class="headerlink" title="10. 附录"></a>10. 附录</h1><p><strong>1, <span id="hello">CallerSensitive其实就是实现</span></strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Returns the class of the caller of the method calling this method, ignoring frames </div><div class="line">associated with java.lang.reflect.Method.invoke() and its implementation</div></pre></td></tr></table></figure></p>
<p>的功能，这是一个由大神<a href="https://twitter.com/briangoetz" target="_blank" rel="external">Brian Goetz</a>于1.8提出的<a href="http://openjdk.java.net/jeps/176" target="_blank" rel="external">JEP-176</a>，StackOverFlow<a href="https://stackoverflow.com/questions/22626808/what-does-the-sun-reflect-callersensitive-annotation-mean" target="_blank" rel="external">里讲的比较概括些</a>，CallerSensitive<a href="http://hg.openjdk.java.net/jdk8/jdk8/jdk/file/687fd7c7986d/src/share/classes/sun/reflect/CallerSensitive.java" target="_blank" rel="external">的源码链接</a><br><strong>2, isVMAnonymousClass</strong><br>见 <a href="http://hg.openjdk.java.net/jdk8/jdk8/jdk/file/687fd7c7986d/src/share/classes/sun/reflect/misc/ReflectUtil.java" target="_blank" rel="external">ReflectUtil</a><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Checks if &#123;<span class="doctag">@code</span> Class cls&#125; is a VM-anonymous class</div><div class="line"> * as defined by &#123;<span class="doctag">@link</span> sun.misc.Unsafe#defineAnonymousClass&#125;</div><div class="line"> * (not to be confused with a Java Language anonymous inner class).</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isVMAnonymousClass</span><span class="params">(Class&lt;?&gt; cls)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> cls.getName().indexOf(<span class="string">"/"</span>) &gt; -<span class="number">1</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>什么是VM-anonymous class？<a href="https://jcp.org/en/jsr/detail?id=292" target="_blank" rel="external">JSR292</a>的领导者，亦即为JAVA(java7)引入了动态类型语言支持的<a href="https://blogs.oracle.com/jrose/anonymous-classes-in-the-vm" target="_blank" rel="external">John Rose在其Anonymous classes in the VM</a>里面有详述，这是一类独立于class loader、system dictionary的而寄生在hostclass的匿名类（但不是必须），这解决了许多基于JVM的动态语言的问题，<a href="http://openjdk.java.net/projects/mlvm" target="_blank" rel="external">OpenJDK Multi-Language VM project</a><br>定义在<a href="http://hg.openjdk.java.net/jdk8/jdk8/jdk/file/687fd7c7986d/src/share/classes/sun/misc/Unsafe.java" target="_blank" rel="external">Unsafe</a>的一个native实现，具体实现在Unsafe.cpp,<a href="http://hg.openjdk.java.net/jdk8u/jdk8u/hotspot/file/c82d1a19ffb5/src/share/vm/prims/unsafe.cpp#l1132" target="_blank" rel="external">源码点击此处</a><strong>TODO！！</strong>.<br>John Rose贡献了MethodHandles等实现，比如常用于JRuby／Jython等语言的invokedynamic指令，即<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Add a new bytecode, invokedynamic, that supports efficient and flexible </div><div class="line">execution of method invocations in the absence of static type information.</div></pre></td></tr></table></figure></p>
<p>事实上，JSR292最初分为三部分，AnonymousClassLoader、MethodHandle(s)和invokedynamic, 1.7主要用AnonymousClass来实现动态语言支持，1.8之后则提供了invokedynamic使用，目前看应该是二者混用的，不过<a href="http://www.javaworld.com/article/2072319/core-java/a-first-taste-of-invokedynamic.html?page=2" target="_blank" rel="external">AnonymousClassLoader</a>在1.7声称因非标准API会被废弃掉，目前依旧是<a href="http://bugs.java.com/view_bug.do?bug_id=6990182" target="_blank" rel="external">声明状态</a>, 因为1.8的lambda实现中LambdaMetaFactory正是通过Unsafe.defineAnonymousClass将ASM生成的class插入到original 即host class。<br>Nashorn项目也在用它<a href="https://bugs.openjdk.java.net/browse/JDK-8135251" target="_blank" rel="external">loading Nashorn script code</a>, 至少截止20170725是如此。<br>invokedynamic于1.7引入，但实际上1.8时javac才支持的。<br>具体目前还未看透，后面可能会再写文章再深入探讨。<br><strong>3，VM-anonymous class与匿名类（anonymous class）的区别？</strong><br>最大的区别是，匿名类经过javac之后是一个有名字(XX.$1)的正常的java class，前者不是，可见上文所述。<br><strong>4，<a href="https://www.slideshare.net/CharlesNutter/invokedynamic-in-45-minutes" target="_blank" rel="external">invokeDynamic</a></strong><br>Java语言架构师Brian Goetz也在JSR 335提到jAVA Lambda实现<a href="http://cr.openjdk.java.net/~briangoetz/lambda/lambda-translation.html" target="_blank" rel="external">Translation of Lambda Expressions</a>…确实太多了，而Reflection与MethodHandle／dynamic区别，简单来讲可以认为Reflection像是java代码层次，MethodHandle是jvm层次，前者局限于java，后者则适用基于JVM的语言。1.8中InvokeDynamic用于lambda对象的创建，实际调用方法还是invokevirtual/inter../speci.., 可以看看<a href="https://wiki.openjdk.java.net/display/HotSpot/Method+handles+and+invokedynamic" target="_blank" rel="external">MethodHandles and Invokedynamic</a>, <a href="http://www.javaworld.com/article/2860079/learn-java/invokedynamic-101.html?page=2" target="_blank" rel="external">Invokedynamic-101</a>,  <a href="https://www.infoq.com/articles/Invokedynamic-Javas-secret-weapon" target="_blank" rel="external">Invokedynamic-Javas-secret-weapon</a>, 或周志明f写的infoq的文章 <a href="http://www.infoq.com/cn/articles/jdk-dynamically-typed-language" target="_blank" rel="external">解析JDK 7的动态类型语言支持</a>, blog签名有趣的JRuby专家<a href="http://blog.headius.com/2008/09/first-taste-of-invokedynamic.html" target="_blank" rel="external">first-taste-of-invokedynamic</a>, Oracle一篇tech note<a href="http://docs.oracle.com/javase/8/docs/technotes/guides/vm/multiple-language-support.html" target="_blank" rel="external">Java Virtual Machine Support for Non-Java Languages</a>, <a href="http://blog.takipi.com/compiling-lambda-expressions-scala-vs-java-8/" target="_blank" rel="external">compiling-lambda-expressions-scala-vs-java-8</a>，有趣的perl6贡献者的<a href="http://jnthn.net/papers/2013-bs-invoke-dynamic.pdf" target="_blank" rel="external">Using invoke dynamic to teach the JVM a new language </a>这些文章有内容过时但值得一看.<br><strong>具体实现如何，可能需要再写文章探讨</strong>。<br><strong>5，关于JNI调用耗时</strong><br>推荐看看<a href="https://stackoverflow.com/questions/7699020/what-makes-jni-calls-slow" target="_blank" rel="external">what-makes-jni-calls-slow</a>, 其实“慢”，这么说没有意义，要看怎么比，要看具体逻辑。<br>而实际上，使用jni实现和java原生实现相比，理论上导致差距的地方有，因为jni像个黑盒不会內联不会jit优化，crossing boundaries问题，JAVA和native之间交换数据可能需要拷贝（java访问jni的返回／jni访问java对象）<br><a href="https://www.slideshare.net/RednaxelaFX/green-teajug-hotspotintrinsics02232013" target="_blank" rel="external">R神的hotspot intrinsics API</a><br><strong>6，privateGetMethodRecursive</strong><br><a href="http://hg.openjdk.java.net/jdk8/jdk8/jdk/file/687fd7c7986d/src/share/classes/java/lang/Class.java" target="_blank" rel="external">代码可见Class.java的privateGetMethodRecursive实现</a>, 如果你仔细看了clazz.newInsstance这块，会发现有 <a href="http://hg.openjdk.java.net/jdk8/jdk8/jdk/file/687fd7c7986d/src/share/classes/java/lang/Class.java#l2464" target="_blank" rel="external">ReflectionData</a><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ReflectionData</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line">    <span class="keyword">volatile</span> Field[] declaredFields;</div><div class="line">    <span class="keyword">volatile</span> Field[] publicFields;</div><div class="line">    <span class="keyword">volatile</span> Method[] declaredMethods;</div><div class="line">    <span class="keyword">volatile</span> Method[] publicMethods;</div><div class="line">    <span class="keyword">volatile</span> Constructor&lt;T&gt;[] declaredConstructors;</div><div class="line">    <span class="keyword">volatile</span> Constructor&lt;T&gt;[] publicConstructors;</div><div class="line">    <span class="comment">// Intermediate results for getFields and getMethods</span></div><div class="line">    <span class="keyword">volatile</span> Field[] declaredPublicFields;</div><div class="line">    <span class="keyword">volatile</span> Method[] declaredPublicMethods;</div><div class="line">    <span class="keyword">volatile</span> Class&lt;?&gt;[] interfaces;</div><div class="line">    <span class="comment">// Value of classRedefinedCount when we created this ReflectionData instance</span></div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> redefinedCount;</div><div class="line">    ReflectionData(<span class="keyword">int</span> redefinedCount) &#123;</div><div class="line">        <span class="keyword">this</span>.redefinedCount = redefinedCount;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这里面有 Constructor，在newReflectionData，newInstance都是可关注的地方，这里Constructor的构建，其实也是类似本文Method的逻辑，通过ReflectionFactory.newConstructorAccessor提供了一个基于native的NativeConstructorAccessorImpl实现，而另一个就是同样的基于asm bytecode的MethodAccessorGenerator().generateConstructor实现，但是有一个例外，当。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Bootstrapping issue: since we use Class.newInstance() in</span></div><div class="line"><span class="comment">// the ConstructorAccessor generation process, we have to</span></div><div class="line"><span class="comment">// break the cycle here.</span></div><div class="line"><span class="keyword">if</span> (Reflection.isSubclassOf(declaringClass,</div><div class="line">                            ConstructorAccessorImpl.class)) &#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> BootstrapConstructorAccessorImpl(c);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>满足上述条件时，返回的是BootstrapConstructorAccessorImpl，而它然后就直接通过 UnsafeFieldAccessorImpl.unsafe.allocateInstance(constructor.getDeclaringClass())来newInstance的。<br><strong>7, <span id="generatedMethodAccessor1">GeneratedMethodAccessor1.class</span></strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line">public java.lang.Object invoke(java.lang.Object, java.lang.Object[]) throws java.lang.reflect.InvocationTargetException;</div><div class="line">  descriptor: (Ljava/lang/Object;[Ljava/lang/Object;)Ljava/lang/Object;</div><div class="line">  flags: ACC_PUBLIC</div><div class="line">  Code:</div><div class="line">    stack=5, locals=3, args_size=3</div><div class="line">       0: aload_1</div><div class="line">       1: ifnonnull     12</div><div class="line">       4: new           #20                 // class java/lang/NullPointerException</div><div class="line">       7: dup</div><div class="line">       8: invokespecial #28                 // Method java/lang/NullPointerException.&quot;&lt;init&gt;&quot;:()V</div><div class="line">      11: athrow</div><div class="line">      12: aload_1</div><div class="line">      13: checkcast     #6                  // class X</div><div class="line">      16: aload_2</div><div class="line">      17: arraylength</div><div class="line">      18: sipush        1</div><div class="line">      21: if_icmpeq     32</div><div class="line">      24: new           #22                 // class java/lang/IllegalArgumentException</div><div class="line">      27: dup</div><div class="line">      28: invokespecial #29                 // Method java/lang/IllegalArgumentException.&quot;&lt;init&gt;&quot;:()V</div><div class="line">      31: athrow</div><div class="line">      32: aload_2</div><div class="line">      33: sipush        0</div><div class="line">      36: aaload</div><div class="line">      37: checkcast     #14                 // class java/lang/String</div><div class="line">      40: invokevirtual #10                 // Method X.hot:(Ljava/lang/String;)V</div><div class="line">      43: aconst_null</div><div class="line">      44: areturn</div><div class="line">      45: invokespecial #42                 // Method java/lang/Object.toString:()Ljava/lang/String;</div><div class="line">      48: new           #22                 // class java/lang/IllegalArgumentException</div><div class="line">      51: dup_x1</div><div class="line">      52: swap</div><div class="line">      53: invokespecial #32                 // Method java/lang/IllegalArgumentException.&quot;&lt;init&gt;&quot;:(Ljava/lang/String;)V</div><div class="line">      56: athrow</div><div class="line">      57: new           #24                 // class java/lang/reflect/InvocationTargetException</div><div class="line">      60: dup_x1</div><div class="line">      61: swap</div><div class="line">      62: invokespecial #35                 // Method java/lang/reflect/InvocationTargetException.&quot;&lt;init&gt;&quot;:(Ljava/lang/Throwable;)V</div><div class="line">      65: athrow</div></pre></td></tr></table></figure></p>
<p><strong>8，</strong> JAVA StackTrace方法的性能可以参考 stackoverflow的一个问答<a href="https://stackoverflow.com/questions/421280/how-do-i-find-the-caller-of-a-method-using-stacktrace-or-reflection" target="_blank" rel="external">how-do-i-find-the-caller-of-a-method-using-stacktrace-or-reflection</a></p>
<h1 id="11-引用"><a href="#11-引用" class="headerlink" title="11. 引用"></a>11. 引用</h1><ol>
<li><a href="http://rednaxelafx.iteye.com/blog/548536" target="_blank" rel="external">关于反射调用方法的一个log</a>, <strong>RednaxelaFX</strong>, 也就是国内已知公认JVM专家R大，也即许多ppt作者为 莫枢得，写过一篇文章讨论了这个问题</li>
<li>关于Java Flame，这里列出几篇参考文章：<ul>
<li>2.1<br>Brendan Gregg大牛写过 使用google 的<a href="http://www.brendangregg.com/blog/2014-06-12/java-flame-graphs.html" target="_blank" rel="external">Lightweight Java Profiler</a>结合其<a href="https://github.com/brendangregg/FlameGraph" target="_blank" rel="external">火焰图工具FlameGraph</a>如何制作java火焰图的文章，比如里面也可以使用 Richard Warburton开发的<a href="https://github.com/RichardWarburton/honest-profiler" target="_blank" rel="external">honest-profiler</a>来采样。</li>
<li>2.2<br>Brendan Gregg在后来的文章里更新了使用Linux perf_events来一起显示Java和系统代码<a href="http://www.brendangregg.com/FlameGraphs/cpuflamegraphs.html#Java" target="_blank" rel="external">cpuflamegraphs</a>，<a href="https://medium.com/netflix-techblog/java-in-flames-e763b3d32166" target="_blank" rel="external">netflix java-in-flames</a>, 不过有一种适用旧版本不影响性能的<a href="https://github.com/jvm-profiling-tools/async-profiler" target="_blank" rel="external">基于AsyncGetCallTrace + perf_events的采样方式</a>, 但 AsyncGetCallTrace is not an official API to the JVM。</li>
<li>2.3<br>有人使用hprof作cpu采样，但是 正如2.1 java-flame-graphs提到的 <a href="http://www.brendangregg.com/blog/2014-06-09/java-cpu-sampling-using-hprof.html" target="_blank" rel="external">这篇文章</a> 做了指正。</li>
<li>2.4<br>有最新的一篇文章介绍了 <a href="http://www.brendangregg.com/blog/2017-06-30/package-flame-graph.html" target="_blank" rel="external">Java Package Flame Graph</a>并引出了<a href="http://www.brendangregg.com/FlameGraphs/cpuflamegraphs.html#Java" target="_blank" rel="external">CPU Flame Graphs</a></li>
<li>2.5<br>上述在<a href="http://www.brendangregg.com/flamegraphs.html#Updates" target="_blank" rel="external">updates</a>都可以找到, Brendan Gregg的flamegraphs更新页面，几乎记录了优质的跟flamegraphs有关的链接。</li>
</ul>
</li>
<li><a href="http://www.brendangregg.com/linuxperf.html" target="_blank" rel="external">Brendan Gregg的站点，记录了些高效的Linux性能工具</a></li>
<li>两篇不错的文章 <a href="http://psy-lob-saw.blogspot.co.za/2017/02/flamegraphs-intro-fire-for-everyone.html" target="_blank" rel="external">flamegraphs-intro-fire-for-everyone</a>,<a href="http://psy-lob-saw.blogspot.co.za/2016/06/the-pros-and-cons-of-agct.html" target="_blank" rel="external">The Pros and Cons of AsyncGetCallTrace Profilers</a></li>
<li>几个常用参考页面：<br>Oracle官方的 <a href="http://www.oracle.com/technetwork/articles/java/vmoptions-jsp-140102.html" target="_blank" rel="external">Java HotSpot VM Options</a>, <a href="http://www.cnblogs.com/redcreen/archive/2011/05/04/2037057.html" target="_blank" rel="external">VM参数中文版，有些已过期</a><br>Oracle官方的 <a href="http://docs.oracle.com/javase/8/docs/technotes/tools/windows/java.html" target="_blank" rel="external">JAVA Options</a>，R大的 <a href="http://hllvm.group.iteye.com/group/topic/27945" target="_blank" rel="external">JVM调优的”标准参数”的各种陷阱]</a>,可以参考HotSpot VM里的各个globals.hpp文件</li>
</ol>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/JVM/" rel="tag"># JVM</a>
          
            <a href="/tags/Java/" rel="tag"># Java</a>
          
            <a href="/tags/JAVA-Flame-Graph/" rel="tag"># JAVA Flame Graph</a>
          
            <a href="/tags/JMH/" rel="tag"># JMH</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/06/19/2017-06-19-from_Monte_Carlo_to_pySpark_fork_Bug/" rel="next" title="从Monte Carlo谈pySpark的fork引发的Bug">
                <i class="fa fa-chevron-left"></i> 从Monte Carlo谈pySpark的fork引发的Bug
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/07/31/2017-07-31-Blogs_2017_07_31/" rel="prev" title="Blogs_20170731">
                Blogs_20170731 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/myLogo.png"
               alt="Thomas Lau" />
          <p class="site-author-name" itemprop="name">Thomas Lau</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">60</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              
                <span class="site-state-item-count">62</span>
                <span class="site-state-item-name">标签</span>
              
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/ThomasLau" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://twitter.com/liuyongzhi0218" target="_blank" title="Twitter">
                  
                    <i class="fa fa-fw fa-twitter"></i>
                  
                  Twitter
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#1-缘起"><span class="nav-number">1.</span> <span class="nav-text">1. 缘起</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-复现"><span class="nav-number">2.</span> <span class="nav-text">2. 复现</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#3-Class-getMethod"><span class="nav-number">3.</span> <span class="nav-text">3. Class.getMethod</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#4-MethodAccessor-vs-ReflectionFactory"><span class="nav-number">4.</span> <span class="nav-text">4. MethodAccessor vs ReflectionFactory</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-noInflation"><span class="nav-number">4.0.1.</span> <span class="nav-text">4.1 noInflation</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-NativeMethodAccessorImpl"><span class="nav-number">4.0.2.</span> <span class="nav-text">4.2 NativeMethodAccessorImpl</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-NativeMethodAccessorImpl-invoke0"><span class="nav-number">4.0.3.</span> <span class="nav-text">4.3 NativeMethodAccessorImpl.invoke0</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#5-JMH-BenchMark"><span class="nav-number">5.</span> <span class="nav-text">5. JMH BenchMark</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-1-JMH对比结果"><span class="nav-number">5.0.1.</span> <span class="nav-text">5.1 JMH对比结果</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2-JMH-BenchMark代码"><span class="nav-number">5.0.2.</span> <span class="nav-text">5.2 JMH BenchMark代码</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#6-JAVA-Flame-Graph"><span class="nav-number">6.</span> <span class="nav-text">6. JAVA Flame Graph</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#7-GeneratedMethodAccessor1是什么？"><span class="nav-number">7.</span> <span class="nav-text">7. GeneratedMethodAccessor1是什么？</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#7-1-GeneratedMethodAccessor1的生成"><span class="nav-number">7.0.1.</span> <span class="nav-text">7.1 GeneratedMethodAccessor1的生成</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-2-GeneratedMethodAccessor1长啥样"><span class="nav-number">7.0.2.</span> <span class="nav-text">7.2 GeneratedMethodAccessor1长啥样</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-3-MagicAccessorImpl"><span class="nav-number">7.0.3.</span> <span class="nav-text">7.3 MagicAccessorImpl</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#8-NativeMethodAccessorImpl-invoke0"><span class="nav-number">8.</span> <span class="nav-text">8. NativeMethodAccessorImpl.invoke0</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#9-其他"><span class="nav-number">9.</span> <span class="nav-text">9. 其他</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#10-附录"><span class="nav-number">10.</span> <span class="nav-text">10. 附录</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#11-引用"><span class="nav-number">11.</span> <span class="nav-text">11. 引用</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Thomas Lau</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  




	





  





  





  






  





  

  

  

  
  


  

  

</body>
</html>
